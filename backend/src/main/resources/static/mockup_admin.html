<!doctype html>
<html lang="es">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sistema GestiÃ³n de Desastres Naturales â€” ADMIN</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  

  <style>
    body {
      background: #f8f9fa;
    }

    /* El ID #map ya no se usa, pero #map-crear-ubicacion sÃ­ */
    #map-crear-ubicacion {
      height: 700px;
    }


    .sidebar {
      max-height: 85vh;
      overflow-y: auto;
    }

    .tab-section {
      display: none;
    }

    .tab-section.active {
      display: block;
    }

    .small-muted {
      font-size: 0.85rem;
      color: #6c757d;
    }

    .card-map {
      height: 100%;
    }

    .badge-risk-low {
      background: #198754;
    }

    .badge-risk-medium {
      background: #ffc107;
      color: #000;
    }

    .badge-risk-high {
      background: #dc3545;
    }
  </style>
</head>

<body>
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">SGD - GestiÃ³n Desastres (Admin)</a>

      <div class="d-flex align-items-center">
        <span id="wsStatus" class="badge bg-secondary me-2">WS: desconectado</span>

        <span id="currentUser" class="text-light small me-3"></span>

        <button class="btn btn-outline-light btn-sm me-2" id="btn-refresh">Refrescar datos</button>

        <div class="dropdown">
          <a class="btn btn-outline-light dropdown-toggle" data-bs-toggle="dropdown" href="#" role="button"
            aria-expanded="false">
            <i class="fa fa-user"></i> Cuenta
          </a>
          <ul class="dropdown-menu dropdown-menu-end">
            <li><a class="dropdown-item" href="#" id="menu-logout">Cerrar sesiÃ³n</a></li>
          </ul>
        </div>
      </div>
    </div>
  </nav>

  <div class="container-fluid mt-3">
    <div class="row">

      <aside class="col-md-3">
        <div class="card sidebar p-2">
          <h5 class="mb-2">MenÃº</h5>
          <div class="list-group">
            <a href="#" class="list-group-item list-group-item-action active" data-tab="inicio">Inicio</a>
            <a href="#" class="list-group-item list-group-item-action" data-tab="panel-admin">Panel AdministraciÃ³n</a>
            <a href="#" class="list-group-item list-group-item-action" data-tab="crear-ubicacion">Crear UbicaciÃ³n</a>
            <a href="#" class="list-group-item list-group-item-action" data-tab="crear-ruta">Crear Ruta</a>
            <a href="#" class="list-group-item list-group-item-action" data-tab="panel-reportes">Reportes</a>
            
            <a href="#" class="list-group-item list-group-item-action text-danger" id="menu-exit">
              Salir (apagar demo)
            </a>
          </div>

          <hr>
          <h6 class="mt-2">Conexiones</h6>
          <p class="small-muted">Backend: <span id="backendUrl">http://localhost:8081/api</span></p>
          <p class="small-muted">WebSocket: <span id="wsUrl">ws://localhost:8081/ws</span></p>
        </div>
      </aside>

      <main class="col-md-9">
        <section id="inicio" class="tab-section active">
          <div class="row g-3">
            <div class="col-lg-8">
              <div class="card card-map p-3">
                <h5>Vista general</h5>
                <p class="small-muted mb-2">Resumen de zonas afectadas y recursos disponibles.</p>

                <div class="row mb-3">
                  <div class="col-sm-4">
                    <div class="card p-2">
                      <h6>Zonas crÃ­ticas</h6>
                      <p id="countCritical" class="display-6 m-0">0</p>
                    </div>
                  </div>
                  <div class="col-sm-4">
                    <div class="card p-2">
                      <h6>Personas afectadas</h6>
                      <p id="totalEvacuated" class="display-6 m-0">0</p>
                    </div>
                  </div>
                  <div class="col-sm-4">
                    <div class="card p-2">
                      <h6>Recursos en almacÃ©n</h6>
                      <p id="totalResources" class="display-6 m-0">0</p>
                    </div>
                  </div>
                </div>

                <div>
                  <h6>Zonas afectadas</h6>
                  <div class="table-responsive">
                    <table class="table table-striped table-sm" id="tabla-zonas">
                      <thead>
                        <tr>
                          <th>Zona</th>
                          <th>Tipo</th>
                          <th>Riesgo</th>
                          <th>Personas</th>
                          <th>Recursos Necesarios</th>
                          <th>Ãšltima actualizaciÃ³n</th>
                          <th>Acciones</th>
                        </tr>
                      </thead>
                      <tbody>
                        </tbody>
                    </table>
                  </div>
                </div>

              </div>
            </div>

            <div class="col-lg-4">
              <div class="card p-2 mb-3">
                <h6>Actividad reciente</h6>
                <ul id="logActivity" class="list-group list-group-flush small" style="max-height:280px; overflow:auto;">
                  </ul>
              </div>

              <div class="card p-2">
                <h6>Filtros rÃ¡pidos</h6>
                <div class="mb-2">
                  <label class="form-label">Nivel de riesgo</label>
                  <select id="filterRisk" class="form-select form-select-sm">
                    <option value="">Todos</option>
                    <option value="BAJO">Bajo</option>
                    <option value="MEDIO">Medio</option>
                    <option value="ALTO">Alto</option>
                    <option value="CRITICO">CrÃ­tico</option>
                  </select>
                </div>
                <button class="btn btn-primary btn-sm w-100" id="btn-apply-filters">Aplicar</button>
              </div>
            </div>

          </div>
        </section>

        <section id="panel-admin" class="tab-section">
          <div class="card p-3">
            <h5>Panel de AdministraciÃ³n</h5>
            <p class="small-muted">Crear/editar recursos, asignar a zonas, gestionar equipos de rescate.</p>

            <div class="row g-3">
              <div class="col-md-6">
                <h6>Crear Recurso</h6>
                <form id="form-create-resource">
                  <div class="mb-2">
                    <label class="form-label">Nombre</label>
                    <input required id="r_nombre" class="form-control form-control-sm" />
                  </div>
                  <div class="mb-2">
                    <label class="form-label">Tipo</label>
                    <select id="r_tipo" class="form-select form-select-sm">
                      <option value="ALIMENTO">Alimento</option>
                      <option value="MEDICINA">Medicina</option>
                      <option value="EQUIPO_RESCATE">Equipo rescate</option>
                      <option value="AGUA">Agua</option>
                      <option value="COMBUSTIBLE">Combustible</option>
                    </select>
                  </div>
                  <div class="mb-2">
                    <label class="form-label">Cantidad</label>
                    <input id="r_cantidad" type="number" class="form-control form-control-sm" value="1" />
                  </div>
                  <div class="d-grid">
                    <button class="btn btn-success btn-sm" type="submit">Crear Recurso</button>
                  </div>
                </form>
              </div>

              <div class="col-md-6">
                <h6>Equipos de Rescate</h6>
                <form id="form-create-team">
                  <div class="mb-2">
                    <label class="form-label">Nombre</label>
                    <input id="e_nombre" class="form-control form-control-sm" />
                  </div>
                  <div class="mb-2">
                    <label class="form-label">Tipo</label>
                    <select id="e_tipo" class="form-select form-select-sm">
                      <option value="BOMBEROS">Bomberos</option>
                      <option value="MEDICOS">MÃ©dicos</option>
                      <option value="POLICIA">PolicÃ­a</option>
                      <option value="VOLUNTARIOS">Voluntarios</option>
                    </select>
                  </div>
                  <div class="mb-2">
                    <label class="form-label">Miembros</label>
                    <input id="e_miembros" type="number" value="5" class="form-control form-control-sm" />
                  </div>
                  <div class="d-grid">
                    <button class="btn btn-primary btn-sm" id="btn-create-team" type="button">Crear Equipo</button>
                  </div>
                </form>
                
                <hr>

                <h6 class="mt-3">Listado de Equipos</h6>
                <div class="table-responsive">
                  <table class="table table-sm" id="tabla-equipos">
                    <thead>
                      <tr>
                        <th>ID</th>
                        <th>Tipo</th>
                        <th>Miembros</th>
                        <th>Estado</th>
                      </tr>
                    </thead>
                    <tbody></tbody>
                  </table>
                </div>
              </div>
            </div>

            <hr>

            <h6 class="d-none">Registrar UbicaciÃ³n</h6>
            <form id="form-create-ubicacion" class="row g-2 d-none">
              <div class="col-md-4">
                <label class="form-label">Nombre</label>
                <input id="u_nombre" required class="form-control form-control-sm" placeholder="Ej: Zona Norte" />
              </div>
              <div class="col-md-4">
                <label class="form-label">Tipo</label>
                <select id="u_tipo" class="form-select form-select-sm">
                  <option value="URBANA">Urbana</option>
                  <option value="RURAL">Rural</option>
                </select>
              </div>
              <div class="col-md-2">
                <label class="form-label">Lat</label>
                <input id="u_lat" type="number" step="0.0001" class="form-control form-control-sm" placeholder="4.65" />
              </div>
              <div class="col-md-2">
                <label class="form-label">Lng</label>
                <input id="u_lng" type="number" step="0.0001" class="form-control form-control-sm" placeholder="-74.05" />
              </div>
              <div class="col-md-4">
                          <label class="form-label">Nivel de Riesgo</label>
                          <select id="u_nivelRiesgo" class="form-select form-select-sm">
                            <option value="BAJO">Bajo</option>
                            <option value="MEDIO">Medio</option>
                            <option value="ALTO">Alto</option>
                            <option value="CRITICO">CrÃ­tico</option>
                          </select>
                        </div>

                        <div class="col-md-4">
                          <label class="form-label">Personas afectadas</label>
                          <input id="u_personasAfectadas" type="number" min="0" value="0" class="form-control form-control-sm" />
                        </div>

                        <div class="col-12 d-grid">
                          <button class="btn btn-success btn-sm mt-2" type="submit">Crear UbicaciÃ³n</button>
                        </div>
            </form>

            <hr>

            <h6 class="mt-3">Listado de Recursos</h6>
            <div class="table-responsive">
              <table class="table table-sm" id="tabla-recursos">
                <thead>
                          <tr>
                            <th>Nombre</th>
                            <th>Tipo</th>
                            <th>Cantidad</th>
                            <th>Disponibilidad</th>
                          </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>

            <h6 class="mt-3">Listado de Ubicaciones</h6>
            <div class="table-responsive">
              <table class="table table-sm" id="tabla-ubicaciones">
                <thead>
                  <tr>
                    <th>Nombre</th>
                    <th>Tipo</th>
                    <th>Longitud</th>
                    <th>Latitud</th>
                    <th>Nivel de Riesgo</th>
                    <th>Acciones</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>

          </div>
        </section>

        <section id="crear-ubicacion" class="tab-section">

  <h4 class="mb-3">Crear UbicaciÃ³n</h4>
  <p class="text-muted">Haz clic en el mapa para seleccionar las coordenadas.</p>

  <div class="row g-2 mb-3">
    <div class="col-md-4">
      <label class="form-label">Nombre</label>
      <input id="cu_nombre" class="form-control form-control-sm" placeholder="Ej: Punto Seguro" />
    </div>

    <div class="col-md-4">
      <label class="form-label">Tipo</label>
      <select id="cu_tipo" class="form-select form-select-sm">
        <option value="URBANA">Urbana</option>
        <option value="RURAL">Rural</option>
      </select>
    </div>

    <div class="col-md-2">
      <label class="form-label">Latitud</label>
      <input id="cu_lat" class="form-control form-control-sm" readonly />
    </div>

    <div class="col-md-2">
      <label class="form-label">Longitud</label>
      <input id="cu_lng" class="form-control form-control-sm" readonly />
    </div>

    <div class="col-md-4 mt-2">
      <label class="form-label">Nivel de Riesgo</label>
      <select id="cu_riesgo" class="form-select form-select-sm">
        <option value="BAJO">Bajo</option>
        <option value="MEDIO">Medio</option>
        <option value="ALTO">Alto</option>
        <option value="CRITICO">CrÃ­tico</option>
      </select>
    </div>

    <div class="col-md-4 mt-2">
      <label class="form-label">Personas afectadas</label>
      <input id="cu_personasAfectadas" type="number" min="0" value="0" class="form-control form-control-sm" />
    </div>

    <div class="col-md-12 mt-2">
      <div id="map-crear-ubicacion"></div>
    </div>

    <div class="col-12 d-grid mt-3">
      <button class="btn btn-primary btn-sm" id="cu_guardar">Guardar UbicaciÃ³n</button>
    </div>
  </div>

</section>

<section id="crear-ruta" class="tab-section">

  <h4 class="mb-3">Crear Ruta</h4>
  <p class="text-muted">Selecciona dos puntos en el mapa para trazar la ruta.</p>

  <div class="row g-2 mb-3">

    <div class="col-12">
      <div id="map-crear-ruta" style="height:700px; border-radius:8px;"></div>
    </div>

    <div class="col-md-6 d-grid mt-3">
      <button class="btn btn-danger btn-sm" id="cr_limpiar">Limpiar selecciÃ³n</button>
    </div>

    <div class="col-md-6 d-grid mt-3">
      <button class="btn btn-success btn-sm" id="cr_guardar">Guardar Ruta</button>
    </div>

  </div>

</section>

        <section id="panel-reportes" class="tab-section">
          <div class="card p-3">
            <h5>Panel de Reportes</h5>
            <p class="small-muted">Resumen de datos globales del sistema.</p>
            <div id="reporte-datos" class="row g-3">
              <div class="col-md-4">
                <div class="card p-2 mb-2">
                  <h6>Total de Zonas</h6>
                  <p id="rep_totalZonas" class="display-6 m-0">-</p>
                </div>
              </div>
              <div class="col-md-4">
                <div class="card p-2 mb-2">
                  <h6>Personas Afectadas</h6>
                  <p id="rep_personasAfectadas" class="display-6 m-0">-</p>
                </div>
              </div>
              <div class="col-md-4">
                <div class="card p-2 mb-2">
                  <h6>Total Recursos</h6>
                  <p id="rep_totalRecursos" class="display-6 m-0">-</p>
                </div>
              </div>
              <div class="col-md-4">
                <div class="card p-2 mb-2">
                  <h6>Recursos Asignados</h6>
                  <p id="rep_recursosAsignados" class="display-6 m-0">-</p>
                </div>
              </div>
              <div class="col-md-4">
                <div class="card p-2 mb-2">
                  <h6>Recursos Disponibles</h6>
                  <p id="rep_recursosDisponibles" class="display-6 m-0">-</p>
                </div>
              </div>
              <div class="col-md-4">
                <div class="card p-2 mb-2">
                  <h6>Equipos Totales</h6>
                  <p id="rep_equiposTotales" class="display-6 m-0">-</p>
                </div>
              </div>
              <div class="col-md-4">
                <div class="card p-2 mb-2">
                  <h6>Equipos en MisiÃ³n</h6>
                  <p id="rep_equiposEnMision" class="display-6 m-0">-</p>
                </div>
              </div>
            </div>
            <hr>
            <div class="row">
              <div class="col-md-6">
                <h6>Zonas por Tipo</h6>
                <ul id="rep_zonasPorTipo" class="list-group"></ul>
              </div>
              <div class="col-md-6">
                <h6>Zonas por Nivel de Riesgo</h6>
                <ul id="rep_zonasPorNivel" class="list-group"></ul>
              </div>
            </div>
            <hr>
            <div class="row">
              <div class="col-12">
                <h6>Historial de Evacuaciones</h6>
                <div class="table-responsive">
                  <table class="table table-sm table-bordered" id="tabla-evacuaciones">
                    <thead>
                      <tr>
                        <th>Fecha</th>
                        <th>Zona</th>
                        <th>Personas Evacuadas</th>
                      </tr>
                    </thead>
                    <tbody></tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </section>


        </main>
    </div>
  </div>

  <div class="modal fade" id="modalLogin" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <form id="form-login">
          <div class="modal-header">
            <h5 class="modal-title">Iniciar sesiÃ³n</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="mb-2">
              <label class="form-label">Correo</label>
              <input id="login_email" required class="form-control form-control-sm" type="email" />
            </div>
            <div class="mb-2">
              <label class="form-label">ContraseÃ±a</label>
              <input id="login_password" required class="form-control form-control-sm" type="password" />
            </div>
            <div class="form-check">
              <input id="login_remember" class="form-check-input" type="checkbox" />
              <label class="form-check-label">Recordarme</label>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancelar</button>
            <button class="btn btn-primary btn-sm" type="submit">Entrar</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.7.5/dist/sockjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@stomp/stompjs@7.0.0/bundles/stomp.umd.min.js"></script>

  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />

  <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script> 

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <script>
    const apiBase = document.getElementById('backendUrl').textContent;
    const wsBase = document.getElementById('wsUrl').textContent;

    // NavegaciÃ³n de pestaÃ±as (sidebar)
    document.querySelectorAll('.list-group .list-group-item').forEach(a => {
      a.addEventListener('click', (e) => {
      e.preventDefault();
      if (!a.dataset.tab) return;

      document.querySelectorAll('.list-group .list-group-item')
      .forEach(x => x.classList.remove('active'));
      a.classList.add('active');

      const tab = a.getAttribute('data-tab');

      document.querySelectorAll('.tab-section')
      .forEach(s => s.classList.remove('active'));
     document.getElementById(tab).classList.add('active');

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    //  INICIALIZAR MAPA SOLO EN ESTA PESTAÃ‘A
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

      // Cargar reporte si es la pestaÃ±a de reportes
      if (tab === "panel-reportes") {
        cargarPanelReportes();
      }
          // Panel de Reportes: cargar datos
          async function cargarPanelReportes() {
            try {
              const res = await fetch(apiBase + '/admin/report/zonas', { credentials: 'include' });
              if (!res.ok) {
                document.getElementById('reporte-datos').innerHTML = '<div class="alert alert-danger">No autorizado o error al cargar reporte.</div>';
                return;
              }
              const data = await res.json();
              document.getElementById('rep_totalZonas').textContent = data.totalZonas;
              document.getElementById('rep_personasAfectadas').textContent = data.personasAfectadasTotal;
              document.getElementById('rep_totalRecursos').textContent = data.totalRecursos;
              document.getElementById('rep_recursosAsignados').textContent = data.recursosAsignados;
              document.getElementById('rep_recursosDisponibles').textContent = data.recursosDisponibles;
              document.getElementById('rep_equiposTotales').textContent = data.equiposTotales;
              document.getElementById('rep_equiposEnMision').textContent = data.equiposEnMision;

              // Zonas por tipo
              const ulTipo = document.getElementById('rep_zonasPorTipo');
              ulTipo.innerHTML = '';
              for (const [tipo, cant] of Object.entries(data.zonasPorTipo || {})) {
                ulTipo.innerHTML += `<li class="list-group-item d-flex justify-content-between align-items-center">${tipo}<span class="badge bg-primary rounded-pill">${cant}</span></li>`;
              }

              // Zonas por nivel de riesgo
              const ulNivel = document.getElementById('rep_zonasPorNivel');
              ulNivel.innerHTML = '';
              for (const [nivel, cant] of Object.entries(data.zonasPorNivelRiesgo || {})) {
                ulNivel.innerHTML += `<li class="list-group-item d-flex justify-content-between align-items-center">${nivel}<span class="badge bg-secondary rounded-pill">${cant}</span></li>`;
              }

              // Historial de evacuaciones
              const evacTable = document.querySelector('#tabla-evacuaciones tbody');
              evacTable.innerHTML = '<tr><td colspan="3">Cargando...</td></tr>';
              fetch(apiBase + '/evacuaciones')
                .then(r => r.json())
                .then(evacs => {
                  evacTable.innerHTML = '';
                  if (!Array.isArray(evacs) || evacs.length === 0) {
                    evacTable.innerHTML = '<tr><td colspan="3">Sin registros</td></tr>';
                  } else {
                    evacs.forEach(ev => {
                      const fecha = ev.ubicacion && ev.ubicacion.updatedAt ? new Date(ev.ubicacion.updatedAt).toLocaleString() : '-';
                      const zona = ev.ubicacion && ev.ubicacion.nombre ? ev.ubicacion.nombre : '-';
                      evacTable.innerHTML += `<tr><td>${fecha}</td><td>${zona}</td><td>${ev.personasEvacuadas}</td></tr>`;
                    });
                  }
                })
                .catch(() => { evacTable.innerHTML = '<tr><td colspan="3">Error al cargar evacuaciones</td></tr>'; });
            } catch (err) {
              document.getElementById('reporte-datos').innerHTML = '<div class="alert alert-danger">Error al cargar reporte.</div>';
            }
          }
      
      if (tab === "panel-admin") {
        populateLocationDropdown(); 
      }

      if (tab === "crear-ubicacion") {
        setTimeout(() => {
          if (!cuMap) {
            cuMap = L.map("map-crear-ubicacion").setView([4.65, -74.1], 12);

            L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
             maxZoom: 19
            }).addTo(cuMap);

            cuMap.on("click", (e) => {
              if (cuMarker) cuMap.removeLayer(cuMarker);
              cuMarker = L.marker(e.latlng).addTo(cuMap);

              cu_lat.value = e.latlng.lat.toFixed(6);
              cu_lng.value = e.latlng.lng.toFixed(6);
            });
          }

          cuMap.invalidateSize(); // â† Arregla el mapa roto
        }, 100);
      }
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    if (tab === "crear-ruta") {
      setTimeout(() => {
        if (!crMap) {
          initCrearRutaMap();
        } else {
          // Necesario porque Leaflet a veces no se ve bien al aparecer
          crMap.invalidateSize();
        }
      }, 50);
    }
  });
});

//mapa bueno
    // ----- MAPA CREAR UBICACIÃ“N -----
  let cuMap = L.map("map-crear-ubicacion").setView([4.65, -74.1], 12);

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 19
  }).addTo(cuMap);

  let cuMarker = null;

  cuMap.on("click", function (e) {
    if (cuMarker) cuMap.removeLayer(cuMarker);
    cuMarker = L.marker(e.latlng).addTo(cuMap);

    document.getElementById("cu_lat").value = e.latlng.lat.toFixed(6);
    document.getElementById("cu_lng").value = e.latlng.lng.toFixed(6);
  });

  // ----- GUARDAR UBICACIÃ“N -----
  document.getElementById("cu_guardar").addEventListener("click", async () => {

    const personas = parseInt(document.getElementById("cu_personasAfectadas").value, 10);
    const payload = {
      nombre: document.getElementById("cu_nombre").value,
      tipo: document.getElementById("cu_tipo").value,
      lat: document.getElementById("cu_lat").value,
      lng: document.getElementById("cu_lng").value,
      nivelRiesgo: document.getElementById("cu_riesgo").value,
      personasAfectadas: Number.isFinite(personas) && personas >= 0 ? personas : 0
    };


    if (!payload.lat || !payload.lng) {
      Swal.fire('Error', 'Selecciona un punto en el mapa.', 'warning');
      return;
    }

    try {
        const res = await fetch(apiBase + '/zonas', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

      // leer respuesta como texto o json
      const text = await res.text();
      let body = null;

      try {
        body = JSON.parse(text);
      } catch {
        body = { message: text };
     }

      if (res.status === 409) {
        Swal.fire('Duplicado', body.message || 'Zona ya registrada.', 'warning');
        return;
      }

      if (!res.ok) {
        Swal.fire('Error', body.message || 'No se pudo guardar la ubicaciÃ³n', 'error');
        return;
      }

      addLog('UbicaciÃ³n creada: ' + (body.nombre || payload.nombre));
      loadUbicaciones();
      loadZonas();

      Swal.fire('Ã‰xito', 'UbicaciÃ³n creada correctamente.', 'success');

    } catch (error) {
      console.error('Error al guardar ubicaciÃ³n:', error);
      Swal.fire('Error', 'Error al crear la ubicaciÃ³n: ' + error.message, 'error');
    }

  });
// =============================
  //    MAPA PARA CREAR RUTA
  // =============================

let crMap = null;
let crMarkers = [];        // todos los puntos cargados
let crSelected = [];       // los puntos seleccionados (max 2)

// 'crLine' es el CONTROLADOR de ruteo
let crLine = null; 
// 'crRouteSummary' guardarÃ¡ la distancia
let crRouteSummary = null;

async function initCrearRutaMap() {
  crMap = L.map("map-crear-ruta").setView([4.65, -74.1], 12);

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 19
  }).addTo(crMap);

  const ubicaciones = await loadUbicacionesParaRutas();
  const bounds = [];
  
  crMarkers.forEach(m => crMap.removeLayer(m));
  crMarkers = [];
  limpiarRuta(); // Limpiar la selecciÃ³n

  ubicaciones.forEach(u => {
    if (u.lat && u.lng) {
      const marker = L.marker([u.lat, u.lng])
        .addTo(crMap)
        .bindPopup(`<b>${u.nombre}</b>`);

      marker.data = u; 
      marker.on("click", () => selectPunto(marker));
      crMarkers.push(marker);
      bounds.push([u.lat, u.lng]);
    }
  });

  if (bounds.length > 0) {
    crMap.fitBounds(bounds, { padding: [50, 50] });
  }

  setTimeout(() => crMap.invalidateSize(), 150);
}

// Helper para cargar ubicaciones
async function loadUbicacionesParaRutas() {
  try {
    const res = await fetch(apiBase + "/zonas");
    if (!res.ok) {
      console.error("Error cargando ubicaciones:", res.status);
      return [];
    }
    return await res.json();
  } catch (error) {
    console.error("Error en fetch:", error);
    return [];
  }
}

// -----------------------------
// Manejo de selecciÃ³n de puntos
// -----------------------------
function selectPunto(marker) {
  if (crSelected.includes(marker)) return;

  if (crSelected.length === 2) {
    Swal.fire("MÃ¡ximo 2 puntos", "Ya has seleccionado dos puntos. Limpia la selecciÃ³n primero.", "info");
    return;
  }

  crSelected.push(marker);
  
  // Dibujar ruta si ya hay dos puntos
  if (crSelected.length === 2) {
    dibujarRuta();
  }
}

// -----------------------------
// Dibujar la LÃNEA DE RUTA (CORREGIDO)
// -----------------------------
function dibujarRuta() {
  const p1 = crSelected[0].getLatLng();
  const p2 = crSelected[1].getLatLng();

  // borrar ruta previa si existe
  if (crLine) {
    crMap.removeControl(crLine);
    crLine = null;
    crRouteSummary = null;
  }

  // âœ… ESTA ES LA CORRECCIÃ“N CLAVE:
  // Dejamos que el plugin cree sus marcadores por defecto (A y B)
  // y solo ocultamos el panel de instrucciones de texto.
  crLine = L.Routing.control({
    waypoints: [p1, p2],
    show: false, // Oculta el panel de texto de "instrucciones"
    routeWhileDragging: false, // No permite arrastrar la ruta
    addWaypoints: false, // No permite aÃ±adir mÃ¡s puntos
    
    // ðŸ‘‡ Ya no usamos 'createMarker', dejamos que el plugin
    //    ponga sus marcadores A (verde) y B (rojo) por defecto.
    
    // Personalizar el color de la lÃ­nea
    lineOptions: {
      styles: [{color: 'blue', opacity: 0.8, weight: 6}]
    }
  }).addTo(crMap);

  // Escuchar cuando la ruta se calcula para obtener la distancia
  crLine.on('routesfound', function(e) {
      if (e.routes && e.routes.length > 0) {
          crRouteSummary = e.routes[0].summary;
          console.log(`Ruta encontrada: ${crRouteSummary.totalDistance} metros.`);
      }
  });
}

// -----------------------------
// Limpiar selecciÃ³n (CORREGIDO)
// -----------------------------
function limpiarRuta() {
  // âœ… CORRECCIÃ“N: Ya no necesitamos hacer visibles los marcadores
  // porque nunca los ocultamos.
  
  crSelected = [];
  crRouteSummary = null;

  // Borrar el control de ruta del mapa (esto borra los
  // marcadores A/B y la lÃ­nea azul)
  if (crLine) {
    crMap.removeControl(crLine);
    crLine = null;
  }
}

// Conectar botÃ³n "Limpiar"
document.getElementById("cr_limpiar").addEventListener("click", limpiarRuta);


// ---------------------------------
//  LÃ“GICA DE GUARDADO (Sin cambios, pero la incluyo)
// ---------------------------------
document.getElementById("cr_guardar").addEventListener("click", guardarRuta);

async function guardarRuta() {
  if (crSelected.length !== 2) {
    Swal.fire("Error", "Debes seleccionar exactamente dos puntos (origen y destino) en el mapa.", "warning");
    return;
  }
  
  if (!crRouteSummary) {
    Swal.fire("Espera", "La ruta aÃºn se estÃ¡ calculando. IntÃ©ntalo de nuevo en un segundo.", "info");
    return;
  }

  const markerOrigen = crSelected[0];
  const markerDestino = crSelected[1];
  const distanciaKm = crRouteSummary.totalDistance / 1000;
//id: markerDestino.data.id 
  const payload = {
    origen: { id: markerOrigen.data.id ,lat: markerOrigen.data.lat, lng: markerOrigen.data.lng, nombre: markerOrigen.data.nombre },
    destino: { id: markerDestino.data.id ,lat: markerDestino.data.lat, lng: markerDestino.data.lng, nombre: markerDestino.data.nombre},
  };

  console.log("Enviando ruta:", payload);

  try {
    const res = await fetch(apiBase + '/rutas/crear', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    if (res.ok) {
      Swal.fire(
        'Â¡Ruta Creada!',
        `Se guardÃ³ la ruta entre ${markerOrigen.data.nombre} y ${markerDestino.data.nombre} (${payload.distancia} km).`,
        'success'
      );
      limpiarRuta();
    } else {
      const errorMsg = await res.text();
      Swal.fire('Error al guardar', `No se pudo crear la ruta: ${errorMsg}`, 'error');
    }

  } catch (error) {
    console.error('Error en fetch al guardar ruta:', error);
    Swal.fire('Error de Red', 'No se pudo conectar con el servidor.', 'error');
  }
}


    let stompClient = null;
    function connectWebSocket() {
      const httpUrl = wsBase.replace('ws://', 'http://'); // adaptado para SockJS
      const socket = new SockJS(httpUrl);
      stompClient = StompJs.Stomp.over(socket);
      stompClient.connect({}, function (frame) {
        console.log('Connected: ' + frame);
        document.getElementById('wsStatus').textContent = 'WS: conectado';
        stompClient.subscribe('/topic/evacuaciones', function (message) {
          const payload = JSON.parse(message.body);
          addLog('EvacuaciÃ³n recibida: ' + payload.ubicacion);
        });
      }, function (err) {
        console.error('STOMP error', err);
        document.getElementById('wsStatus').textContent = 'WS: error';
      });
    }

    // Log de acciones
    function addLog(text) {
      const li = document.createElement('li');
      li.className = 'list-group-item';
      li.textContent = '[' + new Date().toLocaleTimeString() + '] ' + text;
      const list = document.getElementById('logActivity');
      list.prepend(li);
    }

    
    // Crear recurso
  // Reemplaza el manejador document.getElementById('form-create-resource').addEventListener('submit', (e) => {...})

document.getElementById('form-create-resource').addEventListener('submit', (e) => {
  e.preventDefault();
  const nombre = document.getElementById('r_nombre').value;
  const tipo = document.getElementById('r_tipo').value;
  const cantidad = +document.getElementById('r_cantidad').value;
  
  // Ahora los recursos se crean sin asignar ubicaciÃ³n (se asignan desde la vista de UbicaciÃ³n)
  const payload = { 
    nombre, 
    tipo, 
    cantidad
  };

  fetch(apiBase + '/recursos', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  })
    .then(r => {
      if (!r.ok) {
        throw new Error(`HTTP error! status: ${r.status}`);
      }
      return r.json();
    })
    .then(data => {
      addLog('Recurso creado: ' + data.nombre);
      loadRecursos(); // Refresca la tabla de recursos
      Swal.fire('Ã‰xito', 'Recurso creado correctamente.', 'success');
    })
    .catch(err => { 
      console.error(err); 
      addLog('Error creando recurso. Revisar backend.'); 
      Swal.fire('Error', 'Error al crear o asignar el recurso. Verifique la conexiÃ³n.', 'error');
    });
});
  // AÃ±adir en el bloque <script> principal

/**
 * Carga todas las ubicaciones y llena el menÃº desplegable.
 */
async function populateLocationDropdown() {
    const select = document.getElementById('r_ubicacion_select');
    if (!select) return;

    try {
        const res = await fetch(apiBase + '/zonas');
        const ubicaciones = await res.json();
        
        select.innerHTML = '<option value="">Selecciona una ubicaciÃ³n</option>'; // OpciÃ³n por defecto
        
        ubicaciones.forEach(u => {
            const option = document.createElement('option');
            // Guardamos el ID como valor, el nombre como texto visible
            option.value = u.id; 
            option.textContent = `ID ${u.id}: ${u.nombre} (${u.nivelRiesgo})`;
            select.appendChild(option);
        });

    } catch (error) {
        console.error('Error cargando ubicaciones para el dropdown:', error);
        select.innerHTML = '<option value="">Error al cargar ubicaciones</option>';
    }
}

// -----------------------------
// Crear equipo de rescate (Admin)
// -----------------------------
document.getElementById('btn-create-team').addEventListener('click', async (e) => {
  e.preventDefault();

  const tipo = document.getElementById('e_tipo').value;
  const miembros = parseInt(document.getElementById('e_miembros').value, 10) || 0;

  if (!tipo) {
    Swal.fire('Error', 'Selecciona un tipo de equipo.', 'warning');
    return;
  }

  if (miembros <= 0) {
    Swal.fire('Error', 'El nÃºmero de miembros debe ser mayor a 0.', 'warning');
    return;
  }

  const payload = {
    tipo: tipo,
    miembros: miembros,
    estado: 'DISPONIBLE'
  };

  try {
    const res = await fetch(apiBase + '/admin/equipos', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    const text = await res.text();
    let body = null;
    try { body = JSON.parse(text); } catch (_) { body = { message: text }; }

    if (!res.ok) {
      Swal.fire('Error', body.message || 'No se pudo crear el equipo', 'error');
      return;
    }

    addLog('Equipo creado: ' + (body.tipo || tipo) + ' (miembros: ' + miembros + ')');
    Swal.fire('Ã‰xito', 'Equipo de rescate creado correctamente.', 'success');

    // Limpia el formulario
    document.getElementById('e_miembros').value = '5';
    // Refrescar lista de equipos
    try { loadEquipos(); } catch (e) { /* ignore */ }
  } catch (err) {
    console.error('Error creando equipo:', err);
    Swal.fire('Error', 'No se pudo conectar con el servidor.', 'error');
  }
});

    // Crear ubicaciÃ³n
    document.getElementById("form-create-ubicacion").addEventListener("submit", async (event) => {
      event.preventDefault();

      const personasVal = parseInt(document.getElementById("u_personasAfectadas").value, 10);
      const ubicacion = {
        nombre: document.getElementById("u_nombre").value,
        tipo: document.getElementById("u_tipo").value,
        lat: parseFloat(document.getElementById("u_lat").value),
        lng: parseFloat(document.getElementById("u_lng").value),
        nivelRiesgo: document.getElementById("u_nivelRiesgo").value,
        personasAfectadas: Number.isFinite(personasVal) && personasVal >= 0 ? personasVal : 0
      };

      console.log('Enviando ubicaciÃ³n:', ubicacion);

      try {
        const res = await fetch(apiBase + '/zonas', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(ubicacion)
        });

        const msg = await res.text();

        if (res.status === 409) {
          Swal.fire('Duplicado', msg, 'warning');
        } else if (!res.ok) {
          Swal.fire('Error', 'No se pudo guardar la ubicaciÃ³n', 'error');
        } else {
          const data = JSON.parse(msg);
          addLog('UbicaciÃ³n creada: ' + data.nombre);
          loadUbicaciones();
          loadZonas();
          Swal.fire('Ã‰xito', 'UbicaciÃ³n creada correctamente', 'success');
        }

      } catch (error) {
        console.error('Error:', error);
        Swal.fire('Error', 'Error al crear la ubicaciÃ³n: ' + error.message, 'error');
      }
    });

    // Cargar ubicaciones (tabla)
    function loadUbicaciones() {
      fetch(apiBase + '/zonas')
        .then(r => r.json())
        .then(ubicaciones => {
          const tbody = document.querySelector('#tabla-ubicaciones tbody');
          tbody.innerHTML = '';
          ubicaciones.forEach(u => {
            tbody.innerHTML += `
              <tr>
                <td>${u.nombre}</td>
                <td>${u.tipo}</td>
                <td>${u.lng}</td>
                <td>${u.lat}</td>
                <td>${u.nivelRiesgo}</td>
                <td><button class="btn btn-sm btn-outline-danger btn-delete-ubicacion" data-id="${u.id}">Eliminar</button></td>
              </tr>
            `;
          });

          // Attach delete handlers
          document.querySelectorAll('.btn-delete-ubicacion').forEach(b => b.addEventListener('click', async (ev) => {
            const id = b.dataset.id;
            const result = await Swal.fire({
              title: 'Confirmar',
              text: 'Â¿Eliminar esta ubicaciÃ³n? Esta acciÃ³n no se puede deshacer.',
              icon: 'warning',
              showCancelButton: true,
              confirmButtonText: 'Eliminar',
              cancelButtonText: 'Cancelar'
            });

            if (!result.isConfirmed) return;

            try {
              const res = await fetch(apiBase + '/zonas/' + id, { method: 'DELETE' });
              const text = await res.text();
              if (res.status === 401) { Swal.fire('No autenticado', 'Debes iniciar sesiÃ³n como administrador.', 'error'); return; }
              if (res.status === 403) { Swal.fire('Acceso denegado', 'No tienes permisos para eliminar.', 'error'); return; }
              if (!res.ok) { Swal.fire('Error', text || 'No se pudo eliminar la ubicaciÃ³n', 'error'); return; }

              Swal.fire('Eliminado', 'UbicaciÃ³n eliminada correctamente.', 'success');
              loadUbicaciones();
              loadZonas();
            } catch (err) {
              console.error('Error eliminando ubicacion', err);
              Swal.fire('Error', 'No se pudo eliminar la ubicaciÃ³n', 'error');
            }
          }));
        })
        .catch(e => console.error('Error cargando ubicaciones:', e));
    }

    document.addEventListener('DOMContentLoaded', loadUbicaciones);

    // LÃ³gica 'form-create-route' ELIMINADA (era parte de 'panel-rutas')

    // Cargar recursos
    function loadRecursos() {
      fetch(apiBase + '/recursos')
        .then(r => r.json())
        .then(list => {
          const tbody = document.querySelector('#tabla-recursos tbody');
          tbody.innerHTML = '';
          let totalDisponibles = 0;
          list.forEach(r => {
            if (r.disponible) {
              totalDisponibles += r.cantidad || 0;
            }
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${r.nombre}</td>
              <td>${r.tipo}</td>
              <td>${r.cantidad}</td>
              <td>${r.disponible ? 'SÃ­' : 'No'}</td>`;
            tbody.appendChild(tr);
          });
          document.getElementById('totalResources').textContent = totalDisponibles;
        })
        .catch(e => console.warn('No se pudo cargar recursos', e));
    }

    // Cargar equipos de rescate
    function loadEquipos() {
      fetch(apiBase + '/admin/equipos')
        .then(r => {
          if (!r.ok) throw new Error('No autorizado o error al cargar equipos');
          return r.json();
        })
        .then(list => {
          const tbody = document.querySelector('#tabla-equipos tbody');
          if (!tbody) return;
          tbody.innerHTML = '';
          list.forEach(e => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${e.idEquipo || ''}</td>
              <td>${e.tipo || ''}</td>
              <td>${e.miembros || 0}</td>
              <td>${e.estado || ''}</td>
            `;
            tbody.appendChild(tr);
          });
        })
        .catch(err => {
          console.warn('No se pudieron cargar equipos:', err);
        });
    }

    // Click en "Ver" zona tabla
    document.querySelector('#tabla-zonas tbody').addEventListener('click', (e) => {
      const btn = e.target.closest('button[data-id]');
      if (!btn) return;
      const id = btn.dataset.id;
      fetch(apiBase + '/zonas/' + id)
        .then(r => r.json())
        .then(ubicacion => { mostrarUbicacion(ubicacion); })
        .catch(err => console.error('Error al obtener ubicaciÃ³n:', err));
    });

    function mostrarUbicacion(ubicacion) {
      const html = `
        <div>
          <b>ID:</b> ${ubicacion.id}<br>
          <b>Nombre:</b> ${ubicacion.nombre}<br>
          <b>Latitud:</b> ${ubicacion.lat}<br>
          <b>Longitud:</b> ${ubicacion.lng}<br>
          <b>Nivel de riesgo:</b> ${ubicacion.nivelRiesgo}<br>
          <b>Personas afectadas:</b> ${ubicacion.personasAfectadas}<br>
          <b>Ãšltima actualizaciÃ³n:</b> ${ubicacion.updatedAt}<br>
        </div>

        <hr>

        <div class="row">
          <div class="col-md-6">
            <h6>Recursos asignados</h6>
            <ul id="assignedRecursos" class="list-group mb-2"></ul>
            <h6>Recursos disponibles</h6>
            <ul id="availableRecursos" class="list-group"></ul>
          </div>
          <div class="col-md-6">
            <h6>Equipos asignados</h6>
            <ul id="assignedEquipos" class="list-group mb-2"></ul>
            <h6>Equipos disponibles</h6>
            <ul id="availableEquipos" class="list-group"></ul>
          </div>
        </div>
      `;

      Swal.fire({
        title: 'UbicaciÃ³n encontrada',
        html: html,
        width: 900,
        showCloseButton: true,
        focusConfirm: false,
        didOpen: async () => {
          // Populate assigned lists from the `ubicacion` object
          const assignedRecursos = document.getElementById('assignedRecursos');
          const assignedEquipos = document.getElementById('assignedEquipos');

          assignedRecursos.innerHTML = '';
          (ubicacion.recursosNecesarios || []).forEach(r => {
            const li = document.createElement('li');
            li.className = 'list-group-item d-flex justify-content-between align-items-center';
            li.innerHTML = `<span>${r.nombre} (${r.tipo}) x${r.cantidad}</span>
                            <button class="btn btn-sm btn-outline-danger btn-desasignar-recurso" data-id="${r.id}">Desasignar</button>`;
            assignedRecursos.appendChild(li);
          });

          assignedEquipos.innerHTML = '';
          (ubicacion.equipos || []).forEach(e => {
            const li = document.createElement('li');
            li.className = 'list-group-item d-flex justify-content-between align-items-center';
            li.innerHTML = `<span>${e.tipo} (miembros: ${e.miembros}) - ${e.estado || ''}</span>
                            <button class="btn btn-sm btn-outline-danger btn-desasignar-equipo" data-id="${e.idEquipo}">Desasignar</button>`;
            assignedEquipos.appendChild(li);
          });

          // Load all resources and show those not assigned
          try {
            const allRecursos = await fetch(apiBase + '/recursos').then(r => r.json());
            const assignedIds = new Set((ubicacion.recursosNecesarios || []).map(x => x.id));
            const availableRecursos = document.getElementById('availableRecursos');
            availableRecursos.innerHTML = '';
            allRecursos.forEach(r => {
              if (!assignedIds.has(r.id)) {
                const li = document.createElement('li');
                li.className = 'list-group-item d-flex justify-content-between align-items-center';
                li.innerHTML = `<span>${r.nombre} (${r.tipo}) x${r.cantidad}</span>
                                <button class="btn btn-sm btn-outline-primary btn-asignar-recurso" data-id="${r.id}">Asignar</button>`;
                availableRecursos.appendChild(li);
              }
            });
          } catch (err) {
            console.warn('Error cargando recursos disponibles', err);
          }

          // Load all equipos and show those not assigned
          try {
            const allEquipos = await fetch(apiBase + '/admin/equipos').then(r => r.ok ? r.json() : []);
            const assignedEquipoIds = new Set((ubicacion.equipos || []).map(x => x.idEquipo));
            const availableEquipos = document.getElementById('availableEquipos');
            availableEquipos.innerHTML = '';
            allEquipos.forEach(e => {
              if (!assignedEquipoIds.has(e.idEquipo)) {
                const li = document.createElement('li');
                li.className = 'list-group-item d-flex justify-content-between align-items-center';
                li.innerHTML = `<span>${e.tipo} (miembros: ${e.miembros})</span>
                                <button class="btn btn-sm btn-outline-primary btn-asignar-equipo" data-id="${e.idEquipo}">Asignar</button>`;
                availableEquipos.appendChild(li);
              }
            });
          } catch (err) {
            console.warn('Error cargando equipos disponibles', err);
          }

          // Attach handlers (delegation would be cleaner, but we attach directly)
          document.querySelectorAll('.btn-asignar-recurso').forEach(b => b.addEventListener('click', async (ev) => {
            const id = b.dataset.id;
            try {
              const resp = await fetch(apiBase + `/recursos/${id}/asignar`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ubicacionId: ubicacion.id })
              });

              if (resp.status === 409) {
                const text = await resp.text();
                let body = null;
                try { body = JSON.parse(text); } catch (_) { body = { message: text }; }
                Swal.fire('Conflicto', body.message || 'Recurso ya asignado a otra ubicaciÃ³n.', 'warning');
                return;
              }

              if (!resp.ok) {
                const text = await resp.text();
                Swal.fire('Error', text || 'No se pudo asignar recurso', 'error');
                return;
              }

              // refresh view
              const res = await fetch(apiBase + '/zonas/' + ubicacion.id);
              const fresh = await res.json();
              Swal.close();
              mostrarUbicacion(fresh);
              loadRecursos();
            } catch (err) { console.error(err); Swal.fire('Error','No se pudo asignar recurso','error'); }
          }));

          document.querySelectorAll('.btn-desasignar-recurso').forEach(b => b.addEventListener('click', async (ev) => {
            const id = b.dataset.id;
            try {
              await fetch(apiBase + `/recursos/${id}/desasignar`, { method: 'PUT' });
              const res = await fetch(apiBase + '/zonas/' + ubicacion.id);
              const fresh = await res.json();
              Swal.close();
              mostrarUbicacion(fresh);
              loadRecursos();
            } catch (err) { console.error(err); Swal.fire('Error','No se pudo desasignar recurso','error'); }
          }));

          document.querySelectorAll('.btn-asignar-equipo').forEach(b => b.addEventListener('click', async (ev) => {
            const id = b.dataset.id;
            try {
              const resp = await fetch(apiBase + `/admin/equipos/${id}/ubicacion`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ubicacionId: ubicacion.id })
              });

              if (resp.status === 409) {
                const text = await resp.text();
                let body = null;
                try { body = JSON.parse(text); } catch (_) { body = { message: text }; }
                Swal.fire('Conflicto', body.message || 'Equipo ya asignado a otra ubicaciÃ³n.', 'warning');
                return;
              }

              if (!resp.ok) {
                const text = await resp.text();
                Swal.fire('Error', text || 'No se pudo asignar equipo', 'error');
                return;
              }

              const res = await fetch(apiBase + '/zonas/' + ubicacion.id);
              const fresh = await res.json();
              Swal.close();
              mostrarUbicacion(fresh);
              loadEquipos();
            } catch (err) { console.error(err); Swal.fire('Error','No se pudo asignar equipo','error'); }
          }));

          document.querySelectorAll('.btn-desasignar-equipo').forEach(b => b.addEventListener('click', async (ev) => {
            const id = b.dataset.id;
            try {
              await fetch(apiBase + `/admin/equipos/${id}/desasignar`, { method: 'PUT' });
              const res = await fetch(apiBase + '/zonas/' + ubicacion.id);
              const fresh = await res.json();
              Swal.close();
              mostrarUbicacion(fresh);
              loadEquipos();
            } catch (err) { console.error(err); Swal.fire('Error','No se pudo desasignar equipo','error'); }
          }));
        }
      });
    }

    // Cargar zonas
    function loadZonas() {
      fetch(apiBase + '/zonas')
        .then(r => r.json())
        .then(list => {
          const tbody = document.querySelector('#tabla-zonas tbody');
          tbody.innerHTML = '';
          // zonasLayer.clearLayers(); // <-- JS DE MAPA ELIMINADO

          let countCritical = 0;
          let totalAfectadas = 0;

          list.forEach(z => {
            if (z.nivelRiesgo === 'CRITICO') countCritical++;
            totalAfectadas += z.personasAfectadas || 0;

            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${z.nombre}</td>
              <td>${z.tipo}</td>
              <td><span class="badge ${
                z.nivelRiesgo === 'CRITICO' || z.nivelRiesgo === 'ALTO'
                  ? 'badge-risk-high'
                  : z.nivelRiesgo === 'MEDIO'
                    ? 'badge-risk-medium'
                    : 'badge-risk-low'
              }">${z.nivelRiesgo}</span></td>
              <td>${z.personasAfectadas}</td>
              <td>${z.recursosNecesarios?.length || 0}</td>
              <td>${new Date(z.updatedAt || Date.now()).toLocaleString()}</td>
              <td><button class="btn btn-sm btn-outline-secondary" data-id="${z.id}">Ver</button></td>`;
            tbody.appendChild(tr);

            // <-- BLOQUE 'if (z.lat && z.lng)' ELIMINADO (ERA PARA EL MAPA) -->
            
          });

          document.getElementById('countCritical').textContent = countCritical;
          document.getElementById('totalEvacuated').textContent = totalAfectadas;
        })
        .catch(e => console.warn('No se pudo cargar zonas', e));
    }

    // ===============================
    //   Cargar usuario actual (navbar)
    // ===============================
    function cargarUsuarioActual() {
      const userSpan = document.getElementById("currentUser");
      if (!userSpan) return;

      fetch("/api/usuario/actual")
        .then((res) => {
          if (!res.ok) {
            throw new Error("No autenticado o error en /api/usuario/actual");
          }
          return res.json();
        })
        .then((user) => {
          if (!user) return;
          const rolLabel = user.rol === "ADMINISTRADOR" ? "Admin" : "Operador";
          userSpan.textContent = `${rolLabel}: ${user.nombre} (${user.email})`;
        })
        .catch((err) => {
          console.warn("No se pudo cargar el usuario actual:", err);
        });
    }

    // InicializaciÃ³n
    window.addEventListener('load', () => {
      try { connectWebSocket(); } catch (e) { console.warn('WS init error', e); }
      loadRecursos();
      loadZonas();
      cargarUsuarioActual();
      loadEquipos();

      // <-- LÃ“GICA DE 'btn-load-sample' ELIMINADA -->

      const btnRefresh = document.getElementById('btn-refresh');
      if (btnRefresh) {
        btnRefresh.addEventListener('click', () => {
          loadRecursos();
          loadZonas();
          addLog('Datos refrescados manualmente');
        });
      }
    });

    // LOGOUT / SALIR
    const logoutLink = document.getElementById('menu-logout');
    if (logoutLink) {
      logoutLink.addEventListener('click', (e) => {
        e.preventDefault();
        window.location.href = '/logout';
      });
    }

    const exitLink = document.getElementById('menu-exit');
    if (exitLink) {
      exitLink.addEventListener('click', (e) => {
        e.preventDefault();
        Swal.fire({
          title: 'Cerrar sesiÃ³n',
          text: 'Â¿Seguro que quieres salir de la demo?',
          icon: 'warning',
          showCancelButton: true,
          confirmButtonText: 'SÃ­, salir',
          cancelButtonText: 'Cancelar'
        }).then((result) => {
          if (result.isConfirmed) {
            window.location.href = '/logout';
          }
        });
      });
    }

    // ValidaciÃ³n de ubicaciÃ³n (si quieres usarla luego)
    function validarUbicacion(ubicacion) {
      const tiposValidos = ['URBANA', 'RURAL'];
      const nivelesRiesgo = ['BAJO', 'MEDIO', 'ALTO', 'CRITICO'];

      if (!tiposValidos.includes(ubicacion.tipo)) {
        throw new Error('Tipo de ubicaciÃ³n no vÃ¡lido');
      }

      if (!nivelesRiesgo.includes(ubicacion.nivelRiesgo)) {
        throw new Error('Nivel de riesgo no vÃ¡lido');
      }

      if (!ubicacion.nombre || ubicacion.nombre.trim() === '') {
        throw new Error('El nombre es requerido');
      }

      return true;
    }
  </script>
</body>

</html>