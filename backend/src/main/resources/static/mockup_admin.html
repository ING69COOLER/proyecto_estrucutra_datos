<!doctype html>
<html lang="es">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sistema Gesti√≥n de Desastres Naturales ‚Äî ADMIN</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  
  <!-- 1. Importar Font Awesome (para el √≠cono de basura) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">


  <style>
    body {
      background: #f8f9fa;
    }

    /* IDs de mapas */
    #map-crear-ubicacion,
    #map-crear-ruta,
    #map-eliminar-ubicacion { /* <-- 2. A√±adido estilo para el nuevo mapa */
      height: 700px;
      border-radius: 8px;
    }


    .sidebar {
      max-height: 85vh;
      overflow-y: auto;
    }

    .tab-section {
      display: none;
    }

    .tab-section.active {
      display: block;
    }

    .small-muted {
      font-size: 0.85rem;
      color: #6c757d;
    }

    .card-map {
      height: 100%;
    }

    .badge-risk-low {
      background: #198754;
    }

    .badge-risk-medium {
      background: #ffc107;
      color: #000;
    }

    .badge-risk-high {
      background: #dc3545;
    }

    /* FORZAR LAYOUT DE DOS COLUMNAS */
    .container-fluid {
      padding-left: 15px;
      padding-right: 15px;
    }

    .row {
      display: flex;
      flex-wrap: wrap;
      margin-right: -15px;
      margin-left: -15px;
    }

    aside.col-md-3 {
      flex: 0 0 25%;
      max-width: 25%;
      padding-right: 15px;
      padding-left: 15px;
    }

    main.col-md-9 {
      flex: 0 0 75%;
      max-width: 75%;
      padding-right: 15px;
      padding-left: 15px;
    }

    /* RESPONSIVE: En pantallas peque√±as, stack vertical */
    @media (max-width: 768px) {
      aside.col-md-3,
      main.col-md-9 {
        flex: 0 0 100%;
        max-width: 100%;
      }
    }
  </style>
</head>

<body>
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <!-- ... (navbar sin cambios) ... -->
    <div class="container-fluid">
      <a class="navbar-brand" href="#">SGD - Gesti√≥n Desastres (Admin)</a>

      <div class="d-flex align-items-center">
        <span id="wsStatus" class="badge bg-secondary me-2">WS: desconectado</span>

        <span id="currentUser" class="text-light small me-3"></span>

        <button class="btn btn-outline-light btn-sm me-2" id="btn-refresh">Refrescar datos</button>

        <div class="dropdown">
          <a class="btn btn-outline-light dropdown-toggle" data-bs-toggle="dropdown" href="#" role="button"
            aria-expanded="false">
            <i class="fa fa-user"></i> Cuenta
          </a>
          <ul class="dropdown-menu dropdown-menu-end">
            <li><a class="dropdown-item" href="#" id="menu-logout">Cerrar sesi√≥n</a></li>
          </ul>
        </div>
      </div>
    </div>
  </nav>

  <div class="container-fluid mt-3">
    <div class="row">

      <aside class="col-md-3">
        <div class="card sidebar p-2">
          <h5 class="mb-2">Men√∫</h5>
          <div class="list-group">
            <a href="#" class="list-group-item list-group-item-action active" data-tab="inicio">Inicio</a>
            <a href="#" class="list-group-item list-group-item-action" data-tab="panel-admin">Panel Administraci√≥n</a>
            <a href="#" class="list-group-item list-group-item-action" data-tab="crear-ubicacion">Crear Ubicaci√≥n</a>
            <a href="#" class="list-group-item list-group-item-action" data-tab="crear-ruta">Crear Ruta</a>
            
            <!-- 3. A√ëADIR NUEVA PESTA√ëA/BOT√ìN EN EL SIDEBAR -->
            <a href="#" class="list-group-item list-group-item-action" data-tab="eliminar-ubicacion">Eliminar Ubicaci√≥n</a>
            <!-- DESPU√âS de la l√≠nea de "Eliminar Ubicaci√≥n" -->
            <a href="#" class="list-group-item list-group-item-action" data-tab="distribuir-recursos">Distribuir Recursos</a>
            <a href="#" class="list-group-item list-group-item-action" data-tab="distribuir-equipos">Distribuir Equipos</a>
            <a href="#" class="list-group-item list-group-item-action" data-tab="reportes">Reportes y Estad√≠sticas</a>
            <a href="#" class="list-group-item list-group-item-action" data-tab="carga-datos">Carga Inicial</a>

            <a href="#" class="list-group-item list-group-item-action text-danger" id="menu-exit">
              salir
            </a>
          </div>

          <hr>
          <h6 class="mt-2">Conexiones</h6>
          <p class="small-muted">Backend: <span id="backendUrl">http://localhost:8081/api</span></p>
          <p class="small-muted">WebSocket: <span id="wsUrl">ws://localhost:8081/ws</span></p>
        </div>
      </aside>

      <main class="col-md-9">
        
        <!-- ... (Secci√≥n 'inicio' sin cambios) ... -->
        <section id="inicio" class="tab-section active">
          <!-- ... -->
          <div class="row g-3">
            <div class="col-lg-8">
              <div class="card card-map p-3">
                <h5>Vista general</h5>
                <p class="small-muted mb-2">Resumen de zonas afectadas y recursos disponibles.</p>

                <div class="row mb-3">
                  <div class="col-sm-4">
                    <div class="card p-2">
                      <h6>Zonas cr√≠ticas</h6>
                      <p id="countCritical" class="display-6 m-0">0</p>
                    </div>
                  </div>
                  <div class="col-sm-4">
                    <div class="card p-2">
                      <h6>Personas afectadas</h6>
                      <p id="totalEvacuated" class="display-6 m-0">0</p>
                    </div>
                  </div>
                  <div class="col-sm-4">
                    <div class="card p-2">
                      <h6>Recursos</h6>
                      <p id="totalResources" class="display-6 m-0">0</p>
                    </div>
                  </div>
                </div>

                <div>
                  <h6>Zonas afectadas</h6>
                  <div class="table-responsive">
                    <table class="table table-striped table-sm" id="tabla-zonas">
                      <thead>
                        <tr>
                          <th>Zona</th>
                          <th>Tipo</th>
                          <th>Riesgo</th>
                          <th>Personas</th>
                          <th>Recursos Necesarios</th>
                          <th>√öltima actualizaci√≥n</th>
                          <th>Acciones</th>
                        </tr>
                      </thead>
                      <tbody>
                        </tbody>
                    </table>
                  </div>
                </div>

              </div>
            </div>

            <div class="col-lg-4">
              <div class="card p-2 mb-3">
                <h6>Actividad reciente</h6>
                <ul id="logActivity" class="list-group list-group-flush small" style="max-height:280px; overflow:auto;">
                  </ul>
              </div>

              <!-- Filtro r√°pido eliminado -->
            </div>

          </div>
        </section>

        <!-- ========================================
             SECCI√ìN: DISTRIBUIR EQUIPOS (nueva pesta√±a)
        ========================================= -->
        <section id="distribuir-equipos" class="tab-section">
          <div class="card p-3">
            <h4 class="mb-3">Distribuci√≥n de Equipos</h4>
            <p class="text-muted">Traslada equipos de rescate entre ubicaciones.</p>

            <div class="row g-3">
              <div class="col-md-4">
                <label class="form-label">Ubicaci√≥n Origen</label>
                <select id="eq_dist_origen" class="form-select form-select-sm">
                  <option value="">Cargando...</option>
                </select>
              </div>

              <div class="col-md-4">
                <label class="form-label">Equipo</label>
                <select id="eq_dist_equipo" class="form-select form-select-sm" disabled>
                  <option value="">Selecciona origen primero</option>
                </select>
              </div>

              <div class="col-md-2">
                <label class="form-label">Cantidad</label>
                <input id="eq_dist_cantidad" type="number" class="form-control form-control-sm" min="1" value="1" />
              </div>

              <div class="col-md-4">
                <label class="form-label">Ubicaci√≥n Destino</label>
                <select id="eq_dist_destino" class="form-select form-select-sm">
                  <option value="">Cargando...</option>
                </select>
              </div>

              <div class="col-12 mt-2">
                <button id="btn-trasladar-equipo" class="btn btn-primary">Trasladar Equipo</button>
              </div>
            </div>
          </div>
          <!-- Tabla de equipos (lista similar a la de recursos) -->
          <div class="card p-3 mt-3">
            <h5>Equipos Registrados</h5>
            <div class="table-responsive">
              <table class="table table-sm table-striped" id="tabla-equipos">
                <thead>
                  <tr>
                    <th>Tipo</th>
                    <th>Miembros</th>
                    <th>Ubicaci√≥n</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                  </tr>
                </thead>
                <tbody>
                  <tr><td colspan="5" class="text-center text-muted">Cargando equipos...</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- ... (Secci√≥n 'panel-admin' sin cambios) ... -->
        <section id="panel-admin" class="tab-section">
          <!-- ... -->
           <div class="card p-3">
            <h5>Panel de Administraci√≥n</h5>
            <p class="small-muted">Crear/editar recursos, asignar a zonas, gestionar equipos de rescate.</p>

            <div class="row g-3">
              <div class="col-md-6">
                <h6>Crear Recurso</h6>
                <form id="form-create-resource">
                  <div class="mb-2">
                    <label class="form-label">Nombre</label>
                    <input required id="r_nombre" class="form-control form-control-sm" />
                  </div>
                  <div class="mb-2">
                    <label class="form-label">Tipo</label>
                    <select id="r_tipo" class="form-select form-select-sm">
                      <option value="ALIMENTO">Alimento</option>
                      <option value="MEDICINA">Medicina</option>
                      <option value="EQUIPO_RESCATE">Equipo rescate</option>
                      <option value="AGUA">Agua</option>
                      <option value="COMBUSTIBLE">Combustible</option>
                    </select>
                  </div>
                  <div class="mb-2">
                    <label class="form-label">Cantidad</label>
                    <input id="r_cantidad" type="number" class="form-control form-control-sm" value="1" />
                  </div>
                  <div class="mb-2">
                    <label class="form-label">Ubicaci√≥n de Destino</label>
                    <select required id="r_ubicacion_select" class="form-select form-select-sm">
                      <option value="">Cargando ubicaciones...</option>
                    </select>
                  </div>
                  <div class="d-grid">
                    <button class="btn btn-success btn-sm" type="submit">Crear Recurso</button>
                  </div>
                </form>
              </div>

              <div class="col-md-6">
                <h6>Equipos de Rescate</h6>
                <form id="form-create-team">
                  <div class="mb-2">
                    <label class="form-label">Nombre</label>
                    <input id="e_nombre" class="form-control form-control-sm" />
                  </div>
                  <div class="mb-2">
                    <label class="form-label">Tipo</label>
                    <select id="e_tipo" class="form-select form-select-sm">
                      <option value="BOMBEROS">Bomberos</option>
                      <option value="MEDICOS">M√©dicos</option>
                      <option value="POLICIA">Polic√≠a</option>
                      <option value="VOLUNTARIOS">Voluntarios</option>
                    </select>
                  </div>
                  <div class="mb-2">
                    <label class="form-label">Miembros</label>
                    <input id="e_miembros" type="number" value="5" class="form-control form-control-sm" />
                  </div>
                    <div class="mb-2">
                      <label class="form-label">Ubicaci√≥n</label>
                      <select id="e_ubicacion_select" class="form-select form-select-sm">
                        <option value="">Selecciona una ubicaci√≥n (opcional)</option>
                      </select>
                      <small class="text-muted">Asignar el equipo directamente a una ubicaci√≥n al crearlo</small>
                    </div>
                  <div class="d-grid">
                    <button class="btn btn-primary btn-sm" id="btn-create-team" type="button">Crear Equipo</button>
                  </div>
                </form>
              </div>
            </div>

            <hr>

            <h6 class="d-none">Registrar Ubicaci√≥n</h6>
            <form id="form-create-ubicacion" class="row g-2 d-none">
              <div class="col-md-4">
                <label class="form-label">Nombre</label>
                <input id="u_nombre" required class="form-control form-control-sm" placeholder="Ej: Zona Norte" />
              </div>
              <div class="col-md-4">
                <label class="form-label">Tipo</label>
                <select id="u_tipo" class="form-select form-select-sm">
                  <option value="URBANA">Urbana</option>
                  <option value="RURAL">Rural</option>
                </select>
              </div>
              <div class="col-md-2">
                <label class="form-label">Lat</label>
                <input id="u_lat" type="number" step="0.0001" class="form-control form-control-sm" placeholder="4.65" />
              </div>
              <div class="col-md-2">
                <label class="form-label">Lng</label>
                <input id="u_lng" type="number" step="0.0001" class="form-control form-control-sm" placeholder="-74.05" />
              </div>
              <div class="col-md-4">
                <label class="form-label">Nivel de Riesgo</label>
                <select id="u_nivelRiesgo" class="form-select form-select-sm">
                  <option value="BAJO">Bajo</option>
                  <option value="MEDIO">Medio</option>
                  <option value="ALTO">Alto</option>
                  <option value="CRITICO">Cr√≠tico</option>
                </select>
              </div>
              <div class="col-12 d-grid">
                <button class="btn btn-success btn-sm mt-2" type="submit">Crear Ubicaci√≥n</button>
              </div>
            </form>

            <hr>

            <h6 class="mt-3">Listado de Recursos</h6>
            <div class="table-responsive">
              <table class="table table-sm" id="tabla-recursos">
                <thead>
                  <tr>
                    <th>Nombre</th>
                    <th>Tipo</th>
                    <th>Cantidad</th>
                    <th>Disponibilidad</th>
                    <th>Acciones</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>

            <h6 class="mt-3">Listado de Equipos de Rescate</h6>
            <div class="table-responsive mb-3">
              <table class="table table-sm" id="tabla-equipos">
                <thead>
                  <tr>
                    <th>Tipo / Nombre</th>
                    <th>Miembros</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>

            

            <h6 class="mt-3">Listado de Ubicaciones</h6>
            <div class="table-responsive">
              <table class="table table-sm" id="tabla-ubicaciones">
                <thead>
                  <tr>
                    <th>Nombre</th>
                    <th>Tipo</th>
                    <th>Longitud</th>
                    <th>Latitud</th>
                    <th>Nivel de Riesgo</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>

          </div>
        </section>

        <!-- ... (Secci√≥n 'crear-ubicacion' sin cambios) ... -->
        <section id="crear-ubicacion" class="tab-section">
          <!-- ... -->
          <h4 class="mb-3">Crear Ubicaci√≥n</h4>
          <p class="text-muted">Haz clic en el mapa para seleccionar las coordenadas.</p>

          <div class="row g-2 mb-3">
            <div class="col-md-4">
              <label class="form-label">Nombre</label>
              <input id="cu_nombre" class="form-control form-control-sm" placeholder="Ej: Punto Seguro" />
            </div>

            <div class="col-md-4">
              <label class="form-label">Tipo</label>
              <select id="cu_tipo" class="form-select form-select-sm">
                <option value="URBANA">Urbana</option>
                <option value="RURAL">Rural</option>
              </select>
            </div>

            <div class="col-md-2">
              <label class="form-label">Latitud</label>
              <input id="cu_lat" class="form-control form-control-sm" readonly />
            </div>

            <div class="col-md-2">
              <label class="form-label">Longitud</label>
              <input id="cu_lng" class="form-control form-control-sm" readonly />
            </div>

            <div class="col-md-4 mt-2">
              <label class="form-label">Nivel de Riesgo</label>
              <select id="cu_riesgo" class="form-select form-select-sm">
                <option value="BAJO">Bajo</option>
                <option value="MEDIO">Medio</option>
                <option value="ALTO">Alto</option>
                <option value="CRITICO">Cr√≠tico</option>
              </select>
            </div>

            <div class="col-md-4 mt-2">
              <label class="form-label">Personas en la ubicaci√≥n</label>
              <input id="cu_personas" class="form-control form-control-sm" type="number" min="0" placeholder="Ej: 150" />
            </div>

            <div class="col-md-12 mt-2">
              <div id="map-crear-ubicacion"></div>
            </div>

            <div class="col-12 d-grid mt-3">
              <button class="btn btn-primary btn-sm" id="cu_guardar">Guardar Ubicaci√≥n</button>
            </div>
          </div>
        </section>

        <!-- ... (Secci√≥n 'crear-ruta' sin cambios) ... -->
        <section id="crear-ruta" class="tab-section">
          <!-- ... -->
           <h4 class="mb-3">Crear Ruta</h4>
          <p class="text-muted">Selecciona dos puntos en el mapa para trazar la ruta.</p>

          <div class="row g-2 mb-3">

            <div class="col-12">
              <div id="map-crear-ruta" style="height:700px; border-radius:8px;"></div>
            </div>

            <div class="col-md-6 d-grid mt-3">
              <button class="btn btn-danger btn-sm" id="cr_limpiar">Limpiar selecci√≥n</button>
            </div>

            <div class="col-md-6 d-grid mt-3">
              <button class="btn btn-success btn-sm" id="cr_guardar">Guardar Ruta</button>
            </div>

          </div>
        </section>
        
        <!-- 4. A√ëADIR NUEVA SECCI√ìN HTML PARA ELIMINAR -->
        <section id="eliminar-ubicacion" class="tab-section">
          <h4 class="mb-3">Eliminar Ubicaci√≥n</h4>
          <p class="text-muted">Haz clic en un punto del mapa para seleccionarlo y luego presiona "Eliminar". Esta acci√≥n no se puede deshacer.</p>
          
          <div class="alert alert-info" id="info-eliminar-ubicacion">
            Ninguna ubicaci√≥n seleccionada.
          </div>
          
          <div id="map-eliminar-ubicacion" class="mb-3"></div>
          
          <button class="btn btn-danger" id="btn-eliminar-ubicacion" disabled>
            <i class="fa fa-trash"></i> Eliminar Ubicaci√≥n Seleccionada
          </button>
        </section>

        <!-- ========================================
             SECCI√ìN: DISTRIBUIR RECURSOS
        ========================================= -->
        <section id="distribuir-recursos" class="tab-section">
          <h4 class="mb-3">Distribuci√≥n de Recursos</h4>
          <p class="text-muted">Transfiere recursos desde ubicaciones con excedente hacia zonas necesitadas.</p>

          <div class="row g-3">
            
            <!-- Formulario Manual -->
            <div class="col-md-6">
              <div class="card p-3">
                <h5>Distribuci√≥n Manual</h5>
                
                <form id="form-distribucion-manual">
                  <div class="mb-2">
                    <label class="form-label">Ubicaci√≥n Origen</label>
                    <select id="dist_origen" class="form-select form-select-sm" required>
                      <option value="">Cargando...</option>
                    </select>
                  </div>

                  <div class="mb-2">
                    <label class="form-label">Ubicaci√≥n Destino</label>
                    <select id="dist_destino" class="form-select form-select-sm" required>
                      <option value="">Cargando...</option>
                    </select>
                  </div>

                  <div class="mb-2">
                    <label class="form-label">Recurso a Transferir</label>
                    <select id="dist_recurso" class="form-select form-select-sm" required disabled>
                      <option value="">Selecciona primero un origen</option>
                    </select>
                  </div>

                  <!-- Equipo transfer removed from this form; use 'Distribuir Equipos' tab -->

                  <div class="mb-2">
                    <label class="form-label">Cantidad</label>
                    <input id="dist_cantidad" type="number" class="form-control form-control-sm" min="1" required />
                    <small class="text-muted">Disponible: <span id="dist_disponible">-</span></small>
                  </div>

                  <button type="submit" class="btn btn-success w-100">
                    <i class="fa fa-truck"></i> Ejecutar Distribuci√≥n
                  </button>
                </form>
              </div>
            </div>

            <!-- Panel de Sugerencias -->
            <div class="col-md-6">
              <div class="card p-3">
                <h5>Sugerencias Autom√°ticas</h5>
                <p class="small text-muted">El sistema priorizar√° por urgencia y proximidad.</p>

                <div class="mb-2">
                  <label class="form-label">Destino Cr√≠tico</label>
                  <select id="dist_sugerencia_destino" class="form-select form-select-sm">
                    <option value="">Cargando...</option>
                  </select>
                </div>

                <button id="btn-calcular-sugerencias" class="btn btn-primary w-100 mb-3">
                  <i class="fa fa-magic"></i> Calcular Sugerencias
                </button>

                <div id="sugerencias-container" style="max-height: 300px; overflow-y: auto;">
                  <p class="text-muted small text-center">Selecciona un destino y haz clic en "Calcular"</p>
                </div>
              </div>
            </div>

          </div>

          <!-- equipos distribution was moved to its own tab -->

          <!-- Historial de Distribuciones -->
          <div class="card p-3 mt-3">
            <h5>Historial de Distribuciones</h5>
            <div class="table-responsive">
              <table class="table table-sm table-striped" id="tabla-historial-distribuciones">
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Fecha</th>
                    <th>Origen</th>
                    <th>Destino</th>
                    <th>Recurso</th>
                    <th>Cantidad</th>
                    <th>Distancia (km)</th>
                    <th>Estado</th>
                    <th>Responsable</th>
                  </tr>
                </thead>
                <tbody>
                  <!-- Se llena din√°micamente -->
                </tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- ========================================
             SECCI√ìN: REPORTES Y ESTAD√çSTICAS
        ========================================= -->
        <section id="reportes" class="tab-section">
          <h4 class="mb-3">Reportes y Estad√≠sticas</h4>
          <p class="text-muted">An√°lisis general del sistema de recursos.</p>

          <div class="row g-3">
            
            <!-- Indicadores Clave -->
            <div class="col-md-3">
              <div class="card p-3 text-center">
                <h6>Total Distribuciones</h6>
                <p id="stat_total_dist" class="display-6 m-0">-</p>
              </div>
            </div>

            <div class="col-md-3">
              <div class="card p-3 text-center">
                <h6>Recursos Distribuidos</h6>
                <p id="stat_recursos_dist" class="display-6 m-0">-</p>
              </div>
            </div>

            <div class="col-md-3">
              <div class="card p-3 text-center">
                <h6>Distancia Total (km)</h6>
                <p id="stat_distancia" class="display-6 m-0">-</p>
              </div>
            </div>

            <div class="col-md-3">
              <div class="card p-3 text-center">
                <h6>Zonas Cr√≠ticas</h6>
                <p id="stat_zonas_criticas" class="display-6 m-0">-</p>
              </div>
            </div>

          </div>

          <!-- Gr√°ficos -->
          <div class="row g-3 mt-3">
            
            <div class="col-md-6">
              <div class="card p-3">
                <h5>Recursos por Zona</h5>
                <canvas id="chart-recursos-zona" style="max-height: 300px;"></canvas>
              </div>
            </div>

            <div class="col-md-6">
              <div class="card p-3">
                <h5>Distribuci√≥n de Riesgos</h5>
                <canvas id="chart-riesgos" style="max-height: 300px;"></canvas>
              </div>
            </div>

          </div>

          <!-- Tabla Detallada -->
          <div class="card p-3 mt-3">
            <h5>Reporte Detallado de Recursos</h5>
            
            <button id="btn-exportar-csv" class="btn btn-sm btn-outline-success mb-2">
              <i class="fa fa-download"></i> Exportar CSV
            </button>

            <div class="table-responsive">
              <table class="table table-sm table-striped" id="tabla-reporte-recursos">
                <thead>
                  <tr>
                    <th>Ubicaci√≥n</th>
                    <th>Tipo Recurso</th>
                    <th>Disponibles</th>
                    <th>Necesarios</th>
                    <th>Nivel Riesgo</th>
                    <th>Balance</th>
                  </tr>
                </thead>
                <tbody>
                  <!-- Se llena din√°micamente -->
                </tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- ========================================
             SECCI√ìN: CARGA INICIAL DE DATOS
        ========================================= -->
        <section id="carga-datos" class="tab-section">
          <div class="card p-3">
            <h5>Carga de datos iniciales</h5>
            <p class="small-muted">Sube un archivo JSON con zonas, rutas y recursos, o pulsa el bot√≥n para cargar datos de prueba.</p>

            <div class="mb-3">
              <input type="file" id="fileLoad" accept=".json" class="form-control form-control-sm" />
            </div>
            
            <div class="d-flex gap-2">
              <button id="btn-load-sample" class="btn btn-primary btn-sm">
                <i class="fa fa-database"></i> Cargar datos de muestra
              </button>
              <button id="btn-load-file" class="btn btn-outline-secondary btn-sm">
                <i class="fa fa-upload"></i> Cargar desde archivo
              </button>
              <button id="btn-clear-data" class="btn btn-outline-danger btn-sm">
                <i class="fa fa-trash"></i> Limpiar todos los datos
              </button>
            </div>
            
            <hr>
            
            <h6 class="mt-3">Datos de Muestra Incluidos:</h6>
            <ul class="small">
              <li><strong>4 Ubicaciones:</strong> Zona Norte, Zona Sur, Zona Este, Zona Oeste</li>
              <li><strong>Recursos:</strong> Agua Potable (100), Kit M√©dico (50), Alimentos (200)</li>
              <li><strong>Rutas:</strong> Conexiones entre zonas con distancias calculadas</li>
              <li><strong>Niveles de Riesgo:</strong> CRITICO, ALTO, MEDIO, BAJO</li>
            </ul>
            
            <div class="alert alert-info mt-3">
              <strong>üí° Recomendaci√≥n:</strong> Carga los datos de muestra antes de usar "Distribuir Recursos" o "Reportes".
            </div>
          </div>
        </section>

      </main>
    </div>
  </div>

  <!-- ... (Modal de login sin cambios) ... -->
  <div class="modal fade" id="modalLogin" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <form id="form-login">
          <div class="modal-header">
            <h5 class="modal-title">Iniciar sesi√≥n</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="mb-2">
              <label class="form-label">Correo</label>
              <input id="login_email" required class="form-control form-control-sm" type="email" />
            </div>
            <div class="mb-2">
              <label class="form-label">Contrase√±a</label>
              <input id="login_password" required class="form-control form-control-sm" type="password" />
            </div>
            <div class="form-check">
              <input id="login_remember" class="form-check-input" type="checkbox" />
              <label class="form-check-label">Recordarme</label>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancelar</button>
            <button class="btn btn-primary btn-sm" type="submit">Entrar</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.7.5/dist/sockjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@stomp/stompjs@7.0.0/bundles/stomp.umd.min.js"></script>

  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />

  <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script> 

  <!-- Font Awesome (ya lo pusimos en el head, pero por si acaso) -->
  <!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"> -->

  <script>
    const apiBase = document.getElementById('backendUrl').textContent;
    const wsBase = document.getElementById('wsUrl').textContent;

    // Navegaci√≥n de pesta√±as (sidebar)
    document.querySelectorAll('.list-group .list-group-item').forEach(a => {
      a.addEventListener('click', (e) => {
        e.preventDefault();
        if (!a.dataset.tab) return;

        document.querySelectorAll('.list-group .list-group-item')
          .forEach(x => x.classList.remove('active'));
        a.classList.add('active');

        const tab = a.getAttribute('data-tab');

        document.querySelectorAll('.tab-section')
          .forEach(s => s.classList.remove('active'));
        document.getElementById(tab).classList.add('active');

        // ========== L√ìGICA ESPEC√çFICA POR PESTA√ëA ==========
        
        if (tab === "panel-admin") {
          populateLocationDropdown(); 
          loadRecursos();
          loadZonas();
          loadEquipos();
        }

        // Si se entra al panel-admin, comprobar sesi√≥n y abrir modal de login si no est√° autenticado
        if (tab === "panel-admin") {
          (async () => {
            try {
              const chk = await fetch(apiBase + '/session/check');
              if (!chk.ok) {
                // Mostrar modal de login
                try {
                  const loginModalEl = document.getElementById('modalLogin');
                  if (loginModalEl) {
                    const modal = new bootstrap.Modal(loginModalEl);
                    modal.show();
                  }
                } catch (e) {
                  console.warn('No se pudo abrir modal de login autom√°ticamente:', e);
                }
              }
            } catch (e) {
              console.warn('Error comprobando sesi√≥n:', e);
            }
          })();
        }

        if (tab === "crear-ubicacion") {
          setTimeout(() => {
            if (!cuMap) {
              cuMap = L.map("map-crear-ubicacion").setView([4.65, -74.1], 12);
              L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
                maxZoom: 19
              }).addTo(cuMap);
              cuMap.on("click", (e) => {
                if (cuMarker) cuMap.removeLayer(cuMarker);
                cuMarker = L.marker(e.latlng).addTo(cuMap);
                cu_lat.value = e.latlng.lat.toFixed(6);
                cu_lng.value = e.latlng.lng.toFixed(6);
              });
            }
            cuMap.invalidateSize();
          }, 100);
        }

        if (tab === "crear-ruta") {
          setTimeout(() => {
            if (!crMap) {
              initCrearRutaMap();
            } else {
              crMap.invalidateSize();
            }
          }, 50);
        }

        if (tab === "eliminar-ubicacion" && !delMapInitialized) {
          setTimeout(() => {
            initEliminarUbicacionMap();
            delMapInitialized = true;
          }, 100);
        } else if (tab === "eliminar-ubicacion") {
          setTimeout(() => delMap.invalidateSize(), 150);
        }

        // ========== NUEVAS PESTA√ëAS ==========
        
        if (tab === "distribuir-recursos") {
          setTimeout(() => {
            cargarUbicacionesParaDistribucion();
            cargarHistorialDistribuciones();
          }, 100);
        }

        // Cuando se abre la pesta√±a DISTRIBUIR EQUIPOS, poblar selects y cargar equipos
        if (tab === "distribuir-equipos") {
          setTimeout(() => {
            populateLocationDropdown();
            cargarUbicacionesParaDistribucion();
            loadEquipos();
          }, 100);
        }

        if (tab === "reportes") {
          setTimeout(() => {
            cargarReportes();
          }, 100);
        }
      });
    });

// ... (mapa crear ubicacion, guardar ubicacion, mapa crear ruta, etc. se mantienen igual) ...
//mapa bueno
    // ----- MAPA CREAR UBICACI√ìN -----
  let cuMap = L.map("map-crear-ubicacion").setView([4.65, -74.1], 12);

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 19
  }).addTo(cuMap);

  let cuMarker = null;

  cuMap.on("click", function (e) {
    if (cuMarker) cuMap.removeLayer(cuMarker);
    cuMarker = L.marker(e.latlng).addTo(cuMap);

    document.getElementById("cu_lat").value = e.latlng.lat.toFixed(6);
    document.getElementById("cu_lng").value = e.latlng.lng.toFixed(6);
  });

  // ----- GUARDAR UBICACI√ìN -----
  document.getElementById("cu_guardar").addEventListener("click", async () => {

    const payload = {
      nombre: document.getElementById("cu_nombre").value,
      tipo: document.getElementById("cu_tipo").value,
      lat: document.getElementById("cu_lat").value,
      lng: document.getElementById("cu_lng").value,
      nivelRiesgo: document.getElementById("cu_riesgo").value,
      personasAfectadas: parseInt(document.getElementById("cu_personas").value) || 0
    };


    if (!payload.lat || !payload.lng) {
      Swal.fire('Error', 'Selecciona un punto en el mapa.', 'warning');
      return;
    }

    try {
        const res = await fetch(apiBase + '/zonas', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

      // leer respuesta como texto o json
      const text = await res.text();
      let body = null;

      try {
        body = JSON.parse(text);
      } catch {
        body = { message: text };
     }

      if (res.status === 409) {
        Swal.fire('Duplicado', body.message || 'Zona ya registrada.', 'warning');
        return;
      }

      if (!res.ok) {
        Swal.fire('Error', body.message || 'No se pudo guardar la ubicaci√≥n', 'error');
        return;
      }

      addLog('Ubicaci√≥n creada: ' + (body.nombre || payload.nombre));
      loadUbicaciones();
      loadZonas();

      // Limpiar formulario
      document.getElementById("cu_nombre").value = '';
      document.getElementById("cu_tipo").value = 'URBANA';
      document.getElementById("cu_lat").value = '';
      document.getElementById("cu_lng").value = '';
      document.getElementById("cu_riesgo").value = 'BAJO';
      document.getElementById("cu_personas").value = '';

      Swal.fire('√âxito', 'Ubicaci√≥n creada correctamente.', 'success');

    } catch (error) {
      console.error('Error al guardar ubicaci√≥n:', error);
      Swal.fire('Error', 'Error al crear la ubicaci√≥n: ' + error.message, 'error');
    }

  });
// =============================
  //    MAPA PARA CREAR RUTA
  // =============================

let crMap = null;
let crMarkers = [];        // todos los puntos cargados
let crSelected = [];       // los puntos seleccionados (max 2)

// 'crLine' es el CONTROLADOR de ruteo
let crLine = null; 
// 'crRouteSummary' guardar√° la distancia
let crRouteSummary = null;

async function initCrearRutaMap() {
  crMap = L.map("map-crear-ruta").setView([4.65, -74.1], 12);

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 19
  }).addTo(crMap);

  const ubicaciones = await loadUbicacionesParaRutas();
  const bounds = [];
  
  crMarkers.forEach(m => crMap.removeLayer(m));
  crMarkers = [];
  limpiarRuta(); // Limpiar la selecci√≥n

  ubicaciones.forEach(u => {
    if (u.lat && u.lng) {
      const marker = L.marker([u.lat, u.lng])
        .addTo(crMap)
        .bindPopup(`<b>${u.nombre}</b>`);

      marker.data = u; 
      marker.on("click", () => selectPunto(marker));
      crMarkers.push(marker);
      bounds.push([u.lat, u.lng]);
    }
  });

  if (bounds.length > 0) {
    crMap.fitBounds(bounds, { padding: [50, 50] });
  }

  setTimeout(() => crMap.invalidateSize(), 150);
}

// Helper para cargar ubicaciones
async function loadUbicacionesParaRutas() {
  try {
    const res = await fetch(apiBase + "/zonas");
    if (!res.ok) {
      console.error("Error cargando ubicaciones:", res.status);
      return [];
    }
    return await res.json();
  } catch (error) {
    console.error("Error en fetch:", error);
    return [];
  }
}

// -----------------------------
// Manejo de selecci√≥n de puntos
// -----------------------------
function selectPunto(marker) {
  if (crSelected.includes(marker)) return;

  if (crSelected.length === 2) {
    Swal.fire("M√°ximo 2 puntos", "Ya has seleccionado dos puntos. Limpia la selecci√≥n primero.", "info");
    return;
  }

  crSelected.push(marker);
  
  // Dibujar ruta si ya hay dos puntos
  if (crSelected.length === 2) {
    dibujarRuta();
  }
}

// -----------------------------
// Dibujar la L√çNEA DE RUTA (CORREGIDO)
// -----------------------------
function dibujarRuta() {
  const p1 = crSelected[0].getLatLng();
  const p2 = crSelected[1].getLatLng();

  // borrar ruta previa si existe
  if (crLine) {
    crMap.removeControl(crLine);
    crLine = null;
    crRouteSummary = null;
  }

  crLine = L.Routing.control({
    waypoints: [p1, p2],
    show: false, 
    routeWhileDragging: false, 
    addWaypoints: false, 
    
    lineOptions: {
      styles: [{color: 'blue', opacity: 0.8, weight: 6}]
    }
  }).addTo(crMap);

  // Escuchar cuando la ruta se calcula para obtener la distancia
  crLine.on('routesfound', function(e) {
      if (e.routes && e.routes.length > 0) {
          crRouteSummary = e.routes[0].summary;
          console.log(`Ruta encontrada: ${crRouteSummary.totalDistance} metros.`);
      }
  });
}

// -----------------------------
// Limpiar selecci√≥n (CORREGIDO)
// -----------------------------
function limpiarRuta() {
  crSelected = [];
  crRouteSummary = null;

  if (crLine) {
    crMap.removeControl(crLine);
    crLine = null;
  }
}

// Conectar bot√≥n "Limpiar"
document.getElementById("cr_limpiar").addEventListener("click", limpiarRuta);


// ---------------------------------
//  L√ìGICA DE GUARDADO (Sin cambios)
// ---------------------------------
document.getElementById("cr_guardar").addEventListener("click", guardarRuta);

async function guardarRuta() {
  if (crSelected.length !== 2) {
    Swal.fire("Error", "Debes seleccionar exactamente dos puntos (origen y destino) en el mapa.", "warning");
    return;
  }
  
  if (!crRouteSummary) {
    Swal.fire("Espera", "La ruta a√∫n se est√° calculando. Int√©ntalo de nuevo en un segundo.", "info");
    return;
  }

  const markerOrigen = crSelected[0];
  const markerDestino = crSelected[1];
  const distanciaKm = crRouteSummary.totalDistance / 1000;

  const payload = {
    origen: { id: markerOrigen.data.id ,lat: markerOrigen.data.lat, lng: markerOrigen.data.lng, nombre: markerOrigen.data.nombre },
    destino: { id: markerDestino.data.id ,lat: markerDestino.data.lat, lng: markerDestino.data.lng, nombre: markerDestino.data.nombre},
  };

  console.log("Enviando ruta:", payload);

  try {
    const res = await fetch(apiBase + '/rutas/crear', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    if (res.ok) {
      Swal.fire(
        '¬°Ruta Creada!',
        `Se guard√≥ la ruta entre ${markerOrigen.data.nombre} y ${markerDestino.data.nombre} (${distanciaKm.toFixed(2)} km).`, // Mostramos la distancia calculada
        'success'
      );
      limpiarRuta();
    } else {
      const errorMsg = await res.text();
      Swal.fire('Error al guardar', `No se pudo crear la ruta: ${errorMsg}`, 'error');
    }

  } catch (error) {
    console.error('Error en fetch al guardar ruta:', error);
    Swal.fire('Error de Red', 'No se pudo conectar con el servidor.', 'error');
  }
}

    // --- 6. A√ëADIR NUEVAS VARIABLES GLOBALES Y FUNCIONES PARA EL MAPA DE BORRADO ---

    let delMap = null; // El mapa de eliminar
    let delMapMarkers = []; // Array de marcadores en el mapa
    let delMapSelectedMarker = null; // El marcador que est√° seleccionado
    let delMapInitialized = false; // Flag para saber si ya se inicializ√≥

    // Iconos personalizados para la selecci√≥n
    const defaultIcon = L.icon({
        iconUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png',
        shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
        iconSize: [25, 41], iconAnchor: [12, 41]
    });
    
    // Icono rojo para destacar la selecci√≥n
    const redIcon = L.icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
        shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
        iconSize: [25, 41], iconAnchor: [12, 41]
    });


    /**
     * Inicializa el mapa en la pesta√±a "Eliminar Ubicaci√≥n"
     */
    async function initEliminarUbicacionMap() {
      if (delMap) delMap.remove(); // Limpiar mapa anterior si existe
      
      delMap = L.map("map-eliminar-ubicacion").setView([4.65, -74.1], 12);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(delMap);

      // Limpiar marcadores antiguos
      delMapMarkers.forEach(m => m.remove());
      delMapMarkers = [];
      delMapSelectedMarker = null;
      document.getElementById('btn-eliminar-ubicacion').disabled = true;
      document.getElementById('info-eliminar-ubicacion').textContent = 'Ninguna ubicaci√≥n seleccionada.';

      // Reutilizamos la funci√≥n que carga ubicaciones para el mapa de rutas
      const ubicaciones = await loadUbicacionesParaRutas(); 
      const bounds = [];

      ubicaciones.forEach(u => {
        if (u.lat && u.lng) {
          const marker = L.marker([u.lat, u.lng], {
            icon: defaultIcon // Empezar con el icono azul normal
          }).addTo(delMap);
          
          marker.data = u; // Guardar toda la data de la ubicaci√≥n
          marker.on("click", () => handleMarkerSelectForDelete(marker));
          delMapMarkers.push(marker);
          bounds.push([u.lat, u.lng]);
        }
      });

      if (bounds.length > 0) {
        delMap.fitBounds(bounds, { padding: [50, 50] });
      }
    }

    /**
     * Se llama cuando el usuario hace clic en un marcador en el mapa de eliminar.
     */
    function handleMarkerSelectForDelete(marker) {
      // 1. Resetear el marcador anteriormente seleccionado (si existe)
      if (delMapSelectedMarker) {
        delMapSelectedMarker.setIcon(defaultIcon);
      }

      // 2. Guardar y destacar el nuevo marcador
      // 2. Guardar y destacar el nuevo marcador
      delMapSelectedMarker = marker;
      delMapSelectedMarker.setIcon(redIcon); // Ponerlo en rojo
      delMapSelectedMarker.setZIndexOffset(1000); // <-- CORRECCI√ìN (Usar setZIndexOffset para traer al frente)

      // 3. (Para depurar) Imprimir la data en consola, como pediste
      console.log('Ubicaci√≥n seleccionada (guardada):', delMapSelectedMarker.data);

      // 4. Actualizar UI (texto y bot√≥n)
      document.getElementById('info-eliminar-ubicacion').textContent = 
        `Seleccionado: ${marker.data.nombre} (ID: ${marker.data.id})`;
      document.getElementById('btn-eliminar-ubicacion').disabled = false;
    }
    /**
     * Listener para el bot√≥n de eliminar
     */
    document.getElementById('btn-eliminar-ubicacion').addEventListener('click', async () => {
      if (!delMapSelectedMarker) {
        Swal.fire('Error', 'No hay ninguna ubicaci√≥n seleccionada.', 'warning');
        return;
      }

      const id = delMapSelectedMarker.data.id;
      const nombre = delMapSelectedMarker.data.nombre;

      // Confirmaci√≥n de SweetAlert
      const result = await Swal.fire({
        title: `¬øEliminar "${nombre}"?`,
        text: "¬°No podr√°s revertir esto! Se eliminar√°n tambi√©n todas las rutas conectadas a esta ubicaci√≥n.",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'S√≠, ¬°eliminar!',
        cancelButtonText: 'Cancelar'
      });

      if (result.isConfirmed) {
        try {
          // Petici√≥n DELETE al backend
          const response = await fetch(`${apiBase}/zonas/${id}`, {
            method: 'DELETE'
          });

          const responseText = await response.text();

          if (!response.ok) {
            throw new Error(responseText || 'Error del servidor');
          }

          Swal.fire('¬°Eliminado!', responseText, 'success');
          
          // Quitar el marcador del mapa
          delMapSelectedMarker.remove();
          
          // Resetear estado
          delMapSelectedMarker = null;
          document.getElementById('btn-eliminar-ubicacion').disabled = true;
          document.getElementById('info-eliminar-ubicacion').textContent = 'Ninguna ubicaci√≥n seleccionada.';
          addLog(`Ubicaci√≥n eliminada: ${nombre} (ID: ${id})`);
          
          // Recargar las otras tablas para que reflejen el cambio
          loadUbicaciones();
          loadZonas();

        } catch (error) {
          console.error('Error al eliminar:', error);
          Swal.fire('Error', `No se pudo eliminar: ${error.message}`, 'error');
        }
      }
    });

    // --- FIN DE LA L√ìGICA DE BORRADO ---


    let stompClient = null;
    function connectWebSocket() {
      const httpUrl = wsBase.replace('ws://', 'http://'); // adaptado para SockJS
      const socket = new SockJS(httpUrl);
      stompClient = StompJs.Stomp.over(socket);
      stompClient.connect({}, function (frame) {
        console.log('Connected: ' + frame);
        document.getElementById('wsStatus').textContent = 'WS: conectado';
        stompClient.subscribe('/topic/evacuaciones', function (message) {
          const payload = JSON.parse(message.body);
          addLog('Evacuaci√≥n recibida: ' + payload.ubicacion);
        });
      }, function (err) {
        console.error('STOMP error', err);
        document.getElementById('wsStatus').textContent = 'WS: error';
      });
    }

    // Log de acciones
    function addLog(text) {
      const li = document.createElement('li');
      li.className = 'list-group-item';
      li.textContent = '[' + new Date().toLocaleTimeString() + '] ' + text;
      const list = document.getElementById('logActivity');
      list.prepend(li);
    }

    // Pobla los dropdowns de ubicaciones en diferentes formularios (recurso, equipo, distribuci√≥n equipos)
    async function populateLocationDropdown() {
      try {
        const res = await fetch(apiBase + '/zonas');
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const ubicaciones = await res.json();

        // Selector para crear recurso
        const selectR = document.getElementById('r_ubicacion_select');
        if (selectR) {
          selectR.innerHTML = '<option value="">Selecciona una ubicaci√≥n</option>';
          ubicaciones.forEach(u => {
            const opt = document.createElement('option');
            opt.value = u.id;
            opt.textContent = `ID ${u.id}: ${u.nombre} (${u.nivelRiesgo})`;
            selectR.appendChild(opt);
          });
        }

        // Selector para crear equipo
        const selectE = document.getElementById('e_ubicacion_select');
        if (selectE) {
          selectE.innerHTML = '<option value="">Selecciona una ubicaci√≥n (opcional)</option>';
          ubicaciones.forEach(u => {
            const opt = document.createElement('option');
            opt.value = u.id;
            opt.textContent = `ID ${u.id}: ${u.nombre} (${u.nivelRiesgo})`;
            selectE.appendChild(opt);
          });
        }

        // Selects para distribuir equipos (origen/destino)
        const eqOrigen = document.getElementById('eq_dist_origen');
        const eqDestino = document.getElementById('eq_dist_destino');
        if (eqOrigen && eqDestino) {
          eqOrigen.innerHTML = '<option value="">Selecciona origen</option>';
          eqDestino.innerHTML = '<option value="">Selecciona destino</option>';
          ubicaciones.forEach(u => {
            const o1 = new Option(`${u.nombre} (ID: ${u.id})`, u.id);
            const o2 = new Option(`${u.nombre} (ID: ${u.id})`, u.id);
            eqOrigen.appendChild(o1);
            eqDestino.appendChild(o2);
          });
        }

      } catch (err) {
        console.error('Error en populateLocationDropdown:', err);
        // Mostrar mensaje de error en cualquier select existente
        ['r_ubicacion_select','e_ubicacion_select','eq_dist_origen','eq_dist_destino'].forEach(id => {
          const el = document.getElementById(id);
          if (el) el.innerHTML = '<option value="">Error al cargar ubicaciones</option>';
        });
      }
    }

    
    // Crear recurso
  // Reemplaza el manejador document.getElementById('form-create-resource').addEventListener('submit', (e) => {...})

document.getElementById('form-create-resource').addEventListener('submit', (e) => {
  e.preventDefault();
  const nombre = document.getElementById('r_nombre').value;
  const tipo = document.getElementById('r_tipo').value;
  const cantidad = +document.getElementById('r_cantidad').value;
  
  // ‚úÖ CAMBIO CLAVE: Leer el ID directamente del valor seleccionado
  const ubicacionId = document.getElementById('r_ubicacion_select').value; 

  if (!ubicacionId) {
    Swal.fire('Error', 'Debe seleccionar una ubicaci√≥n de destino.', 'warning');
    return;
  }
  
  // ‚úÖ PAYLOAD CORREGIDO: Usamos el ID del selector
  const payload = { 
    nombre, 
    tipo, 
    cantidad, 
    ubicacion: { id: +ubicacionId } // Convertir el string del selector a n√∫mero
  };

  fetch(apiBase + '/recursos', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  })
    .then(r => {
      if (!r.ok) {
        throw new Error(`HTTP error! status: ${r.status}`);
      }
      return r.json();
    })
    .then(data => {
      addLog('Recurso creado: ' + data.nombre + ' en Ubi ID: ' + ubicacionId);
      loadRecursos(); // Refresca la tabla de recursos
      Swal.fire('√âxito', 'Recurso creado y asignado.', 'success');
    })
    .catch(err => { 
      console.error(err); 
      addLog('Error creando recurso. Revisar backend.'); 
      Swal.fire('Error', 'Error al crear o asignar el recurso. Verifique la conexi√≥n.', 'error');
    });
});
    // Delegaci√≥n global para botones con data-action (incluye eliminar-equipo)
    document.addEventListener('click', (e) => {
      const btn = e.target.closest('button[data-action]');
      if (!btn) return;
      const action = btn.dataset.action;
      // Eliminar equipo
      if (action === 'eliminar-equipo') {
        const id = btn.dataset.id;
        Swal.fire({
          title: '¬øConfirmar eliminaci√≥n?',
          text: 'Este equipo ser√° eliminado permanentemente',
          icon: 'warning',
          showCancelButton: true,
          confirmButtonColor: '#d33',
          confirmButtonText: 'S√≠, eliminar'
        }).then(result => {
          if (result.isConfirmed) {
            fetch(apiBase + '/admin/equipos/' + id, { method: 'DELETE' })
              .then(r => {
                if (r.ok) {
                  Swal.fire('Eliminado', 'Equipo eliminado correctamente', 'success');
                  loadEquipos();
                } else {
                  Swal.fire('Error', 'No se pudo eliminar el equipo', 'error');
                }
              })
              .catch(err => {
                console.error('Error al eliminar equipo:', err);
                Swal.fire('Error', 'Error al eliminar el equipo', 'error');
              });
          }
        });
      }
    });

    // --- Listeners para distribuci√≥n de equipos (panel espec√≠fico) ---
    document.getElementById('eq_dist_origen')?.addEventListener('change', async (e) => {
      const origenId = e.target.value;
      const selectEquipo = document.getElementById('eq_dist_equipo');
      if (!origenId) { selectEquipo.innerHTML = '<option value="">Selecciona origen primero</option>'; selectEquipo.disabled = true; return; }
      try {
        const res = await fetch(apiBase + '/distribucion/equipos/' + origenId);
        if (!res.ok) { selectEquipo.innerHTML = '<option value="">Error cargando equipos</option>'; selectEquipo.disabled = true; return; }
        const list = await res.json();
        selectEquipo.innerHTML = '<option value="">Selecciona un equipo</option>';
        if (!list || list.length === 0) { selectEquipo.innerHTML = '<option value="">No hay equipos en esta ubicaci√≥n</option>'; selectEquipo.disabled = true; return; }
        list.forEach(eq => {
          const opt = new Option(`${eq.tipo} ‚Äî Miembros:${eq.miembros} (ID:${eq.idEquipo})`, eq.idEquipo);
          opt.setAttribute('data-miembros', eq.miembros);
          selectEquipo.appendChild(opt);
        });
        selectEquipo.disabled = false;
      } catch (err) {
        console.error('Error cargando equipos por ubicacion:', err);
        selectEquipo.innerHTML = '<option value="">Error cargando equipos</option>';
        selectEquipo.disabled = true;
      }
    });

    // Cuando se selecciona un equipo, limitar la cantidad seg√∫n miembros disponibles
    document.getElementById('eq_dist_equipo')?.addEventListener('change', (e) => {
      const sel = e.target;
      const qty = document.getElementById('eq_dist_cantidad');
      if (!sel || !qty) return;
      const selected = sel.options[sel.selectedIndex];
      const miembros = parseInt(selected?.getAttribute('data-miembros') || '0');
      qty.max = miembros > 0 ? miembros : 1;
      if (parseInt(qty.value) > qty.max) qty.value = qty.max;
    });

    document.getElementById('btn-trasladar-equipo')?.addEventListener('click', async () => {
      const equipoId = parseInt(document.getElementById('eq_dist_equipo').value);
      const destinoId = parseInt(document.getElementById('eq_dist_destino').value);
      const cantidad = parseInt(document.getElementById('eq_dist_cantidad')?.value) || null;
      if (!equipoId || !destinoId) { Swal.fire('Aviso', 'Selecciona origen, equipo y destino', 'warning'); return; }
      try {
        const body = { equipoId: equipoId, destinoId: destinoId };
        if (cantidad && cantidad > 0) body.cantidad = cantidad;
        const res = await fetch(apiBase + '/distribucion/trasladar-equipo', {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });
        if (!res.ok) { const txt = await res.text(); throw new Error(txt || ('HTTP ' + res.status)); }
        const moved = await res.json();
        Swal.fire('√âxito', `Equipo trasladado: ${moved.tipo} (ID:${moved.idEquipo})`, 'success');
        addLog(`Equipo trasladado: ID ${moved.idEquipo} a ubicacion ${destinoId}`);
        // refrescar selects y tablas
        cargarUbicacionesParaDistribucion();
        loadEquipos();
      } catch (err) {
        console.error('Error trasladando equipo (btn):', err);
        Swal.fire('Error', err.message || 'No se pudo trasladar equipo', 'error');
      }
    });
    // Bot√≥n crear equipo: construir payload y llamar al endpoint
    document.getElementById('btn-create-team')?.addEventListener('click', async () => {
      try {
        const nombre = document.getElementById('e_nombre').value;
        const tipoSelect = document.getElementById('e_tipo').value;
        const miembros = parseInt(document.getElementById('e_miembros').value) || 0;
        const tipo = (nombre && nombre.trim() !== '') ? nombre.trim() : tipoSelect;
        const ubicacionId = document.getElementById('e_ubicacion_select') ? document.getElementById('e_ubicacion_select').value : '';

        const payload = { tipo: tipo, miembros: miembros, estado: 'DISPONIBLE' };
        if (ubicacionId) payload.ubicacion = { id: +ubicacionId };

        const res = await fetch(apiBase + '/admin/equipos', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        if (res.status === 401 || res.status === 403) {
          Swal.fire('Sin sesi√≥n', 'Debes iniciar sesi√≥n como administrador para crear equipos.', 'warning');
          return;
        }

        if (!res.ok) {
          const txt = await res.text();
          throw new Error(txt || ('HTTP ' + res.status));
        }

        const saved = await res.json();
        addLog('Equipo creado: ' + (saved.tipo || tipo) + ' (miembros: ' + saved.miembros + ')');
        Swal.fire('√âxito', 'Equipo de rescate creado correctamente.', 'success');
        // Limpiar formulario
        document.getElementById('e_nombre').value = '';
        document.getElementById('e_tipo').value = 'BOMBEROS';
        document.getElementById('e_miembros').value = '5';
        if (document.getElementById('e_ubicacion_select')) document.getElementById('e_ubicacion_select').value = '';
        // Recargar lista de equipos (si hay UI para mostrarla)
        loadEquipos();

      } catch (error) {
        console.error('Error creando equipo:', error);
        Swal.fire('Error', 'No se pudo crear el equipo: ' + (error.message || ''), 'error');
      }
    });

// Cargar equipos (se usa para depuraci√≥n y, si se desea, para mostrar en UI)
async function loadEquipos() {
  try {
    // Verificar sesi√≥n primero
    const check = await fetch(apiBase + '/session/check');
    if (!check.ok) {
      // No autenticado -> mostrar mensaje en la(s) tabla(s)
      const tables = document.querySelectorAll('#tabla-equipos');
      if (tables && tables.length > 0) {
        tables.forEach(table => {
          const tbody = table.querySelector('tbody');
          const thCount = table.querySelectorAll('thead th').length || 5;
          if (!tbody) return;
          tbody.innerHTML = `<tr><td colspan="${thCount}" class="text-center text-muted">Inicie sesi√≥n como administrador para ver los equipos</td></tr>`;
        });
      }
      return [];
    }

    const res = await fetch(apiBase + '/admin/equipos');
    if (!res.ok) {
      console.warn('No se pudieron cargar equipos, estado:', res.status);
      const tbody = document.querySelector('#tabla-equipos tbody');
      if (tbody) tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No se pudieron cargar los equipos</td></tr>';
      return [];
    }
    const list = await res.json();
    console.log('Equipos:', list);
    addLog('Equipos cargados: ' + list.length);

    // Rellenar todas las tablas que tengan id 'tabla-equipos' (evita problemas si hay duplicados en el DOM)
    const tables = document.querySelectorAll('#tabla-equipos');
    if (tables && tables.length > 0) {
      tables.forEach(table => {
        const tbody = table.querySelector('tbody');
        const thCount = table.querySelectorAll('thead th').length || 5;
        if (!tbody) return;
        tbody.innerHTML = '';
        if (list.length === 0) {
          tbody.innerHTML = `<tr><td colspan="${thCount}" class="text-center text-muted">No hay equipos registrados</td></tr>`;
        } else {
          list.forEach(eq => {
            const tr = document.createElement('tr');
            const ubicacionNombre = (eq.ubicacion && eq.ubicacion.nombre) ? eq.ubicacion.nombre : '';
            const estadoHtml = (eq.ubicacion) ? `<span class="badge bg-warning text-dark">MISION</span>` : (eq.estado || '');
            // Generar columnas dependiendo del n√∫mero de cabezeras (compatibilidad simple)
            if (thCount >= 5) {
              tr.innerHTML = `
                <td>${eq.tipo || ''}</td>
                <td>${eq.miembros || 0}</td>
                <td>${ubicacionNombre}</td>
                <td>${estadoHtml}</td>
                <td>
                  <button class="btn btn-sm btn-outline-danger" data-id="${eq.idEquipo}" data-action="eliminar-equipo">Eliminar</button>
                </td>`;
            } else {
              // versi√≥n compacta (panel-admin)
              tr.innerHTML = `
                <td>${eq.tipo || ''}</td>
                <td>${eq.miembros || 0}</td>
                <td>${estadoHtml}</td>
                <td>
                  <button class="btn btn-sm btn-outline-danger" data-id="${eq.idEquipo}" data-action="eliminar-equipo">Eliminar</button>
                </td>`;
            }
            tbody.appendChild(tr);
          });
        }
      });
    }

    return list;
  } catch (e) {
    console.error('Error cargando equipos:', e);
    const tables = document.querySelectorAll('#tabla-equipos');
    if (tables && tables.length > 0) {
      tables.forEach(table => {
        const tbody = table.querySelector('tbody');
        const thCount = table.querySelectorAll('thead th').length || 4;
        if (!tbody) return;
        tbody.innerHTML = `<tr><td colspan="${thCount}" class="text-center text-muted">Error cargando equipos</td></tr>`;
      });
    }
    return [];
  }
}

    // Crear ubicaci√≥n
    document.getElementById("form-create-ubicacion").addEventListener("submit", async (event) => {
      event.preventDefault();

      const ubicacion = {
        nombre: document.getElementById("u_nombre").value,
        tipo: document.getElementById("u_tipo").value,
        lat: parseFloat(document.getElementById("u_lat").value),
        lng: parseFloat(document.getElementById("u_lng").value),
        nivelRiesgo: document.getElementById("u_nivelRiesgo").value,
        personasAfectadas: 0
      };

      console.log('Enviando ubicaci√≥n:', ubicacion);

      try {
        const res = await fetch(apiBase + '/zonas', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(ubicacion)
        });

        const msg = await res.text();

        if (res.status === 409) {
          Swal.fire('Duplicado', msg, 'warning');
        } else if (!res.ok) {
          Swal.fire('Error', 'No se pudo guardar la ubicaci√≥n', 'error');
        } else {
          const data = JSON.parse(msg);
          addLog('Ubicaci√≥n creada: ' + data.nombre);
          loadUbicaciones();
          loadZonas();
          Swal.fire('√âxito', 'Ubicaci√≥n creada correctamente', 'success');
        }

      } catch (error) {
        console.error('Error:', error);
        Swal.fire('Error', 'Error al crear la ubicaci√≥n: ' + error.message, 'error');
      }
    });

    // Cargar ubicaciones (tabla)
    function loadUbicaciones() {
      fetch(apiBase + '/zonas')
        .then(r => r.json())
        .then(ubicaciones => {
          const tbody = document.querySelector('#tabla-ubicaciones tbody');
          tbody.innerHTML = '';
          ubicaciones.forEach(u => {
            tbody.innerHTML += `
              <tr>
                <td>${u.nombre}</td>
                <td>${u.tipo}</td>
                <td>${u.lng}</td>
                <td>${u.lat}</td>
                <td>${u.nivelRiesgo}</td>
              </tr>
            `;
          });
        })
        .catch(e => console.error('Error cargando ubicaciones:', e));
    }

    document.addEventListener('DOMContentLoaded', loadUbicaciones);

    // L√≥gica 'form-create-route' ELIMINADA (era parte de 'panel-rutas')

    // Cargar recursos
    function loadRecursos() {
      fetch(apiBase + '/recursos')
        .then(r => r.json())
        .then(list => {
          const tbody = document.querySelector('#tabla-recursos tbody');
          tbody.innerHTML = '';
          let total = 0;
          list.forEach(r => {
            total += r.cantidad || 0;
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${r.nombre}</td>
              <td>${r.tipo}</td>
              <td>${r.cantidad}</td>
              <td>${r.disponible ? 'S√≠' : 'No'}</td>
              <td>
                <button class="btn btn-sm btn-outline-danger" data-id="${r.id}" data-action="eliminar">Eliminar</button>
              </td>`;
            tbody.appendChild(tr);
          });
          document.getElementById('totalResources').textContent = total;
        })
        .catch(e => console.warn('No se pudo cargar recursos', e));
    }

    // Click en "Ver" zona tabla
    document.querySelector('#tabla-zonas tbody').addEventListener('click', (e) => {
      const btn = e.target.closest('button[data-id]');
      if (!btn) return;
      const id = btn.dataset.id;
      fetch(apiBase + '/zonas/' + id)
        .then(r => r.json())
        .then(ubicacion => { mostrarUbicacion(ubicacion); })
        .catch(err => console.error('Error al obtener ubicaci√≥n:', err));
    });

    // Click en botones de recursos (Asignar / Eliminar)
    document.querySelector('#tabla-recursos tbody').addEventListener('click', (e) => {
      const btn = e.target.closest('button[data-action]');
      if (!btn) return;
      const id = btn.dataset.id;
      const action = btn.dataset.action;
      
      if (action === 'eliminar') {
        Swal.fire({
          title: '¬øConfirmar eliminaci√≥n?',
          text: 'Este recurso ser√° eliminado permanentemente',
          icon: 'warning',
          showCancelButton: true,
          confirmButtonColor: '#d33',
          confirmButtonText: 'S√≠, eliminar'
        }).then(result => {
          if (result.isConfirmed) {
            fetch(apiBase + '/recursos/' + id, { method: 'DELETE' })
              .then(r => {
                if (r.ok) {
                  Swal.fire('Eliminado', 'Recurso eliminado correctamente', 'success');
                  loadRecursos();
                } else {
                  Swal.fire('Error', 'No se pudo eliminar el recurso', 'error');
                }
              })
              .catch(err => {
                console.error('Error al eliminar:', err);
                Swal.fire('Error', 'Error al eliminar el recurso', 'error');
              });
          }
        });
      }
    });

    // Listeners para distribuci√≥n de equipos (se registran siempre, no anidados)
    document.getElementById('eq_dist_origen')?.addEventListener('change', async (e) => {
      const origenId = e.target.value;
      const selectEquipo = document.getElementById('eq_dist_equipo');
      if (!origenId) { selectEquipo.innerHTML = '<option value="">Selecciona origen primero</option>'; selectEquipo.disabled = true; return; }
      try {
        const res = await fetch(apiBase + '/distribucion/equipos/' + origenId);
        if (!res.ok) { selectEquipo.innerHTML = '<option value="">Error cargando equipos</option>'; selectEquipo.disabled = true; return; }
        const list = await res.json();
        selectEquipo.innerHTML = '<option value="">Selecciona un equipo</option>';
        if (!list || list.length === 0) { selectEquipo.innerHTML = '<option value="">No hay equipos en esta ubicaci√≥n</option>'; selectEquipo.disabled = true; return; }
        list.forEach(eq => {
          const opt = new Option(`${eq.tipo} ‚Äî Miembros:${eq.miembros} (ID:${eq.idEquipo})`, eq.idEquipo);
          selectEquipo.appendChild(opt);
        });
        selectEquipo.disabled = false;
      } catch (err) {
        console.error('Error cargando equipos por ubicacion:', err);
        selectEquipo.innerHTML = '<option value="">Error cargando equipos</option>';
        selectEquipo.disabled = true;
      }
    });

    document.getElementById('btn-trasladar-equipo')?.addEventListener('click', async () => {
      const equipoId = parseInt(document.getElementById('eq_dist_equipo').value);
      const destinoId = parseInt(document.getElementById('eq_dist_destino').value);
      if (!equipoId || !destinoId) { Swal.fire('Aviso', 'Selecciona origen, equipo y destino', 'warning'); return; }
      try {
        const res = await fetch(apiBase + '/distribucion/trasladar-equipo', {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ equipoId: equipoId, destinoId: destinoId })
        });
        if (!res.ok) { const txt = await res.text(); throw new Error(txt || ('HTTP ' + res.status)); }
        const moved = await res.json();
        Swal.fire('√âxito', `Equipo trasladado: ${moved.tipo} (ID:${moved.idEquipo})`, 'success');
        addLog(`Equipo trasladado: ID ${moved.idEquipo} a ubicacion ${destinoId}`);
        // refrescar selects y tablas
        cargarUbicacionesParaDistribucion();
        loadEquipos();
      } catch (err) {
        console.error('Error trasladando equipo (btn):', err);
        Swal.fire('Error', err.message || 'No se pudo trasladar equipo', 'error');
      }
    });

    function mostrarUbicacion(ubicacion) {
      Swal.fire({
        title: 'Ubicaci√≥n encontrada',
        html: `
          <b>ID:</b> ${ubicacion.id}<br>
          <b>Nombre:</b> ${ubicacion.nombre}<br>
          <b>Latitud:</b> ${ubicacion.lat}<br>
          <b>Longitud:</b> ${ubicacion.lng}<br>
          <b>Nivel de riesgo:</b> ${ubicacion.nivelRiesgo}<br>
          <b>Personas afectadas:</b> ${ubicacion.personasAfectadas}<br>
          <b>√öltima actualizaci√≥n:</b> ${ubicacion.updatedAt}<br>
        `,
        icon: 'success',
        confirmButtonText: 'OK'
      });
    }

    // Cargar zonas
    function loadZonas() {
      fetch(apiBase + '/zonas')
        .then(r => r.json())
        .then(list => {
          const tbody = document.querySelector('#tabla-zonas tbody');
          tbody.innerHTML = '';
          // zonasLayer.clearLayers(); // <-- JS DE MAPA ELIMINADO

          let countCritical = 0;
          let totalEvacuated = 0;

          list.forEach(z => {
            if (z.nivelRiesgo === 'CRITICO') countCritical++;
            totalEvacuated += z.personasAfectadas || 0;

            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${z.nombre}</td>
              <td>${z.tipo}</td>
              <td><span class="badge ${
                z.nivelRiesgo === 'CRITICO' || z.nivelRiesgo === 'ALTO'
                  ? 'badge-risk-high'
                  : z.nivelRiesgo === 'MEDIO'
                    ? 'badge-risk-medium'
                    : 'badge-risk-low'
              }">${z.nivelRiesgo}</span></td>
              <td>${z.personasAfectadas}</td>
              <td>${z.recursosNecesarios?.length || 0}</td>
              <td>${new Date(z.updatedAt || Date.now()).toLocaleString()}</td>
              <td><button class="btn btn-sm btn-outline-secondary" data-id="${z.id}">Ver</button></td>`;
            tbody.appendChild(tr);

            // <-- BLOQUE 'if (z.lat && z.lng)' ELIMINADO (ERA PARA EL MAPA) -->
            
          });

          document.getElementById('countCritical').textContent = countCritical;
          document.getElementById('totalEvacuated').textContent = totalEvacuated;
        })
        .catch(e => console.warn('No se pudo cargar zonas', e));
    }

    // ===============================
    //   Cargar usuario actual (navbar)
    // ===============================
    function cargarUsuarioActual() {
      const userSpan = document.getElementById("currentUser");
      if (!userSpan) return;

      fetch("/api/usuario/actual")
        .then((res) => {
          if (!res.ok) {
            throw new Error("No autenticado o error en /api/usuario/actual");
          }
          return res.json();
        })
        .then((user) => {
          if (!user) return;
          const rolLabel = user.rol === "ADMINISTRADOR" ? "Admin" : "Operador";
          userSpan.textContent = `${rolLabel}: ${user.nombre} (${user.email})`;
        })
        .catch((err) => {
          console.warn("No se pudo cargar el usuario actual:", err);
        });
    }

    // ========================================
    //   DISTRIBUCI√ìN DE RECURSOS
    // ========================================

    let recursosDelOrigen = []; // Almacena los recursos del origen seleccionado

    // Cargar ubicaciones en los selectores de distribuci√≥n
    async function cargarUbicacionesParaDistribucion() {
      try {
        const res = await fetch(apiBase + '/zonas');
        const ubicaciones = await res.json();
        
        const selectOrigen = document.getElementById('dist_origen');
        const selectDestino = document.getElementById('dist_destino');
        const selectSugerenciaDestino = document.getElementById('dist_sugerencia_destino');
        
        if (selectOrigen) {
          selectOrigen.innerHTML = '<option value="">Selecciona origen</option>';
          selectDestino.innerHTML = '<option value="">Selecciona destino</option>';
          selectSugerenciaDestino.innerHTML = '<option value="">Selecciona destino cr√≠tico</option>';
          
            ubicaciones.forEach(u => {
            // Construir resumen de recursos disponibles (tipo: cantidad)
            let resumenRecursos = '';
            try {
                const recursos = u.recursosDisponibles || u.recursos || [];
                if (recursos && recursos.length > 0) {
                    resumenRecursos = recursos.map(r => `${r.tipo}:${r.cantidad}`).join(', ');
                }
            } catch (e) {
                console.warn('No se pudo generar resumen de recursos para zona', u.id, e);
            }

            const textoBase = `${u.nombre} (ID: ${u.id})`;
            const textoDestino = `${u.nombre} (${u.nivelRiesgo})`;

            const optionOrigen = new Option(resumenRecursos ? `${textoBase} ‚Äî ${resumenRecursos}` : textoBase, u.id);
            const optionDestino = new Option(resumenRecursos ? `${textoDestino} ‚Äî ${resumenRecursos}` : textoDestino, u.id);
            const optionSugerencia = new Option(resumenRecursos ? `${textoDestino} ‚Äî ${resumenRecursos}` : textoDestino, u.id);

            selectOrigen.appendChild(optionOrigen.cloneNode(true));
            selectDestino.appendChild(optionDestino.cloneNode(true));

            // Solo cr√≠ticas/altas en sugerencias
            if (u.nivelRiesgo === 'CRITICO' || u.nivelRiesgo === 'ALTO') {
              selectSugerenciaDestino.appendChild(optionSugerencia);
            }
          });
        }
      } catch (error) {
        console.error('Error cargando ubicaciones para distribuci√≥n:', error);
      }
    }

    // Cuando cambia el origen, cargar sus recursos
    document.getElementById('dist_origen')?.addEventListener('change', async (e) => {
      const origenId = e.target.value;
      const selectRecurso = document.getElementById('dist_recurso');
      
      if (!origenId) {
        selectRecurso.disabled = true;
        selectRecurso.innerHTML = '<option value="">Selecciona primero un origen</option>';
        return;
      }
      
      try {
        const res = await fetch(apiBase + '/zonas/' + origenId);
        const ubicacion = await res.json();
        
        recursosDelOrigen = ubicacion.recursosDisponibles || [];
        
        selectRecurso.innerHTML = '<option value="">Selecciona un recurso</option>';
        
        if (recursosDelOrigen.length === 0) {
          selectRecurso.innerHTML = '<option value="">No hay recursos disponibles</option>';
          selectRecurso.disabled = true;
        } else {
          recursosDelOrigen.forEach(r => {
            if (r.cantidad > 0) {
              const option = new Option(`${r.tipo} (${r.nombre}) - Cant: ${r.cantidad}`, r.id);
              selectRecurso.appendChild(option);
            }
          });
          selectRecurso.disabled = false;
        }

        // (Removed equipment-loading from resource distribution here ‚Äî use the 'Distribuir Equipos' tab.)
        
      } catch (error) {
        console.error('Error cargando recursos del origen:', error);
      }
    });

    // Cuando cambia el recurso, mostrar cantidad disponible
    document.getElementById('dist_recurso')?.addEventListener('change', (e) => {
      const recursoId = parseInt(e.target.value);
      const spanDisponible = document.getElementById('dist_disponible');
      
      if (!recursoId) {
        spanDisponible.textContent = '-';
        return;
      }
      
      const recurso = recursosDelOrigen.find(r => r.id === recursoId);
      if (recurso) {
        spanDisponible.textContent = recurso.cantidad;
        document.getElementById('dist_cantidad').max = recurso.cantidad;
      }
    });

    // Ejecutar distribuci√≥n manual
    document.getElementById('form-distribucion-manual')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const origenId = parseInt(document.getElementById('dist_origen').value);
      const destinoId = parseInt(document.getElementById('dist_destino').value);
      const recursoId = parseInt(document.getElementById('dist_recurso').value) || null;
      const cantidad = parseInt(document.getElementById('dist_cantidad').value) || 0;
      const equipoId = parseInt(document.getElementById('dist_equipo').value) || null;

      // Si se seleccion√≥ un equipo (y no un recurso), realizamos traslado de equipo
      if (equipoId && !recursoId) {
        try {
          const res = await fetch(apiBase + '/distribucion/trasladar-equipo', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ equipoId: equipoId, destinoId: destinoId })
          });

          if (!res.ok) {
            const txt = await res.text();
            throw new Error(txt || ('HTTP ' + res.status));
          }

          const moved = await res.json();
          Swal.fire('√âxito', `Equipo trasladado: ${moved.tipo} (ID:${moved.idEquipo})`, 'success');
          addLog(`Equipo trasladado: ID ${moved.idEquipo} a ubicacion ${destinoId}`);
          cargarUbicacionesParaDistribucion();
          return;
        } catch (err) {
          console.error('Error trasladando equipo:', err);
          Swal.fire('Error', err.message || 'No se pudo trasladar equipo', 'error');
          return;
        }
      }

      const payload = {
        origenId: origenId,
        destinoId: destinoId,
        recursoId: recursoId,
        cantidad: cantidad
      };

      try {
        const res = await fetch(apiBase + '/distribucion/ejecutar', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        
        if (!res.ok) {
          const errorMsg = await res.text();
          throw new Error(errorMsg);
        }
        
        const distribucion = await res.json();
        
        Swal.fire({
          icon: 'success',
          title: '¬°Distribuci√≥n Exitosa!',
          html: `
            <b>Origen:</b> ${distribucion.origen.nombre}<br>
            <b>Destino:</b> ${distribucion.destino.nombre}<br>
            <b>Cantidad:</b> ${distribucion.cantidad}<br>
            <b>Distancia:</b> ${distribucion.distanciaRecorrida.toFixed(2)} km
          `
        });
        
        addLog(`Distribuci√≥n ejecutada: ${distribucion.cantidad} unidades de ${distribucion.recurso.tipo}`);
        
        // Recargar datos
        e.target.reset();
        cargarHistorialDistribuciones();
        
      } catch (error) {
        console.error('Error ejecutando distribuci√≥n:', error);
        Swal.fire('Error', error.message, 'error');
      }
    });

    // Calcular sugerencias autom√°ticas
    document.getElementById('btn-calcular-sugerencias')?.addEventListener('click', async () => {
      const destinoId = document.getElementById('dist_sugerencia_destino').value;
      
      if (!destinoId) {
        Swal.fire('Aviso', 'Selecciona un destino cr√≠tico', 'warning');
        return;
      }
      
      try {
        const res = await fetch(apiBase + '/distribucion/sugerencias/' + destinoId);
        const sugerencias = await res.json();
        
        const container = document.getElementById('sugerencias-container');
        
        if (sugerencias.length === 0) {
          container.innerHTML = '<p class="text-muted small">No hay sugerencias disponibles para este destino.</p>';
          return;
        }
        
        container.innerHTML = '';
        
        sugerencias.forEach((sug, index) => {
          const card = document.createElement('div');
          card.className = 'card mb-2 p-2';
          card.innerHTML = `
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <strong>${index + 1}. ${sug.origen.nombre}</strong><br>
                <small>${sug.recurso.tipo} - ${sug.cantidadDisponible} unidades</small><br>
                <small class="text-muted">Distancia: ${sug.distancia.toFixed(2)} km | Score: ${sug.score.toFixed(2)}</small>
              </div>
              <button class="btn btn-sm btn-outline-primary" onclick="aplicarSugerencia(${sug.origen.id}, ${destinoId}, ${sug.recurso.id})">
                Aplicar
              </button>
            </div>
          `;
          container.appendChild(card);
        });
        
        addLog(`Sugerencias calculadas para destino ID ${destinoId}: ${sugerencias.length} opciones`);
        
      } catch (error) {
        console.error('Error calculando sugerencias:', error);
        Swal.fire('Error', 'No se pudieron calcular sugerencias', 'error');
      }
    });

    // Aplicar una sugerencia
    function aplicarSugerencia(origenId, destinoId, recursoId) {
      document.getElementById('dist_origen').value = origenId;
      document.getElementById('dist_origen').dispatchEvent(new Event('change'));
      
      setTimeout(() => {
        document.getElementById('dist_destino').value = destinoId;
        document.getElementById('dist_recurso').value = recursoId;
        document.getElementById('dist_recurso').dispatchEvent(new Event('change'));
        
        // Cambiar a la pesta√±a de distribuci√≥n manual
        document.querySelector('[data-tab="distribuir-recursos"]').click();
      }, 500);
    }

    // Cargar historial de distribuciones
    async function cargarHistorialDistribuciones() {
      try {
        const res = await fetch(apiBase + '/distribucion/historial');
        const historial = await res.json();
        
        const tbody = document.querySelector('#tabla-historial-distribuciones tbody');
        if (!tbody) return;
        
        tbody.innerHTML = '';
        
        historial.slice(0, 20).forEach(d => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${d.id}</td>
            <td>${new Date(d.fechaDistribucion).toLocaleString()}</td>
            <td>${d.origen.nombre}</td>
            <td>${d.destino.nombre}</td>
            <td>${d.recurso.tipo}</td>
            <td>${d.cantidad}</td>
            <td>${d.distanciaRecorrida.toFixed(2)}</td>
            <td><span class="badge bg-success">${d.estado}</span></td>
            <td>${d.responsable?.nombre || 'N/A'}</td>
          `;
          tbody.appendChild(tr);
        });
        
      } catch (error) {
        console.error('Error cargando historial:', error);
      }
    }

    // ========================================
    //   REPORTES Y ESTAD√çSTICAS
    // ========================================

    let chartRecursosZona = null;
    let chartRiesgos = null;

    // Cargar reportes al entrar a la pesta√±a
    async function cargarReportes() {
      await cargarEstadisticasGenerales();
      await cargarReporteRecursos();
      await cargarEstadisticasZonasCriticas();
    }

    // Estad√≠sticas generales (cards superiores)
    async function cargarEstadisticasGenerales() {
      try {
        const res = await fetch(apiBase + '/reportes/distribuciones');
        const data = await res.json();
        
        document.getElementById('stat_total_dist').textContent = data.totalDistribuciones || 0;
        document.getElementById('stat_recursos_dist').textContent = data.totalRecursosDistribuidos || 0;
        document.getElementById('stat_distancia').textContent = data.distanciaTotal?.toFixed(2) || '0';
        
      } catch (error) {
        console.error('Error cargando estad√≠sticas generales:', error);
      }
    }

    // Reporte detallado de recursos
    async function cargarReporteRecursos() {
      try {
        const res = await fetch(apiBase + '/reportes/recursos-por-zona');
        const reporte = await res.json();
        
        const tbody = document.querySelector('#tabla-reporte-recursos tbody');
        if (!tbody) return;
        
        tbody.innerHTML = '';
        
        // Preparar datos para gr√°fico
        const labelsGrafico = [];
        const dataDisponibles = [];
        const dataNecesarios = [];
        
        reporte.forEach(r => {
          const tr = document.createElement('tr');
          const balance = r.disponibles - r.necesarios;
          const balanceClass = balance >= 0 ? 'text-success' : 'text-danger';
          
          tr.innerHTML = `
            <td>${r.ubicacionNombre}</td>
            <td>${r.tipoRecurso}</td>
            <td>${r.disponibles}</td>
            <td>${r.necesarios}</td>
            <td><span class="badge ${getBadgeClass(r.nivelRiesgo)}">${r.nivelRiesgo}</span></td>
            <td class="${balanceClass}">${balance > 0 ? '+' : ''}${balance}</td>
          `;
          tbody.appendChild(tr);
          
          // Acumular para gr√°fico
          const key = `${r.ubicacionNombre}`;
          if (!labelsGrafico.includes(key)) {
            labelsGrafico.push(key);
            dataDisponibles.push(r.disponibles);
            dataNecesarios.push(r.necesarios);
          } else {
            const idx = labelsGrafico.indexOf(key);
            dataDisponibles[idx] += r.disponibles;
            dataNecesarios[idx] += r.necesarios;
          }
        });
        
        // Crear gr√°fico
        crearGraficoRecursos(labelsGrafico.slice(0, 10), dataDisponibles.slice(0, 10), dataNecesarios.slice(0, 10));
        
      } catch (error) {
        console.error('Error cargando reporte de recursos:', error);
      }
    }

    // Estad√≠sticas de zonas cr√≠ticas
    async function cargarEstadisticasZonasCriticas() {
      try {
        const res = await fetch(apiBase + '/reportes/zonas-criticas');
        const data = await res.json();
        
        document.getElementById('stat_zonas_criticas').textContent = 
          (data.distribucionRiesgo?.CRITICO || 0) + (data.distribucionRiesgo?.ALTO || 0);
        
        // Crear gr√°fico de riesgos
        crearGraficoRiesgos(data.distribucionRiesgo);
        
      } catch (error) {
        console.error('Error cargando estad√≠sticas de zonas cr√≠ticas:', error);
      }
    }

    // Crear gr√°fico de recursos por zona
    function crearGraficoRecursos(labels, disponibles, necesarios) {
      const ctx = document.getElementById('chart-recursos-zona');
      if (!ctx) return;
      
      if (chartRecursosZona) {
        chartRecursosZona.destroy();
      }
      
      chartRecursosZona = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'Disponibles',
              data: disponibles,
              backgroundColor: 'rgba(40, 167, 69, 0.7)'
            },
            {
              label: 'Necesarios',
              data: necesarios,
              backgroundColor: 'rgba(220, 53, 69, 0.7)'
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true
            }
          }
        }
      });
    }

    // Crear gr√°fico de distribuci√≥n de riesgos
    function crearGraficoRiesgos(distribucion) {
      const ctx = document.getElementById('chart-riesgos');
      if (!ctx) return;
      
      if (chartRiesgos) {
        chartRiesgos.destroy();
      }
      
      chartRiesgos = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: Object.keys(distribucion || {}),
          datasets: [{
            data: Object.values(distribucion || {}),
            backgroundColor: [
              'rgba(220, 53, 69, 0.8)',   // CRITICO - rojo
              'rgba(255, 193, 7, 0.8)',   // ALTO - amarillo
              'rgba(13, 110, 253, 0.8)',  // MEDIO - azul
              'rgba(40, 167, 69, 0.8)'    // BAJO - verde
            ]
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom'
            }
          }
        }
      });
    }

    // Exportar CSV
    document.getElementById('btn-exportar-csv')?.addEventListener('click', async () => {
      try {
        const res = await fetch(apiBase + '/reportes/exportar-csv');
        const csv = await res.text();
        
        // Crear archivo descargable
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'reporte_recursos_' + new Date().toISOString().split('T')[0] + '.csv';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
        
        addLog('Reporte CSV exportado exitosamente');
        Swal.fire('√âxito', 'Reporte descargado correctamente', 'success');
        
    } catch (error) {
        console.error('Error exportando CSV:', error);
        Swal.fire('Error', 'No se pudo exportar el reporte', 'error');
      }
    });

    // ========================================
    //   CARGA DE DATOS DE MUESTRA
    // ========================================

    document.getElementById('btn-load-sample')?.addEventListener('click', async () => {
      const confirmacion = await Swal.fire({
        title: '¬øCargar datos de muestra?',
        text: 'Esto crear√° ubicaciones, recursos y rutas de ejemplo',
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'S√≠, cargar',
        cancelButtonText: 'Cancelar'
      });

      if (!confirmacion.isConfirmed) return;

      try {
        Swal.fire({
          title: 'Cargando...',
          text: 'Por favor espera',
          allowOutsideClick: false,
          didOpen: () => {
            Swal.showLoading();
          }
        });

        const res = await fetch(apiBase + '/admin/cargar-muestra', {
          method: 'POST',
          credentials: 'include'
        });

        const msg = await res.text();

        if (!res.ok) {
          throw new Error(msg);
        }

        Swal.fire({
          icon: 'success',
          title: '¬°Datos Cargados!',
          html: msg,
          confirmButtonText: 'OK'
        }).then(() => {
          // Recargar datos en todas las pesta√±as
          loadRecursos();
          loadZonas();
          loadUbicaciones();
          cargarUbicacionesParaDistribucion();
          
          addLog('Datos de muestra cargados exitosamente');
        });

      } catch (error) {
        console.error('Error cargando datos:', error);
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: error.message || 'No se pudieron cargar los datos'
        });
      }
    });

    // Bot√≥n limpiar datos
    document.getElementById('btn-clear-data')?.addEventListener('click', async () => {
      const confirmacion = await Swal.fire({
        title: '‚ö†Ô∏è ¬øELIMINAR TODO?',
        text: 'Esto borrar√° TODAS las ubicaciones, recursos y rutas. Esta acci√≥n NO se puede deshacer.',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'S√≠, eliminar todo',
        cancelButtonText: 'Cancelar'
      });

      if (!confirmacion.isConfirmed) return;

      try {
        const res = await fetch(apiBase + '/admin/limpiar-datos', {
          method: 'DELETE',
          credentials: 'include'
        });

        const msg = await res.text();

        if (!res.ok) {
          throw new Error(msg);
        }

        Swal.fire('¬°Eliminado!', msg, 'success').then(() => {
          loadRecursos();
          loadZonas();
          loadUbicaciones();
          addLog('Todos los datos fueron eliminados');
        });

      } catch (error) {
        console.error('Error limpiando datos:', error);
        Swal.fire('Error', error.message, 'error');
      }
    });

    // Inicializaci√≥n
    window.addEventListener('load', () => {
      try { connectWebSocket(); } catch (e) { console.warn('WS init error', e); }
      loadRecursos();
      loadZonas();
      cargarUsuarioActual();

      // Inicializar m√≥dulos de distribuci√≥n
      cargarUbicacionesParaDistribucion();

      // <-- L√ìGICA DE 'btn-load-sample' ELIMINADA -->

      const btnRefresh = document.getElementById('btn-refresh');
      if (btnRefresh) {
        btnRefresh.addEventListener('click', () => {
          loadRecursos();
          loadZonas();
          addLog('Datos refrescados manualmente');
          
          // --- 7. A√ëADIR REFRESCO AL NUEVO MAPA ---
          if (document.getElementById('eliminar-ubicacion').classList.contains('active')) {
             initEliminarUbicacionMap();
          }
          // --- FIN DEL CAMBIO 7 ---
        });
      }
    });

    // LOGOUT / SALIR
    const logoutLink = document.getElementById('menu-logout');
    if (logoutLink) {
      logoutLink.addEventListener('click', (e) => {
        e.preventDefault();
        window.location.href = '/logout';
      });
    }

    const exitLink = document.getElementById('menu-exit');
    if (exitLink) {
      exitLink.addEventListener('click', (e) => {
        e.preventDefault();
        Swal.fire({
          title: 'Cerrar sesi√≥n',
          text: '¬øSeguro que quieres salir de la demo?',
          icon: 'warning',
          showCancelButton: true,
          confirmButtonText: 'S√≠, salir',
          cancelButtonText: 'Cancelar'
        }).then((result) => {
          if (result.isConfirmed) {
            window.location.href = '/logout';
          }
        });
      });
    }

    // Validaci√≥n de ubicaci√≥n (si quieres usarla luego)
    function validarUbicacion(ubicacion) {
      const tiposValidos = ['URBANA', 'RURAL'];
      const nivelesRiesgo = ['BAJO', 'MEDIO', 'ALTO', 'CRITICO'];

      if (!tiposValidos.includes(ubicacion.tipo)) {
        throw new Error('Tipo de ubicaci√≥n no v√°lido');
      }

      if (!nivelesRiesgo.includes(ubicacion.nivelRiesgo)) {
        throw new Error('Nivel de riesgo no v√°lido');
      }

      if (!ubicacion.nombre || ubicacion.nombre.trim() === '') {
        throw new Error('El nombre es requerido');
      }

      return true;
    }
  </script>
</body>

</html>