<!doctype html>
<html lang="es">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sistema Gestión de Desastres Naturales — UI</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Leaflet CSS (mapa open-source). Si prefieres Google Maps, quita Leaflet y agrega la librería de Google Maps con tu API key -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <!-- Font Awesome (íconos) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">


  <style>
    /* Estilos básicos para layout */
    body {
      background: #f8f9fa;
    }

    #map {
      height: 600px;
      min-height: 400px;
      width: 100%;
      border-radius: 6px;
    }

    .sidebar {
      max-height: 85vh;
      overflow-y: auto;
    }

    .tab-section {
      display: none;
    }

    .tab-section.active {
      display: block;
    }

    .small-muted {
      font-size: 0.85rem;
      color: #6c757d;
    }

    .card-map {
      height: 100%;
    }

    .badge-risk-low {
      background: #198754;
    }

    .badge-risk-medium {
      background: #ffc107;
      color: #000;
    }

    .badge-risk-high {
      background: #dc3545;
    }
  </style>
</head>

<body>
  <!-- NAVBAR -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">SGD - Gestión Desastres</a>
      <div class="d-flex align-items-center">
        <span id="wsStatus" class="badge bg-secondary me-2">WS: desconectado</span>
        <button class="btn btn-outline-light btn-sm me-2" id="btn-refresh">Refrescar datos</button>
        <div class="dropdown">
          <a class="btn btn-outline-light dropdown-toggle" data-bs-toggle="dropdown" href="#" role="button"
            aria-expanded="false">
            <i class="fa fa-user"></i> Cuenta
          </a>
          <ul class="dropdown-menu dropdown-menu-end">
            <li><a class="dropdown-item" href="#" id="menu-logout">Cerrar sesión</a></li>
          </ul>
        </div>
      </div>
    </div>
  </nav>

  <!-- LAYOUT PRINCIPAL -->
  <div class="container-fluid mt-3">
    <div class="row">

      <!-- SIDEBAR (navegación de pestañas) -->
      <aside class="col-md-3">
        <div class="card sidebar p-2">
          <h5 class="mb-2">Menú</h5>
          <div class="list-group">
            <a href="#" class="list-group-item list-group-item-action active" data-tab="inicio">Inicio</a>
            <a href="#" class="list-group-item list-group-item-action" data-tab="panel-admin">Panel Administración</a>
            <a href="#" class="list-group-item list-group-item-action" data-tab="panel-rutas">Panel Rutas</a>
            <a href="#" class="list-group-item list-group-item-action" data-tab="estadisticas">Estadísticas</a>
            <a href="#" class="list-group-item list-group-item-action" data-tab="mapa">Mapa Interactivo</a>
            <a href="#" class="list-group-item list-group-item-action" data-tab="simulador">Simulador</a>
            <a href="#" class="list-group-item list-group-item-action" data-tab="carga-datos">Carga Inicial</a>
            <a href="#" class="list-group-item list-group-item-action text-danger" id="menu-exit">Salir (apagar
              demo)</a>
          </div>

          <hr>
          <h6 class="mt-2">Conexiones</h6>
          <p class="small-muted">Backend: <span id="backendUrl">http://localhost:8081/api</span></p>
          <p class="small-muted">WebSocket: <span id="wsUrl">ws://localhost:8081/ws</span></p>
        </div>
      </aside>

      <!-- CONTENIDO PRINCIPAL -->
      <main class="col-md-9">
        <!-- SECCION: INICIO -->
        <section id="inicio" class="tab-section active">
          <div class="row g-3">
            <div class="col-lg-8">
              <div class="card card-map p-3">
                <h5>Vista general</h5>
                <p class="small-muted mb-2">Resumen de zonas afectadas y recursos disponibles.</p>
                <!-- Indicadores rápidos -->
                <div class="row mb-3">
                  <div class="col-sm-4">
                    <div class="card p-2">
                      <h6>Zonas críticas</h6>
                      <p id="countCritical" class="display-6 m-0">0</p>
                    </div>
                  </div>
                  <div class="col-sm-4">
                    <div class="card p-2">
                      <h6>Personas evacuadas</h6>
                      <p id="totalEvacuated" class="display-6 m-0">0</p>
                    </div>
                  </div>
                  <div class="col-sm-4">
                    <div class="card p-2">
                      <h6>Recursos en almacén</h6>
                      <p id="totalResources" class="display-6 m-0">0</p>
                    </div>
                  </div>
                </div>

                <!-- Tabla resumen de zonas -->
                <div>
                  <h6>Zonas afectadas</h6>
                  <div class="table-responsive">
                    <table class="table table-striped table-sm" id="tabla-zonas">
                      <thead>
                        <tr>
                          <th>Zona</th>
                          <th>Tipo</th>
                          <th>Riesgo</th>
                          <th>Personas</th>
                          <th>Recursos Necesarios</th>
                          <th>Última actualización</th>
                          <th>Acciones</th>
                        </tr>
                      </thead>
                      <tbody>
                        <!-- Se rellenará dinámicamente -->
                      </tbody>
                    </table>
                  </div>
                </div>

              </div>
            </div>

            <!-- PANEL DERECHO: Eventos y registro -->
            <div class="col-lg-4">
              <div class="card p-2 mb-3">
                <h6>Actividad reciente</h6>
                <ul id="logActivity" class="list-group list-group-flush small" style="max-height:280px; overflow:auto;">
                  <!-- Mensajes WebSocket o acciones -->
                </ul>
              </div>

              <div class="card p-2">
                <h6>Filtros rápidos</h6>
                <div class="mb-2">
                  <label class="form-label">Nivel de riesgo</label>
                  <select id="filterRisk" class="form-select form-select-sm">
                    <option value="">Todos</option>
                    <option value="BAJO">Bajo</option>
                    <option value="MEDIO">Medio</option>
                    <option value="ALTO">Alto</option>
                    <option value="CRITICO">Crítico</option>
                  </select>
                </div>
                <button class="btn btn-primary btn-sm w-100" id="btn-apply-filters">Aplicar</button>
              </div>
            </div>

          </div>
        </section>

        <!-- SECCION: PANEL ADMIN -->
        <section id="panel-admin" class="tab-section">
          <div class="card p-3">
            <h5>Panel de Administración</h5>
            <p class="small-muted">Crear/editar recursos, asignar a zonas, gestionar equipos de rescate.</p>

            <div class="row g-3">
              <div class="col-md-6">
                <h6>Crear Recurso</h6>
                <form id="form-create-resource">
                  <div class="mb-2">
                    <label class="form-label">Nombre</label>
                    <input required id="r_nombre" class="form-control form-control-sm" />
                  </div>
                  <div class="mb-2">
                    <label class="form-label">Tipo</label>
                    <select id="r_tipo" class="form-select form-select-sm">
                      <option value="ALIMENTO">Alimento</option>
                      <option value="MEDICINA">Medicina</option>
                      <option value="EQUIPO_RESCATE">Equipo rescate</option>
                      <option value="AGUA">Agua</option>
                      <option value="COMBUSTIBLE">Combustible</option>
                    </select>
                  </div>
                  <div class="mb-2">
                    <label class="form-label">Cantidad</label>
                    <input id="r_cantidad" type="number" class="form-control form-control-sm" value="1" />
                  </div>
                  <div class="d-grid">
                    <button class="btn btn-success btn-sm" type="submit">Crear Recurso</button>
                  </div>
                </form>
              </div>

              <div class="col-md-6">
                <h6>Equipos de Rescate</h6>
                <form id="form-create-team">
                  <div class="mb-2">
                    <label class="form-label">Nombre</label>
                    <input id="e_nombre" class="form-control form-control-sm" />
                  </div>
                  <div class="mb-2">
                    <label class="form-label">Tipo</label>
                    <select id="e_tipo" class="form-select form-select-sm">
                      <option value="BOMBEROS">Bomberos</option>
                      <option value="MEDICOS">Médicos</option>
                      <option value="POLICIA">Policía</option>
                      <option value="VOLUNTARIOS">Voluntarios</option>
                    </select>
                  </div>
                  <div class="mb-2">
                    <label class="form-label">Miembros</label>
                    <input id="e_miembros" type="number" value="5" class="form-control form-control-sm" />
                  </div>
                  <div class="d-grid">
                    <button class="btn btn-primary btn-sm" id="btn-create-team" type="button">Crear Equipo</button>
                  </div>
                </form>
              </div>
            </div>
            <hr>
            <h6>Registrar Ubicación</h6>
            <form id="form-create-ubicacion" class="row g-2">
              <div class="col-md-4">
                <label class="form-label">Nombre</label>
                <input id="u_nombre" required class="form-control form-control-sm" placeholder="Ej: Zona Norte" />
              </div>
              <div class="col-md-4">
                <label class="form-label">Tipo</label>
                <select id="u_tipo" class="form-select form-select-sm">
                  <option value="URBANA">Urbana</option>
                  <option value="RURAL">Rural</option>
                </select>
              </div>
              <div class="col-md-2">
                <label class="form-label">Lat</label>
                <input id="u_lat" type="number" step="0.0001" class="form-control form-control-sm" placeholder="4.65" />
              </div>
              <div class="col-md-2">
                <label class="form-label">Lng</label>
                <input id="u_lng" type="number" step="0.0001" class="form-control form-control-sm"
                  placeholder="-74.05" />
              </div>
              <div class="col-md-4">
                <label class="form-label">Nivel de Riesgo</label>
                <select id="u_nivelRiesgo" class="form-select form-select-sm">
                  <option value="BAJO">Bajo</option>
                  <option value="MEDIO">Medio</option>
                  <option value="ALTO">Alto</option>
                  <option value="CRITICO">Crítico</option>
                </select>
              </div>
              <div class="col-12 d-grid">
                <button class="btn btn-success btn-sm mt-2" type="submit">Crear Ubicación</button>
              </div>
            </form>


            <hr>

            <h6 class="mt-3">Listado de Recursos</h6>
            <div class="table-responsive">
              <table class="table table-sm" id="tabla-recursos">
                <thead>
                  <tr>
                    <th>Nombre</th>
                    <th>Tipo</th>
                    <th>Cantidad</th>
                    <th>Disponibilidad</th>
                    <th>Acciones</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
            <h6 class="mt-3">Listado de Ubicaciones</h6>
            <div class="table-responsive">
              <table class="table table-sm" id="tabla-ubicaciones">
                <thead>
                  <tr>
                    <th>Nombre</th>
                    <th>Tipo</th>
                    <th>Longitud</th>
                    <th>Latitud</th>
                    <th>Nivel de Riesgo</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>

          </div>
        </section>

        <!-- SECCION: PANEL RUTAS -->
        <section id="panel-rutas" class="tab-section">
          <div class="card p-3">
            <h5>Panel de Rutas y Planificación</h5>
            <p class="small-muted">Definir rutas, ver grafo, calcular camino más corto y planificar evacuaciones.</p>

            <div class="row g-3">
              <div class="col-md-6">
                <h6>Calcular ruta más corta</h6>
                <form id="form-calc-route">
                  <div class="mb-2">
                    <label class="form-label">Origen (coordenadas o Nombre conocido)</label>
                    <input id="route_origen" class="form-control form-control-sm" />
                  </div>
                  <div class="mb-2">
                    <label class="form-label">Destino (Coordenadas o Nombre conocido)</label>
                    <input id="route_destino" class="form-control form-control-sm" />
                  </div>
                  <div class="mb-2">
                    <label class="form-label">Modo</label>
                    <select id="route_mode" class="form-select form-select-sm">
                      <option value="DRIVING">Conducción</option>
                      <option value="WALKING">Peatón</option>
                      <option value="BICYCLING">Bicicleta</option>
                    </select>
                  </div>
                  <div class="d-grid">
                    <button class="btn btn-warning btn-sm" type="submit">Calcular Ruta</button>
                  </div>
                </form>
              </div>

              <div class="col-md-6">
                <h6>Definir nueva ruta</h6>
                <form id="form-create-route">
                  <div class="mb-2">
                    <label class="form-label">Origen (zona id)</label>
                    <input id="r_origen" class="form-control form-control-sm" type="text" />
                  </div>
                  <div class="mb-2">
                    <label class="form-label">Destino (zona id)</label>
                    <input id="r_destino" class="form-control form-control-sm" type="text" />
                  </div>
                  <div class="mb-2">
                    <label class="form-label">Distancia (km)</label>
                    <input id="r_distancia" type="number" step="0.1" class="form-control form-control-sm" />
                  </div>
                  <div class="d-grid">
                    <button class="btn btn-success btn-sm" id="btn-create-route-name" type="submit">Crear ruta por
                      nombre</button>
                  </div>
                  <div class="d-grid">
                    <button class="btn btn-success btn-sm" id="btn-create-route-coordenadas" type="submit">Crear ruta
                      por coordenadas</button>
                  </div>
                </form>
              </div>
            </div>

            <hr>
            <h6>Grafo de rutas (lista)</h6>
            <div class="table-responsive">
              <table class="table table-sm" id="tabla-rutas">
                <thead>
                  <tr>
                    <th>Origen</th>
                    <th>Destino</th>
                    <th>Distancia</th>
                    <th>Acciones</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>

          </div>
        </section>

        <!-- SECCION: ESTADISTICAS -->
        <section id="estadisticas" class="tab-section">
          <div class="card p-3">
            <h5>Estadísticas y Reportes</h5>
            <p class="small-muted">Gráficas del avance de las evacuaciones, distribución de recursos y tiempos de
              llegada.</p>

            <div class="row">
              <div class="col-md-6">
                <canvas id="chart-evacuaciones" height="200"></canvas>
              </div>
              <div class="col-md-6">
                <canvas id="chart-recursos" height="200"></canvas>
              </div>
            </div>

            <hr>
            <h6>Descargar reportes</h6>
            <div class="d-flex gap-2">
              <button class="btn btn-outline-primary btn-sm" id="btn-download-report-pdf">Descargar PDF</button>
              <button class="btn btn-outline-secondary btn-sm" id="btn-download-report-csv">Exportar CSV</button>
            </div>

          </div>
        </section>

        <!-- SECCION: MAPA -->
        <section id="mapa" class="tab-section">
          <div class="card p-3">
            <h5>Mapa Interactivo</h5>
            <p class="small-muted">Visualiza zonas, rutas y zonas de evacuación. Pincha una zona para ver detalles y
              acciones.</p>

            <div id="map" class="mb-3"></div>

            <div class="row">
              <div class="col-md-4">
                <h6>Detalle Zona</h6>
                <div id="detalleZona">
                  <p><strong>Nombre:</strong> <span id="dz_nombre">-</span></p>
                  <p><strong>Nivel Riesgo:</strong> <span id="dz_riesgo">-</span></p>
                  <p><strong>Personas:</strong> <span id="dz_personas">-</span></p>
                  <p><strong>Recursos:</strong> <span id="dz_recursos">-</span></p>
                  <div class="d-grid">
                    <button class="btn btn-danger btn-sm" id="btn-evacuar-zona">Iniciar Evacuación</button>
                  </div>
                </div>
              </div>

              <div class="col-md-8">
                <h6>Controles de Mapa</h6>
                <div class="mb-2">
                  <label class="form-label">Mostrar:</label>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="chkMostrarRutas" checked>
                    <label class="form-check-label">Rutas</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="chkMostrarZonas" checked>
                    <label class="form-check-label">Zonas</label>
                  </div>
                </div>
                <small class="text-muted">Zoom y desplazamiento manual disponibles.</small>
              </div>
            </div>
          </div>
        </section>

        <!-- SECCION: SIMULADOR -->
        <section id="simulador" class="tab-section">
          <div class="card p-3">
            <h5>Simulador de Evacuación y Transporte</h5>
            <p class="small-muted">Ejecuta simulaciones paso a paso, controla velocidad y observa asignación de recursos
              y rutas.</p>

            <div class="row g-3">
              <div class="col-md-4">
                <label class="form-label">Seleccionar escenario</label>
                <select id="sim_scenario" class="form-select form-select-sm">
                  <option value="default">Escenario por defecto</option>
                </select>
              </div>
              <div class="col-md-4">
                <label class="form-label">Velocidad (ms paso)</label>
                <input id="sim_speed" type="range" min="100" max="2000" step="100" value="500" class="form-range" />
              </div>
              <div class="col-md-4">
                <label class="form-label">&nbsp;</label>
                <div class="d-grid">
                  <button id="sim_start" class="btn btn-success btn-sm">Iniciar Simulación</button>
                  <button id="sim_pause" class="btn btn-warning btn-sm mt-1">Pausar</button>
                  <button id="sim_stop" class="btn btn-danger btn-sm mt-1">Detener</button>
                </div>
              </div>
            </div>

            <hr>
            <h6>Cola de prioridad (evacuaciones)</h6>
            <ul id="priorityQueue" class="list-group"></ul>
          </div>
        </section>

        <!-- SECCION: CARGA DE DATOS / PRUEBA -->
        <section id="carga-datos" class="tab-section">
          <div class="card p-3">
            <h5>Carga de datos iniciales</h5>
            <p class="small-muted">Sube un archivo JSON con zonas, rutas y recursos, o pulsa el botón para cargar datos
              de prueba.</p>

            <div class="mb-3">
              <input type="file" id="fileLoad" accept=".json" class="form-control form-control-sm" />
            </div>
            <div class="d-flex gap-2">
              <button id="btn-load-file" class="btn btn-primary btn-sm">Cargar archivo</button>
              <button id="btn-load-sample" class="btn btn-outline-secondary btn-sm">Cargar datos de muestra</button>
              <button id="btn-clear-data" class="btn btn-outline-danger btn-sm">Limpiar datos</button>
            </div>
            <hr>
            <small class="text-muted">Formato JSON esperado: { "zonas":[...], "rutas":[...], "recursos":[...] }</small>
          </div>
        </section>

      </main>
    </div>
  </div>

  <!-- MODAL: LOGIN (se usa para autenticación) -->
  <div class="modal fade" id="modalLogin" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <form id="form-login">
          <div class="modal-header">
            <h5 class="modal-title">Iniciar sesión</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="mb-2">
              <label class="form-label">Correo</label>
              <input id="login_email" required class="form-control form-control-sm" type="email" />
            </div>
            <div class="mb-2">
              <label class="form-label">Contraseña</label>
              <input id="login_password" required class="form-control form-control-sm" type="password" />
            </div>
            <div class="form-check">
              <input id="login_remember" class="form-check-input" type="checkbox" />
              <label class="form-check-label">Recordarme</label>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancelar</button>
            <button class="btn btn-primary btn-sm" type="submit">Entrar</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- SCRIPTS: Librerías -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>


  <!-- STOMP + SockJS para WebSocket -->
  <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.7.5/dist/sockjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@stomp/stompjs@7.0.0/bundles/stomp.umd.min.js"></script>

   <!-- JS: lógica mínima para interacción (placeholder) -->
  <script>
    /* ================
       Cliente UI - lógica mínima (plantilla)
       - Aquí debes conectar con tu backend (REST) y WebSocket
       - Está intencionalmente funcional para demo local, completa según tu API
       ================ */

    const apiBase = document.getElementById('backendUrl').textContent;
    const wsBase = document.getElementById('wsUrl').textContent;

    // Navegación de pestañas
    document.querySelectorAll('.list-group .list-group-item').forEach(a => {
      a.addEventListener('click', (e) => {
        e.preventDefault();
        document.querySelectorAll('.list-group .list-group-item').forEach(x => x.classList.remove('active'));
        a.classList.add('active');
        const tab = a.getAttribute('data-tab');
        document.querySelectorAll('.tab-section').forEach(s => s.classList.remove('active'));
        document.getElementById(tab).classList.add('active');
      });
    });

    // Inicializar mapa (Leaflet)
    const map = L.map('map').setView([4.5709, -74.2973], 6); // Colombia centro por defecto
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // Marcadores y capas
    const zonasLayer = L.layerGroup().addTo(map);
    const rutasLayer = L.layerGroup().addTo(map);

    // WebSocket STOMP client (plantilla)
    let stompClient = null;
    function connectWebSocket() {
      const socket = new SockJS(wsBase.replace('ws://', ''));
      stompClient = StompJs.Stomp.over(socket);
      stompClient.connect({}, function (frame) {
        console.log('Connected: ' + frame);
        document.getElementById('wsStatus').textContent = 'WS: conectado';
        stompClient.subscribe('/topic/evacuaciones', function (message) {
          const payload = JSON.parse(message.body);
          addLog('Evacuación recibida: ' + payload.ubicacion);
        });
      }, function (err) {
        console.error('STOMP error', err);
        document.getElementById('wsStatus').textContent = 'WS: error';
      });
    }

    // Agregar log
    function addLog(text) {
      const li = document.createElement('li');
      li.className = 'list-group-item';
      li.textContent = '[' + new Date().toLocaleTimeString() + '] ' + text;
      const list = document.getElementById('logActivity');
      list.prepend(li);
    }

    // --- Crear recurso ---
    document.getElementById('form-create-resource').addEventListener('submit', (e) => {
      e.preventDefault();
      const nombre = document.getElementById('r_nombre').value;
      const tipo = document.getElementById('r_tipo').value;
      const cantidad = +document.getElementById('r_cantidad').value;
      fetch(apiBase + '/recursos', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ nombre, tipo, cantidad })
      })
        .then(r => r.json())
        .then(data => {
          addLog('Recurso creado: ' + data.nombre);
          loadRecursos();
        })
        .catch(err => { console.error(err); addLog('Error creando recurso') });
    });

    // --- Crear ubicación ---
    document.getElementById("form-create-ubicacion").addEventListener("submit", async (event) => {
      event.preventDefault();

      const ubicacion = {
        nombre: document.getElementById("u_nombre").value,
        tipo: document.getElementById("u_tipo").value,
        lat: parseFloat(document.getElementById("u_lat").value),
        lng: parseFloat(document.getElementById("u_lng").value),
        nivelRiesgo: document.getElementById("u_nivelRiesgo").value,
        personasAfectadas: 0
      };

      console.log('Enviando ubicación:', ubicacion);

      try {
        const res = await fetch(apiBase + '/zonas', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(ubicacion)
        });

        const msg = await res.text();

        if (res.status === 409) {
          Swal.fire('Duplicado', msg, 'warning');
        } else if (!res.ok) {
          Swal.fire('Error', 'No se pudo guardar la ubicación', 'error');
        } else {
          const data = JSON.parse(msg);
          addLog('Ubicación creada: ' + data.nombre);
          loadUbicaciones();
          Swal.fire('Éxito', 'Ubicación creada correctamente', 'success');
        }

      } catch (error) {
        console.error('Error:', error);
        Swal.fire('Error', 'Error al crear la ubicación: ' + error.message, 'error');
      }
    });

    // --- Cargar ubicaciones ---
    function loadUbicaciones() {
      fetch(apiBase + '/zonas')
        .then(r => r.json())
        .then(ubicaciones => {
          const tbody = document.querySelector('#tabla-ubicaciones tbody');
          tbody.innerHTML = '';
          ubicaciones.forEach(u => {
            tbody.innerHTML += `
              <tr>
                <td>${u.nombre}</td>
                <td>${u.tipo}</td>
                <td>${u.lng}</td>
                <td>${u.lat}</td>
                <td>${u.nivelRiesgo}</td>
              </tr>
            `;
          });
        })
        .catch(e => console.error('Error cargando ubicaciones:', e));
    }

    document.addEventListener('DOMContentLoaded', loadUbicaciones);

    // --- Crear ruta ---
    document.getElementById("form-create-route").addEventListener('submit', (event) => {
      event.preventDefault();

      const origen = document.getElementById("r_origen").value;
      const destino = document.getElementById("r_destino").value;
      const distancia = document.getElementById("r_distancia").value;

      // Aquí podrías diferenciar por botón si quieres
      fetch(apiBase + '/rutas', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ origen, destino, distancia })
      });
    });

    // --- Cargar recursos ---
    function loadRecursos() {
      fetch(apiBase + '/recursos')
        .then(r => r.json())
        .then(list => {
          const tbody = document.querySelector('#tabla-recursos tbody');
          tbody.innerHTML = '';
          let total = 0;
          list.forEach(r => {
            total += r.cantidad || 0;
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${r.nombre}</td>
              <td>${r.tipo}</td>
              <td>${r.cantidad}</td>
              <td>${r.disponible ? 'Sí' : 'No'}</td>
              <td><button class="btn btn-sm btn-outline-primary" data-id="${r.id}">Asignar</button></td>`;
            tbody.appendChild(tr);
          });
          document.getElementById('totalResources').textContent = total;
        })
        .catch(e => console.warn('No se pudo cargar recursos', e));
    }

    // --- Click en "Ver" zona en la tabla ---
    document.querySelector('#tabla-zonas tbody').addEventListener('click', (e) => {
      const btn = e.target.closest('button[data-id]');
      if (!btn) return;
      const id = btn.dataset.id;
      fetch(apiBase + '/zonas/' + id)
        .then(r => r.json())
        .then(ubicacion => { mostrarUbicacion(ubicacion); })
        .catch(err => console.error('Error al obtener ubicación:', err));
    });

    function mostrarUbicacion(ubicacion) {
      Swal.fire({
        title: 'Ubicación encontrada',
        html: `
          <b>ID:</b> ${ubicacion.id}<br>
          <b>Nombre:</b> ${ubicacion.nombre}<br>
          <b>Latitud:</b> ${ubicacion.lat}<br>
          <b>Longitud:</b> ${ubicacion.lng}<br>
          <b>Nivel de riesgo:</b> ${ubicacion.nivelRiesgo}<br>
          <b>Personas afectadas:</b> ${ubicacion.personasAfectadas}<br>
          <b>Última actualización:</b> ${ubicacion.updatedAt}<br>
        `,
        icon: 'success',
        confirmButtonText: 'OK'
      });
    }

    // --- Cargar zonas ---
    function loadZonas() {
      fetch(apiBase + '/zonas')
        .then(r => r.json())
        .then(list => {
          const tbody = document.querySelector('#tabla-zonas tbody');
          tbody.innerHTML = '';
          zonasLayer.clearLayers();
          list.forEach(z => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${z.nombre}</td>
              <td>${z.tipo}</td>
              <td><span class="badge ${
                z.nivelRiesgo === 'CRITICO' || z.nivelRiesgo === 'ALTO'
                  ? 'badge-risk-high'
                  : z.nivelRiesgo === 'MEDIO'
                  ? 'badge-risk-medium'
                  : 'badge-risk-low'
              }">${z.nivelRiesgo}</span></td>
              <td>${z.personasAfectadas}</td>
              <td>${z.recursosNecesarios?.length || 0}</td>
              <td>${new Date(z.updatedAt || Date.now()).toLocaleString()}</td>
              <td><button class="btn btn-sm btn-outline-secondary" data-id="${z.id}">Ver</button></td>`;
            tbody.appendChild(tr);

            if (z.lat && z.lng) {
              const m = L.circleMarker([z.lat, z.lng], { radius: 8 })
                .bindPopup(`<strong>${z.nombre}</strong><br/>Riesgo: ${z.nivelRiesgo}<br/>Personas: ${z.personasAfectadas}`);
              m.on('click', () => {
                document.getElementById('dz_nombre').textContent = z.nombre;
                document.getElementById('dz_riesgo').textContent = z.nivelRiesgo;
                document.getElementById('dz_personas').textContent = z.personasAfectadas;
                document.getElementById('dz_recursos').textContent = (z.recursosNecesarios || []).map(rr => rr.tipo).join(', ');
              });
              zonasLayer.addLayer(m);
            }
          });
        })
        .catch(e => console.warn('No se pudo cargar zonas', e));
    }

    // --- Inicialización ---
    window.addEventListener('load', () => {
      try { connectWebSocket(); } catch (e) { console.warn('WS init error', e); }
      loadRecursos();
      loadZonas();

      document.getElementById('btn-load-sample').addEventListener('click', () => {
        fetch(apiBase + '/admin/cargar-muestra', { method: 'POST' })
          .then(() => { addLog('Datos de muestra cargados'); loadZonas(); loadRecursos(); })
          .catch(() => addLog('Error cargando datos de muestra'));
      });

      document.getElementById('btn-refresh').addEventListener('click', () => {
        loadRecursos();
        loadZonas();
        addLog('Datos refrescados manualmente');
      });
    });

    function mostrarGrafoTerm() {
      let listaRutas = fetch(apiBase + '/rutas').then(r => r.json());
      listaRutas.forEach(r => {
        console.log(r.origen.nombre + "->" + r.destino.nombre);
      });
    }

    function validarUbicacion(ubicacion) {
      const tiposValidos = ['URBANA', 'RURAL'];
      const nivelesRiesgo = ['BAJO', 'MEDIO', 'ALTO', 'CRITICO'];

      if (!tiposValidos.includes(ubicacion.tipo)) {
        throw new Error('Tipo de ubicación no válido');
      }

      if (!nivelesRiesgo.includes(ubicacion.nivelRiesgo)) {
        throw new Error('Nivel de riesgo no válido');
      }

      if (!ubicacion.nombre || ubicacion.nombre.trim() === '') {
        throw new Error('El nombre es requerido');
      }

      return true;
    }

    // =======================
    //  LOGOUT / CERRAR SESIÓN
    // =======================

    // Botón "Cerrar sesión" del menú superior
    const logoutLink = document.getElementById('menu-logout');
    if (logoutLink) {
      logoutLink.addEventListener('click', (e) => {
        e.preventDefault();
        window.location.href = '/logout';
      });
    }

    // Botón "Salir (apagar demo)" del menú lateral
    const exitLink = document.getElementById('menu-exit');
    if (exitLink) {
      exitLink.addEventListener('click', (e) => {
        e.preventDefault();
        Swal.fire({
          title: 'Cerrar sesión',
          text: '¿Seguro que quieres salir de la demo?',
          icon: 'warning',
          showCancelButton: true,
          confirmButtonText: 'Sí, salir',
          cancelButtonText: 'Cancelar'
        }).then((result) => {
          if (result.isConfirmed) {
            window.location.href = '/logout';
          }
        });
      });
    }
  </script>

  
</body>

</html>