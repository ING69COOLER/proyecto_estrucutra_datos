<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sistema Gesti√≥n de Desastres Naturales ‚Äî OPERADOR</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Leaflet CSS (mapa open-source) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <!-- Font Awesome (√≠conos) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />

  <style>
    body {
      background: #f8f9fa;
    }

    #map {
      height: 600px;
      min-height: 400px;
      width: 100%;
      border-radius: 6px;
    }

    .sidebar {
      max-height: 85vh;
      overflow-y: auto;
    }

    .tab-section {
      display: none;
    }

    .tab-section.active {
      display: block;
    }

    .small-muted {
      font-size: 0.85rem;
      color: #6c757d;
    }

    .card-map {
      height: 100%;
    }

    .badge-risk-low {
      background: #198754;
    }

    .badge-risk-medium {
      background: #ffc107;
      color: #000;
    }

    .badge-risk-high {
      background: #dc3545;
    }
  </style>
</head>

<body>
  <!-- NAVBAR -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">SGD - Gesti√≥n Desastres (Operador)</a>

      <div class="d-flex align-items-center">
        <!-- Estado WebSocket -->
        <span id="wsStatus" class="badge bg-secondary me-2">WS: desconectado</span>

        <!-- Usuario actual -->
        <span id="currentUser" class="text-light small me-3"></span>

        <!-- Bot√≥n refrescar -->
        <button class="btn btn-outline-light btn-sm me-2" id="btn-refresh">Refrescar datos</button>

        <!-- Men√∫ de cuenta -->
        <div class="dropdown">
          <a class="btn btn-outline-light dropdown-toggle" data-bs-toggle="dropdown" href="#" role="button"
             aria-expanded="false">
            <i class="fa fa-user"></i> Cuenta
          </a>
          <ul class="dropdown-menu dropdown-menu-end">
            <li><a class="dropdown-item" href="#" id="menu-logout">Cerrar sesi√≥n</a></li>
          </ul>
        </div>
      </div>
    </div>
  </nav>

  <!-- LAYOUT PRINCIPAL -->
  <div class="container-fluid mt-3">
    <div class="row">

      <!-- SIDEBAR -->
      <aside class="col-md-3">
        <div class="card sidebar p-2">
          <h5 class="mb-2">Men√∫</h5>
          <div class="list-group">
            <a href="#" class="list-group-item list-group-item-action active" data-tab="inicio">Inicio</a>
            <!-- üëá NUEVO: Panel Rutas visible para OPERADOR -->
            <a href="#" class="list-group-item list-group-item-action" data-tab="panel-rutas">Panel Rutas</a>
            <!-- DESPU√âS de "Panel Rutas" -->
            <a href="#" class="list-group-item list-group-item-action" data-tab="reportes-operador">Reportes</a>
            <a href="#" class="list-group-item list-group-item-action" data-tab="carga-datos">Carga Inicial</a>
            <a href="#" class="list-group-item list-group-item-action text-danger" id="menu-exit">
              Salir (apagar demo)
            </a>
          </div>

          <hr>
          <h6 class="mt-2">Conexiones</h6>
          <p class="small-muted">Backend: <span id="backendUrl">http://localhost:8081/api</span></p>
          <p class="small-muted">WebSocket: <span id="wsUrl">ws://localhost:8081/ws</span></p>
        </div>
      </aside>

      <!-- CONTENIDO PRINCIPAL -->
      <main class="col-md-9">
        <!-- INICIO -->
        <section id="inicio" class="tab-section active">
          <div class="row g-3">
            <div class="col-lg-8">
              <div class="card card-map p-3">
                <h5>Vista general</h5>
                <p class="small-muted mb-2">Resumen de zonas afectadas y recursos disponibles.</p>

                <!-- Indicadores -->
                <div class="row mb-3">
                  <div class="col-sm-4">
                    <div class="card p-2">
                      <h6>Zonas cr√≠ticas</h6>
                      <p id="countCritical" class="display-6 m-0">0</p>
                    </div>
                  </div>
                  <div class="col-sm-4">
                    <div class="card p-2">
                      <h6>Personas evacuadas</h6>
                      <p id="totalEvacuated" class="display-6 m-0">0</p>
                    </div>
                  </div>
                  <div class="col-sm-4">
                    <div class="card p-2">
                      <h6>Recursos en almac√©n</h6>
                      <p id="totalResources" class="display-6 m-0">0</p>
                    </div>
                  </div>
                </div>

                <!-- Tabla zonas -->
                <div>
                  <h6>Zonas afectadas</h6>
                  <div class="table-responsive">
                    <table class="table table-striped table-sm" id="tabla-zonas">
                      <thead>
                        <tr>
                          <th>Zona</th>
                          <th>Tipo</th>
                          <th>Riesgo</th>
                          <th>Personas</th>
                          <th>Recursos Necesarios</th>
                          <th>√öltima actualizaci√≥n</th>
                          <th>Acciones</th>
                        </tr>
                      </thead>
                      <tbody>
                        <!-- Se rellena din√°micamente -->
                      </tbody>
                    </table>
                  </div>
                </div>

              </div>
            </div>

            <!-- Panel derecho -->
            <div class="col-lg-4">
              <div class="card p-2 mb-3">
                <h6>Actividad reciente</h6>
                <ul id="logActivity" class="list-group list-group-flush small" style="max-height:280px; overflow:auto;">
                  <!-- Logs -->
                </ul>
              </div>

              <div class="card p-2">
                <h6>Filtros r√°pidos</h6>
                <div class="mb-2">
                  <label class="form-label">Nivel de riesgo</label>
                  <select id="filterRisk" class="form-select form-select-sm">
                    <option value="">Todos</option>
                    <option value="BAJO">Bajo</option>
                    <option value="MEDIO">Medio</option>
                    <option value="ALTO">Alto</option>
                    <option value="CRITICO">Cr√≠tico</option>
                  </select>
                </div>
                <button class="btn btn-primary btn-sm w-100" id="btn-apply-filters">Aplicar</button>
              </div>
            </div>

          </div>
        </section>

        <!-- NUEVO: PANEL RUTAS  -->
        <section id="panel-rutas" class="tab-section">
          
          <div class="row g-3">
            
            <div class="col-md-8">
              <h4 class="mb-3">Mapa General de Operaciones</h4>
              <p class="text-muted small">Vista de todas las ubicaciones (marcadores) y rutas (l√≠neas). Haz clic en la lista de prioridad para centrar el mapa.</p>
              <div id="map-crear-ruta" style="height: 700px; border-radius: 8px; z-index: 1;"></div>
            </div>

            <div class="col-md-4">
              <h4 class="mb-3">Ubicaciones Prioritarias</h4>
              <p class="text-muted small">Ubicaciones ordenadas por la cola de prioridad del backend (de mayor a menor urgencia).</p>
              
              <!-- Selector destino para trazar caminos -->
              <div class="mb-2">
                <label class="form-label">Destino para trazado</label>
                <div class="input-group">
                  <select id="selectDestinoPaths" class="form-select form-select-sm">
                    <option value="">Cargando destinos...</option>
                  </select>
                    <button id="btn-trazar-caminos" class="btn btn-sm btn-primary">Trazar</button>
                    <button id="btn-show-all-routes" class="btn btn-sm btn-outline-secondary" title="Mostrar todas las rutas">Mostrar todas</button>
                </div>
              </div>

              <div class="list-group" id="lista-prioridad" style="max-height: 600px; overflow-y: auto;">
              </div>
            </div>

          </div>
        </section>

        <!-- Estad√≠sticas y Mapa eliminados para versi√≥n Operador simplificada -->

        <!-- Simulador eliminado en versi√≥n Operador -->

        <!-- CARGA DE DATOS -->
        <section id="carga-datos" class="tab-section">
          <div class="card p-3">
            <h5>Carga de datos iniciales</h5>
            <p class="small-muted">Sube un archivo JSON con zonas, rutas y recursos, o pulsa el bot√≥n para cargar datos de prueba.</p>

            <div class="mb-3">
              <input type="file" id="fileLoad" accept=".json" class="form-control form-control-sm" />
            </div>
            <div class="d-flex gap-2">
              <button id="btn-load-file" class="btn btn-primary btn-sm">Cargar archivo</button>
              <button id="btn-load-sample" class="btn btn-outline-secondary btn-sm">Cargar datos de muestra</button>
              <button id="btn-clear-data" class="btn btn-outline-danger btn-sm">Limpiar datos</button>
            </div>
            <hr>
            <small class="text-muted">Formato JSON esperado: { "zonas":[...], "rutas":[...], "recursos":[...] }</small>
          </div>
        </section>

        <!-- ========================================
             SECCI√ìN: REPORTES (OPERADOR)
        ========================================= -->
        <section id="reportes-operador" class="tab-section">
          <h4 class="mb-3">Reportes de Recursos</h4>
          <p class="text-muted">Consulta el estado de recursos y zonas (solo lectura).</p>

          <div class="row g-3">
            
            <div class="col-md-3">
              <div class="card p-3 text-center">
                <h6>Zonas Cr√≠ticas</h6>
                <p id="op_stat_criticas" class="display-6 m-0">-</p>
              </div>
            </div>

            <div class="col-md-3">
              <div class="card p-3 text-center">
                <h6>Total Distribuciones</h6>
                <p id="op_stat_dist" class="display-6 m-0">-</p>
              </div>
            </div>

            <div class="col-md-3">
              <div class="card p-3 text-center">
                <h6>Recursos Distribuidos</h6>
                <p id="op_stat_recursos" class="display-6 m-0">-</p>
              </div>
            </div>

            <div class="col-md-3">
              <div class="card p-3 text-center">
                <h6>Personas Afectadas</h6>
                <p id="op_stat_personas" class="display-6 m-0">-</p>
              </div>
            </div>

          </div>

          <div class="row g-3 mt-3">
            
            <div class="col-md-6">
              <div class="card p-3">
                <h5>Balance de Recursos</h5>
                <canvas id="op-chart-recursos" style="max-height: 300px;"></canvas>
              </div>
            </div>

            <div class="col-md-6">
              <div class="card p-3">
                <h5>Distribuci√≥n de Riesgos</h5>
                <canvas id="op-chart-riesgos" style="max-height: 300px;"></canvas>
              </div>
            </div>

          </div>

          <div class="card p-3 mt-3">
            <h5>Historial Reciente de Distribuciones</h5>
            <div class="table-responsive">
              <table class="table table-sm table-striped" id="op-tabla-historial">
                <thead>
                  <tr>
                    <th>Fecha</th>
                    <th>Origen</th>
                    <th>Destino</th>
                    <th>Recurso</th>
                    <th>Cantidad</th>
                    <th>Distancia (km)</th>
                    <th>Estado</th>
                  </tr>
                </thead>
                <tbody>
                  <!-- Din√°mico -->
                </tbody>
              </table>
            </div>
          </div>
        </section>

      </main>
    </div>
  </div>

  <!-- SCRIPTS: librer√≠as -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <!-- STOMP + SockJS -->
  <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.7.5/dist/sockjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@stomp/stompjs@7.0.0/bundles/stomp.umd.min.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  
  <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <!-- JS principal -->
 <script>
    const apiBase = document.getElementById('backendUrl').textContent;
    const wsBase = document.getElementById('wsUrl').textContent;

    // --- Variables Globales para el Mapa de Rutas ---
    let crMap = null; // El objeto mapa
    let crRouteControls = []; // Para guardar las rutas (polylines)
    let crMarkersLayer = L.layerGroup(); // Capa para los marcadores
    let crMarkers = []; // Array para 'buscar' marcadores (Marker Lookup)
    let crMapInitialized = false; 
    let crPathLayers = []; // Polylines generadas al trazar caminos hacia un destino

    // =============================
    //  NAVEGACI√ìN DE PESTA√ëAS
    // =============================
    document.querySelectorAll('.list-group .list-group-item').forEach(a => {
      a.addEventListener('click', (e) => {
        e.preventDefault();
        const tab = a.getAttribute('data-tab');
        if (!tab) return;

        document.querySelectorAll('.list-group .list-group-item').forEach(x => x.classList.remove('active'));
        a.classList.add('active');

        document.querySelectorAll('.tab-section').forEach(s => s.classList.remove('active'));
        document.getElementById(tab).classList.add('active');

        if (tab === 'panel-rutas' && !crMapInitialized) {
          console.log("‚ñ∂Ô∏è Detectado clic en 'Panel Rutas', iniciando mapa...");
          initCrearRutaMap();
          crMapInitialized = true;
          // Llenar dropdown de destinos una vez que el mapa de rutas se inicializa
          setTimeout(populateDestinationDropdownForPaths, 200);
          // Conectar botones de trazado/restaurar rutas
          setTimeout(() => {
            const btnTrazar = document.getElementById('btn-trazar-caminos');
            if (btnTrazar) btnTrazar.addEventListener('click', () => {
              const sel = document.getElementById('selectDestinoPaths');
              if (sel) trazarCaminosHaciaDestino(sel.value);
            });

            const btnRestore = document.getElementById('btn-show-all-routes');
            if (btnRestore) btnRestore.addEventListener('click', () => restoreAllRoutes());
          }, 300);
        } else if (tab === 'panel-rutas') {
           console.log("‚ñ∂Ô∏è Entrando a 'Panel Rutas' (mapa ya inicializado). Refrescando tama√±o.");
           setTimeout(() => crMap.invalidateSize(), 150);
        }

        if (tab === 'reportes-operador') {
          setTimeout(() => {
            cargarReportesOperador();
          }, 100);
        }
      });
    });

    // =============================
    //    MAPA PANEL DE RUTAS
    // =============================

    // 1. Funci√≥n para Inicializar el mapa
    function initCrearRutaMap() {
      console.log("üó∫Ô∏è 1. initCrearRutaMap() - INICIANDO MAPA en #map-crear-ruta");
      crMap = L.map("map-crear-ruta").setView([4.65, -74.1], 12);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { maxZoom: 19 }).addTo(crMap);
      crMarkersLayer.addTo(crMap);
      console.log("üó∫Ô∏è 2. initCrearRutaMap() - Mapa base creado. Llamando a loadAllData...");
      loadAllData();
    }

    // 2. Funci√≥n para cargar TODOS los datos (Ubicaciones, Rutas y Prioridad)
    async function loadAllData() {
      if (!crMap) return;
      console.log("üöö 3. loadAllData() - Empezando a buscar 3 endpoints...");
      
      limpiarRutasYLista();
      
      try {
        // correccion
        const [ubicaciones, rutas, ubicacionesP] = await Promise.all([
          fetch(apiBase + "/zonas").then(res => res.json()),
          fetch(apiBase + "/rutas").then(res => res.json()),
          fetch(apiBase + "/zonas/prioridad").then(res => res.json()) // <-- URL CORREGIDA
        ]);

        console.log(`‚úÖ 4. DATOS RECIBIDOS: ${ubicaciones.length} u, ${rutas.length} r, ${ubicacionesP.length} prioritarias`);

        // Pinta los marcadores (de /zonas) y centra el mapa
        pintarMarcadores(ubicaciones);
        
        // Pinta las rutas (de /rutas)
        trazarRutas(rutas);

        // ¬°PUEBLA LA LISTA! (de /prioridad)
        poblarListaPrioridad(ubicacionesP);

        setTimeout(() => crMap.invalidateSize(), 150);

      } catch (error) {
        console.error("‚ùå ERROR FATAL en loadAllData (fetch):", error);
      }
    }

    // 3. ‚úÖ NUEVO: Funci√≥n para pintar S√ìLO los marcadores
    function pintarMarcadores(ubicaciones) {
        crMarkersLayer.clearLayers();
        crMarkers = []; // Limpia el array de b√∫squeda
        const bounds = [];
        
        ubicaciones.forEach(u => {
          if (u.lat && u.lng) {
            const marker = L.marker([u.lat, u.lng])
              .bindPopup(`<b>${u.nombre}</b><br>${u.tipo || ''}`)
              .addTo(crMarkersLayer);
            
            marker.data = u; // Guarda el objeto Ubicacion
            
            // ‚úÖ Conecta el clic del marcador a la lista
            marker.on('click', () => handleMarkerClick(u)); 
            
            crMarkers.push(marker); // A√±ade al array de b√∫squeda
            bounds.push([u.lat, u.lng]);
          }
        });
        
        // Centra el mapa para mostrar todos los marcadores
        if (bounds.length > 0) {
          crMap.fitBounds(bounds, { padding: [50, 50] });
        }
        console.log(`üñåÔ∏è 5. pintarMarcadores() - ${ubicaciones.length} marcadores pintados.`);
    }

    // ----- Manejo de caminos desde varios or√≠genes hasta un destino -----
    function clearPathLayers() {
      if (!crMap) return;
      crPathLayers.forEach(l => { if (crMap && l) crMap.removeLayer(l); });
      crPathLayers = [];
    }

    async function trazarCaminosHaciaDestino(destId) {
      if (!destId) {
        Swal.fire('Aviso', 'Selecciona un destino v√°lido.', 'warning');
        return;
      }

      try {
        const res = await fetch(apiBase + '/zonas/caminos/' + destId);
        if (!res.ok) {
          const text = await res.text();
          throw new Error(text || ('HTTP ' + res.status));
        }

        const caminos = await res.json();
        if (!Array.isArray(caminos) || caminos.length === 0) {
          Swal.fire('Informaci√≥n', 'No se encontraron caminos hacia ese destino.', 'info');
          clearPathLayers();
          return;
        }

        clearPathLayers();

        // Ocultar las rutas generales (crRouteControls) para mostrar s√≥lo los caminos hacia el destino
        if (Array.isArray(crRouteControls)) {
          crRouteControls.forEach(line => { try { if (crMap && line) crMap.removeLayer(line); } catch(e){}});
        }
        const bounds = [];
        const palette = ['blue','green','purple','orange','teal','magenta'];

        // Determinar la distancia m√≠nima (si hay m√∫ltiples caminos por compatibilidad)
        const minDist = caminos.length > 0 ? Math.min(...caminos.map(c => (c.distanciaMinima != null ? c.distanciaMinima : Infinity))) : Infinity;

        caminos.forEach((cam, idx) => {
          const ubicaciones = cam.caminoUbicaciones || [];
          const latlngs = ubicaciones
            .filter(u => u && u.lat && u.lng)
            .map(u => [u.lat, u.lng]);

          if (latlngs.length < 2) return;
          // Si este camino es el m√°s corto, resaltarlo en rojo y m√°s grueso
          const isShortest = (cam.distanciaMinima != null && cam.distanciaMinima === minDist);
          const color = isShortest ? '#d9534f' : palette[idx % palette.length];
          const weight = isShortest ? 7 : 4;
          const opacity = isShortest ? 1.0 : 0.85;

          const pl = L.polyline(latlngs, { color, weight, opacity }).addTo(crMap);

          // Preparar HTML para recursos asignados (disponibles o necesarios)
          const recursos = cam.origen?.recursosDisponibles || cam.origen?.recursosNecesarios || [];
          let recursosHtml = '';
          if (Array.isArray(recursos) && recursos.length > 0) {
            recursosHtml = '<br/><b>Recursos:</b><br/>' + recursos.map(r => {
              const nombre = r?.nombre || r?.tipo || 'Recurso';
              const cantidad = (r?.cantidad != null) ? r.cantidad : 'N/A';
              return `${nombre}: ${cantidad}`;
            }).join('<br/>');
          }

          pl.bindPopup(`<b>Origen:</b> ${cam.origen?.nombre || 'N/A'}<br/><b>Distancia:</b> ${cam.distanciaMinima?.toFixed(2) || 'N/A'} km${isShortest ? ' <br><i>(camino m√°s corto)</i>' : ''}${recursosHtml}`);
          crPathLayers.push(pl);
          latlngs.forEach(p => bounds.push(p));
        });

        if (bounds.length > 0) crMap.fitBounds(bounds, { padding: [40, 40] });

      } catch (error) {
        console.error('Error trazando caminos:', error);
        Swal.fire('Error', 'No se pudieron obtener los caminos: ' + error.message, 'error');
      }
    }

    // Restaurar las rutas generales al mapa (si fueron ocultadas)
    function restoreAllRoutes() {
      if (!crMap || !Array.isArray(crRouteControls)) return;
      crRouteControls.forEach(line => { try { if (line && !crMap.hasLayer(line)) line.addTo(crMap); } catch(e){} });
    }

    async function populateDestinationDropdownForPaths() {
      const sel = document.getElementById('selectDestinoPaths');
      if (!sel) return;
      sel.disabled = true;
      try {
        const res = await fetch(apiBase + '/zonas');
        if (!res.ok) {
          sel.innerHTML = '<option value="">Error cargando destinos</option>';
          return;
        }
        const list = await res.json();
        if (!Array.isArray(list) || list.length === 0) {
          sel.innerHTML = '<option value="">No hay destinos</option>';
          return;
        }
        sel.innerHTML = '<option value="">Selecciona un destino</option>';
        list.forEach(u => {
          const opt = document.createElement('option');
          opt.value = u.id;
          opt.textContent = `${u.nombre} (${u.nivelRiesgo || ''})`;
          sel.appendChild(opt);
        });
      } catch (e) {
        console.error('Error cargando destinos:', e);
        sel.innerHTML = '<option value="">Error cargando destinos</option>';
      } finally {
        sel.disabled = false;
      }
    }

    // En tu bloque <script> principal

      // La funci√≥n original de limpieza
    function limpiarRutasYLista() {
    // 1. Limpiar l√≠neas de rutas (el array crRouteControls)
      crRouteControls.forEach(linea => {
          if(crMap) crMap.removeLayer(linea); 
      });
      crRouteControls = [];
    
      // 2. ‚úÖ AHORA TAMBI√âN LLAMA AL BORRADO DE MARCADORES
      limpiarMarcadores(); // <-- NUEVA L√çNEA

      // 3. Limpiar el resto de variables y la lista HTML
      selectedPolyline = null;
      const lista = document.getElementById('lista-prioridad');
      if (lista) {
          lista.innerHTML = '<p class="text-muted small p-2">Cargando...</p>';
      }
    }

    /**
    * Borra todos los marcadores (puntos/ubicaciones) del mapa.
    */
    function limpiarMarcadores() {
      // La capa 'crMarkersLayer' contiene todos los marcadores.
        if (crMarkersLayer) {
            crMarkersLayer.clearLayers();
        }
        // Tambi√©n reseteamos el array de b√∫squeda
        crMarkers = [];
        console.log("üóëÔ∏è Marcadores borrados del mapa.");
    }

    // 4. Funci√≥n para trazar todas las rutas (Versi√≥n L√≠nea Recta)
    function trazarRutas(rutas) {
      console.log(`üöó 6. trazarRutas() - Dibujando ${rutas.length} rutas (l√≠nea recta).`);
      
      rutas.forEach(ruta => {
        if (!ruta.origen || !ruta.destino || !ruta.origen.lat || !ruta.destino.lat) {
          console.warn(`‚ö†Ô∏è RUTA SALTADA (ID: ${ruta.id}): Datos incompletos.`);
          return;
        }

        const p1 = L.latLng(ruta.origen.lat, ruta.origen.lng);
        const p2 = L.latLng(ruta.destino.lat, ruta.destino.lng);

        const polyline = L.polyline([p1, p2], {
          color: 'blue',
          opacity: 0.7,
          weight: 5
        }).addTo(crMap);

        polyline.data = ruta;
        polyline.on('click', (event) => handleRutaClick(event.target.data));
        polyline.bindTooltip(`Ruta de ${ruta.origen.nombre} a ${ruta.destino.nombre}`, { sticky: true });
        
        crRouteControls.push(polyline); // Guardamos la polyline para borrarla
      });
      
      console.log("‚úÖ 7. trazarRutas() - Todas las rutas dibujadas.");
    }
    
    // 5. ‚úÖ NUEVA FUNCI√ìN: Poblar la lista de la derecha (de /prioridad)
    function poblarListaPrioridad(ubicacionesP) {
      const lista = document.getElementById('lista-prioridad'); // <-- ID Correcto
      if (!lista) return;

      lista.innerHTML = ''; // Limpiar lista
      
      if (ubicacionesP.length === 0) {
        lista.innerHTML = '<p class="text-muted small p-2">Cola de prioridad est√° vac√≠a.</p>';
        return;
      }
      
      ubicacionesP.forEach((u, index) => {
        const li = document.createElement('a');
        li.href = '#';
        li.className = 'list-group-item list-group-item-action';
        li.dataset.ubicacionId = u.id; // Guardamos el ID
        
        li.innerHTML = `
          <strong>${index + 1}. ${u.nombre}</strong>
          <span class="badge ${getRiskBadgeClass(u.nivelRiesgo)} float-end" style="margin-left: 5px;">${u.nivelRiesgo}</span>
          <br>
          <span class="small-muted">Personas: ${u.personasAfectadas}</span>
        `;
        
        // ‚úÖ Conectar el clic de la lista al mapa
        li.addEventListener('click', (e) => {
          e.preventDefault();
          handleListItemClick(u);
        });
        
        lista.appendChild(li);
      });
      console.log(`üìã 8. poblarListaPrioridad() - ${ubicacionesP.length} √≠tems de prioridad poblados.`);
    }

    // 6. ‚úÖ FUNCI√ìN MODIFICADA: Handler para clic en la LISTA
    function handleListItemClick(ubicacion) {
      console.log("Clic en LISTA para Ubicacion ID:", ubicacion.id);

      // Buscar el marcador en el mapa que corresponde a esta ubicacion
      const marker = crMarkers.find(m => m.data.id === ubicacion.id);

      if (marker) {
        // Centra el mapa y hace zoom
        crMap.flyTo(marker.getLatLng(), 15); 
        marker.openPopup();
      }
      
      highlightListItem(ubicacion.id);
    }
    
    // 7. ‚úÖ NUEVA FUNCI√ìN: Handler para clic en el MARCADOR
    function handleMarkerClick(ubicacion) {
      console.log("Clic en MARCADOR para Ubicacion ID:", ubicacion.id);
      highlightListItem(ubicacion.id);
    }

    // 8. FUNCI√ìN MODIFICADA: Handler para clic en la RUTA (Polyline)
    function handleRutaClick(ruta) {
      console.log("Clic en MAPA para Ruta ID:", ruta.id);
      
      // Resaltar la l√≠nea (busc√°ndola por si acaso)
      const polyline = crRouteControls.find(linea => linea.data.id === ruta.id);
      if (polyline) {
        highlightPolyline(polyline);
      }
      
      // Ya no resalta la lista, solo muestra el popup
      Swal.fire({
        title: 'Detalle de la Ruta',
        html: `
          <b>ID:</b> ${ruta.id}<br>
          <b>Origen:</b> ${ruta.origen.nombre}<br>
          <b>Destino:</b> ${ruta.destino.nombre}<br>
          <b>Distancia:</b> ${ruta.distancia ? ruta.distancia.toFixed(2) : 'N/A'} km
        `,
        icon: 'info'
      });
    }

    // 9. ‚úÖ NUEVAS FUNCIONES AYUDANTES (Helpers)
    function highlightListItem(ubicacionId) {
      document.querySelectorAll('#lista-prioridad .list-group-item').forEach(item => {
        item.classList.remove('active');
      });
      const itemSeleccionado = document.querySelector(`#lista-prioridad [data-ubicacion-id="${ubicacionId}"]`);
      if (itemSeleccionado) {
        itemSeleccionado.classList.add('active');
        itemSeleccionado.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      }
    }

    let selectedPolyline = null;
    function highlightPolyline(polyline) {
      if (selectedPolyline) {
        selectedPolyline.setStyle({ color: 'blue', opacity: 0.7, weight: 5 });
      }
      polyline.setStyle({ color: 'red', opacity: 1.0, weight: 7 });
      polyline.bringToFront();
      selectedPolyline = polyline;
    }
    
    function getRiskBadgeClass(riesgo) {
      if (riesgo === 'CRITICO' || riesgo === 'ALTO') return 'badge-risk-high text-white'; // A√±adido text-white
      if (riesgo === 'MEDIO') return 'badge-risk-medium';
      return 'badge-risk-low text-white'; // A√±adido text-white
    }

    // 10. ‚úÖ FUNCI√ìN MODIFICADA: Limpiar
    function limpiarRutasYLista() {
      crRouteControls.forEach(linea => {
        if(crMap) crMap.removeLayer(linea);
      });
      crRouteControls = [];
      selectedPolyline = null;
      
      const lista = document.getElementById('lista-prioridad'); // <-- ID Correcto
      if (lista) {
        lista.innerHTML = '<p class="text-muted small p-2">Cargando...</p>';
      }
    }
    
    // --- (AQU√ç VA EL RESTO DE TU C√ìDIGO JS, SIN CAMBIOS) ---
    
    function connectWebSocket() {
      console.log("Intentando conectar WebSocket...");
      // document.getElementById('wsStatus').textContent = 'WS: conectado';
    }

    function addLog(text) {
      const li = document.createElement('li');
      li.className = 'list-group-item';
      li.textContent = '[' + new Date().toLocaleTimeString() + '] ' + text;
      const list = document.getElementById('logActivity');
      if (list) list.prepend(li);
    }

    function loadRecursos() {
      fetch(apiBase + '/recursos')
        .then(r => r.json())
        .then(list => {
          let total = 0;
          list.forEach(r => {
            total += r.cantidad || 0;
          });
          const totalSpan = document.getElementById('totalResources');
          if (totalSpan) {
            totalSpan.textContent = total;
          }
        })
        .catch(e => console.warn('No se pudo cargar recursos', e));
    }
    
    let map;
    let zonasLayer;
    let rutasLayer;

    function initInteractiveMap() {
        if (!document.getElementById('map')) return; 
        map = L.map('map').setView([4.5709, -74.2973], 6);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);
        zonasLayer = L.layerGroup().addTo(map);
        rutasLayer = L.layerGroup().addTo(map);
    }
    
    function loadZonas() {
      fetch(apiBase + '/zonas')
        .then(r => r.json())
        .then(list => {
          const tbody = document.querySelector('#tabla-zonas tbody');
          if (!tbody) return;
          
          tbody.innerHTML = '';
          if (zonasLayer) zonasLayer.clearLayers();

          let countCritical = 0;
          let totalEvacuated = 0;

          list.forEach(z => {
            if (z.nivelRiesgo === 'CRITICO') countCritical++;
            totalEvacuated += z.personasAfectadas || 0;

            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${z.nombre}</td>
              <td>${z.tipo}</td>
              <td><span class="badge ${getRiskBadgeClass(z.nivelRiesgo)}">${z.nivelRiesgo}</span></td>
              <td>${z.personasAfectadas}</td>
              <td>${z.recursosNecesarios?.length || 0}</td>
              <td>${new Date(z.updatedAt || Date.now()).toLocaleString()}</td>
              <td><button class="btn btn-sm btn-outline-secondary" data-id="${z.id}">Ver</button></td>`;
            tbody.appendChild(tr);

            if (zonasLayer && z.lat && z.lng) {
              const m = L.circleMarker([z.lat, z.lng], { radius: 8 })
                .bindPopup(`<strong>${z.nombre}</strong><br/>Riesgo: ${z.nivelRiesgo}<br/>Personas: ${z.personasAfectadas}`);
              m.on('click', () => {
                document.getElementById('dz_nombre').textContent = z.nombre;
                document.getElementById('dz_riesgo').textContent = z.nivelRiesgo;
                document.getElementById('dz_personas').textContent = z.personasAfectadas;
                document.getElementById('dz_recursos').textContent = (z.recursosNecesarios || []).map(rr => rr.tipo).join(', ');
              });
              zonasLayer.addLayer(m);
            }
          });

          if(document.getElementById('countCritical')) {
            document.getElementById('countCritical').textContent = countCritical;
          }
          if(document.getElementById('totalEvacuated')) {
            document.getElementById('totalEvacuated').textContent = totalEvacuated;
          }
        })
        .catch(e => console.warn('No se pudo cargar zonas', e));
    }

    const tbodyZonas = document.querySelector('#tabla-zonas tbody');
    if (tbodyZonas) {
      tbodyZonas.addEventListener('click', (e) => {
        const btn = e.target.closest('button[data-id]');
        if (!btn) return;
        const id = btn.dataset.id;
        fetch(apiBase + '/zonas/' + id)
          .then(r => r.json())
          .then(ubicacion => { mostrarUbicacion(ubicacion); })
          .catch(err => console.error('Error al obtener ubicaci√≥n:', err));
      });
    }

    function mostrarUbicacion(ubicacion) {
      Swal.fire({
        title: 'Ubicaci√≥n',
        html: `
          <b>ID:</b> ${ubicacion.id}<br>
          <b>Nombre:</b> ${ubicacion.nombre}<br>
          <b>Latitud:</b> ${ubicacion.lat}<br>
          <b>Longitud:</b> ${ubicacion.lng}<br>
          <b>Nivel de riesgo:</b> ${ubicacion.nivelRiesgo}<br>
          <b>Personas afectadas:</b> ${ubicacion.personasAfectadas}<br>
          <b>√öltima actualizaci√≥n:</b> ${ubicacion.updatedAt}<br>
        `,
        icon: 'info',
        confirmButtonText: 'OK'
      });
    }

    function loadRutas() {
      fetch(apiBase + '/rutas')
        .then(r => r.json())
        .then(list => {
          if (!rutasLayer) return;
          rutasLayer.clearLayers(); 

          list.forEach(ruta => {
            if (ruta.origen && ruta.destino && ruta.origen.lat && ruta.destino.lat) {
              const p1 = [ruta.origen.lat, ruta.origen.lng];
              const p2 = [ruta.destino.lat, ruta.destino.lng];
              L.polyline([p1, p2], { color: 'gray', weight: 2, dashArray: '5, 5' })
               .bindPopup(`Ruta ${ruta.id}`)
               .addTo(rutasLayer);
            }
          });
        })
        .catch(e => console.warn('No se pudo cargar rutas', e));
    }

    function cargarUsuarioActual() {
      const userSpan = document.getElementById("currentUser");
      if (!userSpan) return;

      fetch("/api/usuario/actual")
        .then((res) => {
          if (!res.ok) {
            throw new Error("No autenticado");
          }
          return res.json();
        })
        .then((user) => {
          if (!user) return;
          const rolLabel = user.rol === "ADMINISTRADOR" ? "Admin" : "Operador";
          userSpan.textContent = `${rolLabel}: ${user.nombre} (${user.email})`;
        })
        .catch((err) => {
          console.warn("No se pudo cargar el usuario actual:", err);
          userSpan.textContent = 'Usuario no autenticado';
        });
    }

    function configurarLogout() {
      const logoutLink = document.getElementById('menu-logout');
      if (logoutLink) {
        logoutLink.addEventListener('click', (e) => {
          e.preventDefault();
          window.location.href = '/logout';
        });
      }

      const exitLink = document.getElementById('menu-exit');
      if (exitLink) {
        exitLink.addEventListener('click', (e) => {
          e.preventDefault();
          Swal.fire({
            title: 'Cerrar sesi√≥n',
            text: '¬øSeguro que quieres salir de la demo?',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'S√≠, salir',
            cancelButtonText: 'Cancelar'
          }).then((result) => {
            if (result.isConfirmed) {
              window.location.href = '/logout';
            }
          });
        });
      }
    }

    // ========================================
    //   REPORTES PARA OPERADOR
    // ========================================

    let opChartRecursos = null;
    let opChartRiesgos = null;

    async function cargarReportesOperador() {
      await cargarEstadisticasOperador();
      await cargarGraficosOperador();
      await cargarHistorialOperador();
    }

    async function cargarEstadisticasOperador() {
      try {
        // Zonas cr√≠ticas
        const resZonas = await fetch(apiBase + '/reportes/zonas-criticas');
        const dataZonas = await resZonas.json();
        
        document.getElementById('op_stat_criticas').textContent = 
          (dataZonas.distribucionRiesgo?.CRITICO || 0) + (dataZonas.distribucionRiesgo?.ALTO || 0);
        
        document.getElementById('op_stat_personas').textContent = 
          dataZonas.totalPersonasAfectadas || 0;
        
        // Distribuciones
        const resDist = await fetch(apiBase + '/reportes/distribuciones');
        const dataDist = await resDist.json();
        
        document.getElementById('op_stat_dist').textContent = dataDist.totalDistribuciones || 0;
        document.getElementById('op_stat_recursos').textContent = dataDist.totalRecursosDistribuidos || 0;
        
      } catch (error) {
        console.error('Error cargando estad√≠sticas operador:', error);
      }
    }

    async function cargarGraficosOperador() {
      try {
        // Gr√°fico de recursos
        const resRecursos = await fetch(apiBase + '/reportes/recursos-por-zona');
        const dataRecursos = await resRecursos.json();
        
        const labels = [...new Set(dataRecursos.map(r => r.ubicacionNombre))].slice(0, 8);
        const disponibles = labels.map(label => {
          return dataRecursos
            .filter(r => r.ubicacionNombre === label)
            .reduce((sum, r) => sum + r.disponibles, 0);
        });
        const necesarios = labels.map(label => {
          return dataRecursos
            .filter(r => r.ubicacionNombre === label)
            .reduce((sum, r) => sum + r.necesarios, 0);
        });
        
        crearGraficoRecursosOperador(labels, disponibles, necesarios);
        
        // Gr√°fico de riesgos
        const resZonas = await fetch(apiBase + '/reportes/zonas-criticas');
        const dataZonas = await resZonas.json();
        
        crearGraficoRiesgosOperador(dataZonas.distribucionRiesgo);
        
      } catch (error) {
        console.error('Error cargando gr√°ficos operador:', error);
      }
    }

    function crearGraficoRecursosOperador(labels, disponibles, necesarios) {
      const ctx = document.getElementById('op-chart-recursos');
      if (!ctx) return;
      
      if (opChartRecursos) opChartRecursos.destroy();
      
      opChartRecursos = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'Disponibles',
              data: disponibles,
              backgroundColor: 'rgba(40, 167, 69, 0.7)'
            },
            {
              label: 'Necesarios',
              data: necesarios,
              backgroundColor: 'rgba(220, 53, 69, 0.7)'
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: { y: { beginAtZero: true } }
        }
      });
    }

    function crearGraficoRiesgosOperador(distribucion) {
      const ctx = document.getElementById('op-chart-riesgos');
      if (!ctx) return;
      
      if (opChartRiesgos) opChartRiesgos.destroy();
      
      opChartRiesgos = new Chart(ctx, {
        type: 'pie',
        data: {
          labels: Object.keys(distribucion || {}),
          datasets: [{
            data: Object.values(distribucion || {}),
            backgroundColor: [
              'rgba(220, 53, 69, 0.8)',
              'rgba(255, 193, 7, 0.8)',
              'rgba(13, 110, 253, 0.8)',
              'rgba(40, 167, 69, 0.8)'
            ]
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { position: 'bottom' } }
        }
      });
    }

    async function cargarHistorialOperador() {
      try {
        const res = await fetch(apiBase + '/distribucion/historial');
        const historial = await res.json();
        
        const tbody = document.querySelector('#op-tabla-historial tbody');
        if (!tbody) return;
        
        tbody.innerHTML = '';
        
        historial.slice(0, 15).forEach(d => {
          tbody.innerHTML += `
            <tr>
              <td>${new Date(d.fechaDistribucion).toLocaleString()}</td>
              <td>${d.origen.nombre}</td>
              <td>${d.destino.nombre}</td>
              <td>${d.recurso.tipo}</td>
              <td>${d.cantidad}</td>
              <td>${d.distanciaRecorrida.toFixed(2)}</td>
              <td><span class="badge bg-success">${d.estado}</span></td>
            </tr>
          `;
        });
        
      } catch (error) {
        console.error('Error cargando historial operador:', error);
      }
    }

    window.addEventListener('load', () => {
      initInteractiveMap(); // Inicializa el mapa de la pesta√±a "Mapa"
      loadRecursos();
      loadZonas();
      loadRutas();
      cargarUsuarioActual();
      configurarLogout();

      const btnRefresh = document.getElementById('btn-refresh');
      if (btnRefresh) {
        btnRefresh.addEventListener('click', () => {
          loadRecursos();
          loadZonas();
          loadRutas();
          if (document.getElementById('panel-rutas').classList.contains('active')) {
            loadAllData(); // <-- MODIFICADO
          }
          addLog('Datos refrescados manualmente');
        });
      }

      // Bot√≥n trazar caminos
      const btnTrazar = document.getElementById('btn-trazar-caminos');
      if (btnTrazar) {
        btnTrazar.addEventListener('click', () => {
          const sel = document.getElementById('selectDestinoPaths');
          if (!sel) return;
          const id = sel.value;
          if (!id) { Swal.fire('Atenci√≥n', 'Selecciona un destino', 'warning'); return; }
          trazarCaminosHaciaDestino(id);
        });
      }
    });
  </script>
</body>
</html>